+++
title = "Go è¯­è¨€ä¹‹æ­å»ºé€šç”¨ Web é¡¹ç›®å¼€å‘è„šæ‰‹æ¶"
date = 2023-06-18T19:31:41+08:00
description = "Go è¯­è¨€ä¹‹æ­å»ºé€šç”¨ Web é¡¹ç›®å¼€å‘è„šæ‰‹æ¶"
[taxonomies]
tags = ["Go"]
categories = ["Go"]
+++

# Go è¯­è¨€ä¹‹æ­å»ºé€šç”¨ Web é¡¹ç›®å¼€å‘è„šæ‰‹æ¶

## MVC æ¨¡å¼

MVC æ¨¡å¼ä»£è¡¨ Model-View-Controllerï¼ˆæ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨ï¼‰ æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼ç”¨äºåº”ç”¨ç¨‹åºçš„åˆ†å±‚å¼€å‘ã€‚

- **Modelï¼ˆæ¨¡å‹ï¼‰** - æ¨¡å‹ä»£è¡¨ä¸€ä¸ªå­˜å–æ•°æ®çš„å¯¹è±¡æˆ– JAVA POJOã€‚å®ƒä¹Ÿå¯ä»¥å¸¦æœ‰é€»è¾‘ï¼Œåœ¨æ•°æ®å˜åŒ–æ—¶æ›´æ–°æ§åˆ¶å™¨ã€‚
- **Viewï¼ˆè§†å›¾ï¼‰** - è§†å›¾ä»£è¡¨æ¨¡å‹åŒ…å«çš„æ•°æ®çš„å¯è§†åŒ–ã€‚
- **Controllerï¼ˆæ§åˆ¶å™¨ï¼‰** - æ§åˆ¶å™¨ä½œç”¨äºæ¨¡å‹å’Œè§†å›¾ä¸Šã€‚å®ƒæ§åˆ¶æ•°æ®æµå‘æ¨¡å‹å¯¹è±¡ï¼Œå¹¶åœ¨æ•°æ®å˜åŒ–æ—¶æ›´æ–°è§†å›¾ã€‚å®ƒä½¿è§†å›¾ä¸æ¨¡å‹åˆ†ç¦»å¼€ã€‚

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306182104206.png)

## Web é¡¹ç›® CLD åˆ†å±‚

åè®®å¤„ç†å±‚ï¼šæ”¯æŒå„ç§åè®®

Controllerï¼šæœåŠ¡çš„å…¥å£ï¼Œè´Ÿè´£å¤„ç†è·¯ç”±ã€å‚æ•°æ ¡éªŒã€è¯·æ±‚è½¬å‘ã€‚

Logic/Serviceï¼šé€»è¾‘ï¼ˆæœåŠ¡ï¼‰å±‚ï¼Œè´Ÿè´£å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚

DAO/Repositoryï¼šè´Ÿè´£æ•°æ®ä¸å­˜å‚¨ç›¸å…³åŠŸèƒ½ã€‚

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306182139911.png)

## æ­å»º Web é¡¹ç›®å¼€å‘è„šæ‰‹æ¶

### åˆ›å»º web_app é¡¹ç›®

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306182141188.png)

### åˆ›å»º main æ–‡ä»¶

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306182144666.png)

### é¡¹ç›®ç›®å½•

```bash
Code/go/web_app via ğŸ¹ v1.20.3 via ğŸ…’ base took 8h 53m 28.4s 
âœ tree                                      
.
â”œâ”€â”€ config.yaml
â”œâ”€â”€ controllers
â”œâ”€â”€ dao
â”‚Â Â  â”œâ”€â”€ mysql
â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql.go
â”‚Â Â  â””â”€â”€ redis
â”‚Â Â      â””â”€â”€ redis.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ logger
â”‚Â Â  â””â”€â”€ logger.go
â”œâ”€â”€ logic
â”œâ”€â”€ main.go
â”œâ”€â”€ models
â”œâ”€â”€ pkg
â”œâ”€â”€ routes
â”‚Â Â  â””â”€â”€ routes.go
â”œâ”€â”€ settings
â”‚Â Â  â””â”€â”€ settings.go
â”œâ”€â”€ web_app
â””â”€â”€ web_app.log

11 directories, 11 files

Code/go/web_app via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ 

```

#### config.yaml

```yaml
app:
  name: "web_app"
  mode: "dev"
  port: 8080

log:
  level: "debug"
  filename: "web_app.log"
  max_size: 30
  max_age: 30
  max_backups: 7

mysql:
  host: "127.0.0.1"
  port: 3306
  user: "root"
  password: "12345678"
  dbname: "sql_test"
  max_open_conns: 200
  max_idle_conns: 50

redis:
  host: "127.0.0.1"
  port: 6379
  password: ""
  db: 0
  pool_size: 100
```

#### settings/settings.go

```go
package settings

import (
 "fmt"

 "github.com/fsnotify/fsnotify"
 "github.com/spf13/viper"
)

func Init() (err error) {
 // è®¾ç½®é»˜è®¤å€¼
 viper.SetDefault("fileDir", "./")
 // è¯»å–é…ç½®æ–‡ä»¶
 viper.SetConfigFile("./config.yaml") // æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
 viper.SetConfigName("config")        // é…ç½®æ–‡ä»¶åç§°(æ— æ‰©å±•å)
 viper.SetConfigType("yaml")          // SetConfigTypeè®¾ç½®è¿œç«¯æºè¿”å›çš„é…ç½®ç±»å‹ï¼Œä¾‹å¦‚:â€œjsonâ€ã€‚
 viper.AddConfigPath(".")             // è¿˜å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­æŸ¥æ‰¾é…ç½®

 err = viper.ReadInConfig() // æŸ¥æ‰¾å¹¶è¯»å–é…ç½®æ–‡ä»¶
 if err != nil {            // å¤„ç†è¯»å–é…ç½®æ–‡ä»¶çš„é”™è¯¯
  fmt.Printf("viper.ReadInConfig failed, error: %v\n", err)
  return
 }

 // å®æ—¶ç›‘æ§é…ç½®æ–‡ä»¶çš„å˜åŒ– WatchConfig å¼€å§‹ç›‘è§†é…ç½®æ–‡ä»¶çš„æ›´æ”¹ã€‚
 viper.WatchConfig()
 // OnConfigChangeè®¾ç½®é…ç½®æ–‡ä»¶æ›´æ”¹æ—¶è°ƒç”¨çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚
 // å½“é…ç½®æ–‡ä»¶å˜åŒ–ä¹‹åè°ƒç”¨çš„ä¸€ä¸ªå›è°ƒå‡½æ•°
 viper.OnConfigChange(func(e fsnotify.Event) {
  fmt.Println("Config file changed:", e.Name)
 })

 return
}

```

#### logger/logger.go

```go
package settings

import (
 "fmt"

 "github.com/fsnotify/fsnotify"
 "github.com/spf13/viper"
)

func Init() (err error) {
 // è®¾ç½®é»˜è®¤å€¼
 viper.SetDefault("fileDir", "./")
 // è¯»å–é…ç½®æ–‡ä»¶
 viper.SetConfigFile("./config.yaml") // æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
 viper.SetConfigName("config")        // é…ç½®æ–‡ä»¶åç§°(æ— æ‰©å±•å)
 viper.SetConfigType("yaml")          // å¦‚æœé…ç½®æ–‡ä»¶çš„åç§°ä¸­æ²¡æœ‰æ‰©å±•åï¼Œåˆ™éœ€è¦é…ç½®æ­¤é¡¹
 viper.AddConfigPath(".")             // è¿˜å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­æŸ¥æ‰¾é…ç½®

 err = viper.ReadInConfig() // æŸ¥æ‰¾å¹¶è¯»å–é…ç½®æ–‡ä»¶
 if err != nil {            // å¤„ç†è¯»å–é…ç½®æ–‡ä»¶çš„é”™è¯¯
  fmt.Printf("viper.ReadInConfig failed, error: %v\n", err)
  return
 }

 // å®æ—¶ç›‘æ§é…ç½®æ–‡ä»¶çš„å˜åŒ– WatchConfig å¼€å§‹ç›‘è§†é…ç½®æ–‡ä»¶çš„æ›´æ”¹ã€‚
 viper.WatchConfig()
 // OnConfigChangeè®¾ç½®é…ç½®æ–‡ä»¶æ›´æ”¹æ—¶è°ƒç”¨çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚
 // å½“é…ç½®æ–‡ä»¶å˜åŒ–ä¹‹åè°ƒç”¨çš„ä¸€ä¸ªå›è°ƒå‡½æ•°
 viper.OnConfigChange(func(e fsnotify.Event) {
  fmt.Println("Config file changed:", e.Name)
 })

 return
}

```

#### dao/mysql/mysql.go

```go
package mysql

import (
 "fmt"

 "go.uber.org/zap"

 "github.com/jmoiron/sqlx"
 "github.com/spf13/viper"

 _ "github.com/go-sql-driver/mysql" // åŒ¿åå¯¼å…¥ è‡ªåŠ¨æ‰§è¡Œ init()
)

var db *sqlx.DB

func Init() (err error) {
 //DSN (Data Source Name) Sprintfæ ¹æ®æ ¼å¼è¯´æ˜ç¬¦è¿›è¡Œæ ¼å¼åŒ–ï¼Œå¹¶è¿”å›ç»“æœå­—ç¬¦ä¸²ã€‚
 dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=true",
  viper.GetString("mysql.user"),
  viper.GetString("mysql.password"),
  viper.GetString("mysql.host"),
  viper.GetInt("mysql.port"),
  viper.GetString("mysql.dbname"),
 )
 // è¿æ¥åˆ°æ•°æ®åº“å¹¶ä½¿ç”¨pingè¿›è¡ŒéªŒè¯ã€‚
 // ä¹Ÿå¯ä»¥ä½¿ç”¨ MustConnect MustConnectè¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶åœ¨å‡ºç°é”™è¯¯æ—¶ææ…Œ panicã€‚
 db, err = sqlx.Connect("mysql", dsn)
 if err != nil {
  zap.L().Error("connect DB failed", zap.Error(err))
  return
 }
 db.SetMaxOpenConns(viper.GetInt("mysql.max_open_conns")) // è®¾ç½®æ•°æ®åº“çš„æœ€å¤§æ‰“å¼€è¿æ¥æ•°ã€‚
 db.SetMaxIdleConns(viper.GetInt("mysql.max_idle_conns")) // è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­çš„æœ€å¤§è¿æ¥æ•°ã€‚
 return
}

func Close() {
 _ = db.Close()
}

```

#### dao/redis/redis.go

```go
package redis

import (
 "context"
 "fmt"

 "github.com/redis/go-redis/v9"
 "github.com/spf13/viper"
)

// å£°æ˜ä¸€ä¸ªå…¨å±€çš„ rdb å˜é‡
var rdb *redis.Client

// åˆå§‹åŒ–è¿æ¥
func Init() (err error) {
 // NewClientå°†å®¢æˆ·ç«¯è¿”å›ç»™OptionsæŒ‡å®šçš„Redis Serverã€‚
 // Optionsä¿ç•™è®¾ç½®ä»¥å»ºç«‹redisè¿æ¥ã€‚
 rdb = redis.NewClient(&redis.Options{
  Addr:     fmt.Sprintf("%s:%d", viper.GetString("redis.host"), viper.GetInt("redis.port")),
  Password: viper.GetString("redis.password"), // æ²¡æœ‰å¯†ç ï¼Œé»˜è®¤å€¼
  DB:       viper.GetInt("redis.db"),          // é»˜è®¤DB 0 è¿æ¥åˆ°æœåŠ¡å™¨åè¦é€‰æ‹©çš„æ•°æ®åº“ã€‚
  PoolSize: viper.GetInt("redis.pool_size"),   // æœ€å¤§å¥—æ¥å­—è¿æ¥æ•°ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¯ç”¨CPUæœ‰10ä¸ªè¿æ¥ï¼Œç”±runtime.GOMAXPROCSæŠ¥å‘Šã€‚
 })

 // Backgroundè¿”å›ä¸€ä¸ªéç©ºçš„Contextã€‚å®ƒæ°¸è¿œä¸ä¼šè¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰æˆªæ­¢æ—¥æœŸã€‚
 // å®ƒé€šå¸¸ç”±mainå‡½æ•°ã€åˆå§‹åŒ–å’Œæµ‹è¯•ä½¿ç”¨ï¼Œå¹¶ä½œä¸ºä¼ å…¥è¯·æ±‚çš„é¡¶çº§ä¸Šä¸‹æ–‡
 ctx := context.Background()

 _, err = rdb.Ping(ctx).Result()
 return
}

func Close() {
 _ = rdb.Close()
}

```

#### routes/routes.go

```go
package routes

import (
 "net/http"
 "web_app/logger"

 "github.com/gin-gonic/gin"
)

func Setup() *gin.Engine {
 r := gin.New()
 r.Use(logger.GinLogger(), logger.GinRecovery(true))

 r.GET("/", func(context *gin.Context) {
  context.String(http.StatusOK, "OK")
 })
 return r
}

```

#### main.go

```go
package main

import (
 "context"
 "fmt"
 "log"
 "net/http"
 "os"
 "os/signal"
 "syscall"
 "time"
 "web_app/dao/mysql"
 "web_app/dao/redis"
 "web_app/logger"
 "web_app/routes"
 "web_app/settings"

 "github.com/spf13/viper"

 "go.uber.org/zap"
)

// Go Web å¼€å‘é€šç”¨çš„è„šæ‰‹æ¶æ¨¡ç‰ˆ

func main() {
 // 1. åŠ è½½é…ç½®
 if err := settings.Init(); err != nil {
  fmt.Printf("init settings failed, error: %v\n", err)
  return
 }
 // 2. åˆå§‹åŒ–æ—¥å¿—
 if err := logger.Init(); err != nil {
  fmt.Printf("init logger failed, error: %v\n", err)
  return
 }
 defer zap.L().Sync()
 zap.L().Debug("logger initialized successfully")
 // 3. åˆå§‹åŒ– MySQL è¿æ¥
 if err := mysql.Init(); err != nil {
  fmt.Printf("init mysql failed, error: %v\n", err)
  return
 }
 defer mysql.Close()
 // 4. åˆå§‹åŒ– Redis è¿æ¥
 if err := redis.Init(); err != nil {
  fmt.Printf("init redis failed, error: %v\n", err)
  return
 }
 defer redis.Close()
 // 5. æ³¨å†Œè·¯ç”±
 router := routes.Setup()
 // 6. å¯åŠ¨æœåŠ¡ï¼ˆä¼˜é›…å…³æœºï¼‰
 // æœåŠ¡å™¨å®šä¹‰è¿è¡ŒHTTPæœåŠ¡å™¨çš„å‚æ•°ã€‚Serverçš„é›¶å€¼æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é…ç½®ã€‚
 srv := &http.Server{
  // Addrå¯é€‰åœ°ä»¥â€œhost:portâ€çš„å½¢å¼æŒ‡å®šæœåŠ¡å™¨è¦ç›‘å¬çš„TCPåœ°å€ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨â€œ:httpâ€(ç«¯å£80)ã€‚
  // æœåŠ¡åç§°åœ¨RFC 6335ä¸­å®šä¹‰ï¼Œå¹¶ç”±IANAåˆ†é…
  Addr:    fmt.Sprintf(":%d", viper.GetInt("app.port")),
  Handler: router,
 }

 go func() {
  // å¼€å¯ä¸€ä¸ªgoroutineå¯åŠ¨æœåŠ¡ï¼Œå¦‚æœä¸ç”¨ goroutineï¼Œä¸‹é¢çš„ä»£ç  ListenAndServe ä¼šä¸€ç›´æ¥æ”¶è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚ï¼Œè¿›å…¥æ— é™å¾ªç¯ã€‚ä»£ç å°±ä¸ä¼šå¾€ä¸‹æ‰§è¡Œã€‚

  // ListenAndServeç›‘å¬TCPç½‘ç»œåœ°å€srv.Addrï¼Œç„¶åè°ƒç”¨Serveæ¥å¤„ç†ä¼ å…¥è¿æ¥ä¸Šçš„è¯·æ±‚ã€‚æ¥å—çš„è¿æ¥é…ç½®ä¸ºä½¿TCPèƒ½ä¿æŒè¿æ¥ã€‚
  // ListenAndServe always returns a non-nil error. After Shutdown or Close,
  // the returned error is ErrServerClosed.
  if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
   log.Fatalf("listen: %s\n", err) // Fatalf ç›¸å½“äºPrintf()ä¹‹åå†è°ƒç”¨os.Exit(1)ã€‚
  }
 }()

 // ç­‰å¾…ä¸­æ–­ä¿¡å·æ¥ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ï¼Œä¸ºå…³é—­æœåŠ¡å™¨æ“ä½œè®¾ç½®ä¸€ä¸ª5ç§’çš„è¶…æ—¶

 // makeå†…ç½®å‡½æ•°åˆ†é…å¹¶åˆå§‹åŒ–(ä»…)sliceã€mapæˆ–chanç±»å‹çš„å¯¹è±¡ã€‚
 // ä¸newä¸€æ ·ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å‹ï¼Œè€Œä¸æ˜¯å€¼ã€‚
 // ä¸newä¸åŒï¼Œmakeçš„è¿”å›ç±»å‹ä¸å…¶å‚æ•°çš„ç±»å‹ç›¸åŒï¼Œè€Œä¸æ˜¯æŒ‡å‘å®ƒçš„æŒ‡é’ˆ
 // Channel:é€šé“çš„ç¼“å†²åŒºç”¨æŒ‡å®šçš„ç¼“å†²åŒºå®¹é‡åˆå§‹åŒ–ã€‚å¦‚æœä¸ºé›¶ï¼Œæˆ–è€…å¿½ç•¥å¤§å°ï¼Œåˆ™é€šé“æœªè¢«ç¼“å†²ã€‚

 // ä¿¡å· Signal è¡¨ç¤ºæ“ä½œç³»ç»Ÿä¿¡å·ã€‚é€šå¸¸çš„åº•å±‚å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿ:åœ¨Unixä¸Šæ˜¯syscall.Signalã€‚
 quit := make(chan os.Signal, 1) // åˆ›å»ºä¸€ä¸ªæ¥æ”¶ä¿¡å·çš„é€šé“
 // kill é»˜è®¤ä¼šå‘é€ syscall.SIGTERM ä¿¡å·
 // kill -2 å‘é€ syscall.SIGINT ä¿¡å·ï¼ŒCtrl+C å°±æ˜¯è§¦å‘ç³»ç»ŸSIGINTä¿¡å·
 // kill -9 å‘é€ syscall.SIGKILL ä¿¡å·ï¼Œä½†æ˜¯ä¸èƒ½è¢«æ•è·ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ å®ƒ
 // signal.NotifyæŠŠæ”¶åˆ°çš„ syscall.SIGINTæˆ–syscall.SIGTERM ä¿¡å·è½¬å‘ç»™quit

 // Notifyä½¿åŒ…ä¿¡å·å°†ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦‚æœæ²¡æœ‰æä¾›ä¿¡å·ï¼Œåˆ™å°†æ‰€æœ‰ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦åˆ™ä»…å°†æä¾›çš„ä¿¡å·è½¬å‘ç»™cã€‚
 // åŒ…ä¿¡å·ä¸ä¼šé˜»å¡å‘é€åˆ°c:è°ƒç”¨è€…å¿…é¡»ç¡®ä¿cæœ‰è¶³å¤Ÿçš„ç¼“å†²ç©ºé—´æ¥è·Ÿä¸Šé¢„æœŸçš„ä¿¡å·é€Ÿç‡ã€‚å¯¹äºä»…ç”¨äºé€šçŸ¥ä¸€ä¸ªä¿¡å·å€¼çš„é€šé“ï¼Œå¤§å°ä¸º1çš„ç¼“å†²åŒºå°±è¶³å¤Ÿäº†ã€‚
 // å…è®¸ä½¿ç”¨åŒä¸€é€šé“å¤šæ¬¡è°ƒç”¨Notify:æ¯æ¬¡è°ƒç”¨éƒ½æ‰©å±•å‘é€åˆ°è¯¥é€šé“çš„ä¿¡å·é›†ã€‚ä»é›†åˆä¸­ç§»é™¤ä¿¡å·çš„å”¯ä¸€æ–¹æ³•æ˜¯è°ƒç”¨Stopã€‚
 // å…è®¸ä½¿ç”¨ä¸åŒçš„é€šé“å’Œç›¸åŒçš„ä¿¡å·å¤šæ¬¡è°ƒç”¨Notify:æ¯ä¸ªé€šé“ç‹¬ç«‹åœ°æ¥æ”¶ä¼ å…¥ä¿¡å·çš„å‰¯æœ¬ã€‚
 signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM) // æ­¤å¤„ä¸ä¼šé˜»å¡
 <-quit                                               // é˜»å¡åœ¨æ­¤ï¼Œå½“æ¥æ”¶åˆ°ä¸Šè¿°ä¸¤ç§ä¿¡å·æ—¶æ‰ä¼šå¾€ä¸‹æ‰§è¡Œ
 zap.L().Info("Shutdown Server ...")
 // åˆ›å»ºä¸€ä¸ª5ç§’è¶…æ—¶çš„context
 ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
 defer cancel()
 // 5ç§’å†…ä¼˜é›…å…³é—­æœåŠ¡ï¼ˆå°†æœªå¤„ç†å®Œçš„è¯·æ±‚å¤„ç†å®Œå†å…³é—­æœåŠ¡ï¼‰ï¼Œè¶…è¿‡5ç§’å°±è¶…æ—¶é€€å‡º

 // å…³æœºå°†åœ¨ä¸ä¸­æ–­ä»»ä½•æ´»åŠ¨è¿æ¥çš„æƒ…å†µä¸‹ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ã€‚
 // Shutdownçš„å·¥ä½œåŸç†æ˜¯é¦–å…ˆå…³é—­æ‰€æœ‰æ‰“å¼€çš„ä¾¦å¬å™¨ï¼Œç„¶åå…³é—­æ‰€æœ‰ç©ºé—²è¿æ¥ï¼Œç„¶åæ— é™æœŸåœ°ç­‰å¾…è¿æ¥è¿”å›ç©ºé—²çŠ¶æ€ï¼Œç„¶åå…³é—­ã€‚
 // å¦‚æœæä¾›çš„ä¸Šä¸‹æ–‡åœ¨å…³é—­å®Œæˆä¹‹å‰è¿‡æœŸï¼Œåˆ™shutdownè¿”å›ä¸Šä¸‹æ–‡çš„é”™è¯¯ï¼Œå¦åˆ™è¿”å›å…³é—­æœåŠ¡å™¨çš„åº•å±‚ä¾¦å¬å™¨æ‰€è¿”å›çš„ä»»ä½•é”™è¯¯ã€‚
 // å½“Shutdownè¢«è°ƒç”¨æ—¶ï¼ŒServe, ListenAndServeå’ŒListenAndServeTLSä¼šç«‹å³è¿”å›ErrServerClosedã€‚ç¡®ä¿ç¨‹åºæ²¡æœ‰é€€å‡ºï¼Œè€Œæ˜¯ç­‰å¾…Shutdownè¿”å›ã€‚
 // å…³é—­ä¸è¯•å›¾å…³é—­æˆ–ç­‰å¾…è¢«åŠ«æŒçš„è¿æ¥ï¼Œå¦‚WebSocketsã€‚å¦‚æœéœ€è¦çš„è¯ï¼ŒShutdownçš„è°ƒç”¨è€…åº”è¯¥å•ç‹¬é€šçŸ¥è¿™äº›é•¿å¯¿å‘½è¿æ¥å…³é—­ï¼Œå¹¶ç­‰å¾…å®ƒä»¬å…³é—­ã€‚
 // ä¸€æ—¦åœ¨æœåŠ¡å™¨ä¸Šè°ƒç”¨Shutdownï¼Œå®ƒå¯èƒ½ä¸ä¼šè¢«é‡ç”¨;ä»¥åå¯¹Serveç­‰æ–¹æ³•çš„è°ƒç”¨å°†è¿”å›ErrServerClosedã€‚
 if err := srv.Shutdown(ctx); err != nil {
  zap.L().Fatal("Server Shutdown", zap.Error(err))
 }

 zap.L().Info("Server exiting")
}

```

### è¿è¡Œå¹¶è®¿é—®ï¼š<http://127.0.0.1:8080>

```bash
Code/go/web_app via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go build 

Code/go/web_app via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ ./web_app
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /                         --> web_app/routes.Setup.func1 (3 handlers)


```

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306190043937.png)

## ä½¿ç”¨ç»“æ„ä½“å˜é‡ä¿å­˜é…ç½®ä¿¡æ¯

### é¡¹ç›® web_app2 ç›®å½•

```bash
ode/go/web_app2 via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ tree
.
â”œâ”€â”€ config.yaml
â”œâ”€â”€ controllers
â”œâ”€â”€ dao
â”‚Â Â  â”œâ”€â”€ mysql
â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql.go
â”‚Â Â  â””â”€â”€ redis
â”‚Â Â      â””â”€â”€ redis.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ logger
â”‚Â Â  â””â”€â”€ logger.go
â”œâ”€â”€ logic
â”œâ”€â”€ main.go
â”œâ”€â”€ models
â”œâ”€â”€ pkg
â”œâ”€â”€ routes
â”‚Â Â  â””â”€â”€ routes.go
â”œâ”€â”€ settings
â”‚Â Â  â””â”€â”€ settings.go
â”œâ”€â”€ web_app.log
â””â”€â”€ web_app2

11 directories, 11 files

Code/go/web_app2 via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ
```

config.yaml

```yaml
name: "web_app"
mode: "dev"
port: 8080
version: "v0.0.2"

log:
  level: "debug"
  filename: "web_app.log"
  max_size: 30
  max_age: 30
  max_backups: 7

mysql:
  host: "127.0.0.1"
  port: 3306
  user: "root"
  password: "12345678"
  dbname: "sql_test"
  max_open_conns: 200
  max_idle_conns: 50

redis:
  host: "127.0.0.1"
  port: 6379
  password: ""
  db: 0
  pool_size: 100
```

settings/settings.go

```go
package settings

import (
 "fmt"

 "github.com/fsnotify/fsnotify"
 "github.com/spf13/viper"
)

// Conf å…¨å±€å˜é‡ï¼Œç”¨æ¥ä¿å­˜ç¨‹åºçš„æ‰€æœ‰é…ç½®ä¿¡æ¯
var Conf = new(AppConfig)

type AppConfig struct {
 Name    string `mapstructure:"name"`
 Mode    string `mapstructure:"mode"`
 Version string `mapstructure:"version"`
 Port    int    `mapstructure:"port"`

 *LogConfig   `mapstructure:"log"`
 *MySQLConfig `mapstructure:"mysql"`
 *RedisConfig `mapstructure:"redis"`
}

type LogConfig struct {
 Level      string `mapstructure:"level"`
 Filename   string `mapstructure:"filename"`
 MaxSize    int    `mapstructure:"max_size"`
 MaxAge     int    `mapstructure:"max_age"`
 MaxBackups int    `mapstructure:"max_backups"`
}

type MySQLConfig struct {
 Host         string `mapstructure:"host"`
 User         string `mapstructure:"user"`
 Password     string `mapstructure:"password"`
 DbName       string `mapstructure:"db_name"`
 Port         int    `mapstructure:"port"`
 MaxOpenConns int    `mapstructure:"max_open_conns"`
 MaxIdleConns int    `mapstructure:"max_idle_conns"`
}

type RedisConfig struct {
 Host     string `mapstructure:"host"`
 Password string `mapstructure:"password"`
 Port     int    `matstructure:"port"`
 DB       int    `mapstructure:"db"`
 PoolSize int    `mapstructure:"pool_size"`
}

func Init() (err error) {
 // æ–¹å¼1ï¼šç›´æ¥æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„æˆ–è€…ç»å¯¹è·¯å¾„ï¼‰
 // ç›¸å¯¹è·¯å¾„ï¼šç›¸å¯¹æ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
 // viper.SetConfigFile("./conf/config.yaml")
 // ç»å¯¹è·¯å¾„ï¼šç³»ç»Ÿä¸­å®é™…çš„æ–‡ä»¶è·¯å¾„
 // viper.SetConfigFile("/Users/qiaopengjun/Desktop/web_app2 /conf/config.yaml")

 // æ–¹å¼2ï¼šæŒ‡å®šé…ç½®æ–‡ä»¶åå’Œé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œviper è‡ªè¡ŒæŸ¥æ‰¾å¯ç”¨çš„é…ç½®æ–‡ä»¶
 // é…ç½®æ–‡ä»¶åä¸éœ€è¦å¸¦åç¼€
 // é…ç½®æ–‡ä»¶ä½ç½®å¯é…ç½®å¤šä¸ª
 // æ³¨æ„ï¼šviper æ˜¯æ ¹æ®æ–‡ä»¶åæŸ¥æ‰¾ï¼Œé…ç½®ç›®å½•é‡Œä¸è¦æœ‰åŒåçš„é…ç½®æ–‡ä»¶ã€‚
 // ä¾‹å¦‚ï¼šåœ¨é…ç½®ç›®å½• ./conf ä¸­ä¸è¦åŒæ—¶å­˜åœ¨ config.yamlã€config.json

 // è¯»å–é…ç½®æ–‡ä»¶
 viper.SetConfigFile("./config.yaml") // æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
 viper.SetConfigName("config")        // é…ç½®æ–‡ä»¶åç§°(æ— æ‰©å±•å)
 viper.AddConfigPath(".")             // æŒ‡å®šæŸ¥æ‰¾é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼ˆè¿™é‡Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰å¯ä»¥é…ç½®å¤šä¸ª
 viper.AddConfigPath("./conf")        // æŒ‡å®šæŸ¥æ‰¾é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼ˆè¿™é‡Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰å¯ä»¥é…ç½®å¤šä¸ª
 // SetConfigTypeè®¾ç½®è¿œç«¯æºè¿”å›çš„é…ç½®ç±»å‹ï¼Œä¾‹å¦‚:â€œjsonâ€ã€‚
 // åŸºæœ¬ä¸Šæ˜¯é…åˆè¿œç¨‹é…ç½®ä¸­å¿ƒä½¿ç”¨çš„ï¼Œå‘Šè¯‰viper å½“å‰çš„æ•°æ®ä½¿ç”¨ä»€ä¹ˆæ ¼å¼å»è§£æ
 viper.SetConfigType("yaml")

 err = viper.ReadInConfig() // æŸ¥æ‰¾å¹¶è¯»å–é…ç½®æ–‡ä»¶
 if err != nil {            // å¤„ç†è¯»å–é…ç½®æ–‡ä»¶çš„é”™è¯¯
  fmt.Printf("viper.ReadInConfig failed, error: %v\n", err)
  return
 }

 // æŠŠè¯»å–åˆ°çš„é…ç½®ä¿¡æ¯ååºåˆ—åŒ–åˆ° Conf å˜é‡ä¸­
 if err = viper.Unmarshal(Conf); err != nil {
  fmt.Printf("viper unmarshal failed, error: %v\n", err)
  return
 }

 // å®æ—¶ç›‘æ§é…ç½®æ–‡ä»¶çš„å˜åŒ– WatchConfig å¼€å§‹ç›‘è§†é…ç½®æ–‡ä»¶çš„æ›´æ”¹ã€‚
 viper.WatchConfig()
 // OnConfigChangeè®¾ç½®é…ç½®æ–‡ä»¶æ›´æ”¹æ—¶è°ƒç”¨çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚
 // å½“é…ç½®æ–‡ä»¶å˜åŒ–ä¹‹åè°ƒç”¨çš„ä¸€ä¸ªå›è°ƒå‡½æ•°
 viper.OnConfigChange(func(e fsnotify.Event) {
  fmt.Println("Config file changed:", e.Name)
  if err = viper.Unmarshal(Conf); err != nil {
   fmt.Printf("viper unmarshal OnConfigChange failed, error: %v\n", err)
  }
 })

 return
}

```

logger/logger.go

```go
package logger

import (
 "gopkg.in/natefinch/lumberjack.v2"
 "net"
 "net/http"
 "net/http/httputil"
 "os"
 "runtime/debug"
 "strings"
 "time"
 "web_app2/settings"

 "github.com/gin-gonic/gin"
 "go.uber.org/zap"
 "go.uber.org/zap/zapcore"
)

func Init(cfg *settings.LogConfig) (err error) {
 writeSyncer := getLogWriter(
  cfg.Filename,
  cfg.MaxSize,
  cfg.MaxBackups,
  cfg.MaxAge,
 )
 encoder := getEncoder()
 var l = new(zapcore.Level)
 err = l.UnmarshalText([]byte(cfg.Level))
 if err != nil {
  return
 }
 // NewCoreåˆ›å»ºä¸€ä¸ªå‘WriteSyncerå†™å…¥æ—¥å¿—çš„Coreã€‚

 // A WriteSyncer is an io.Writer that can also flush any buffered data. Note
 // that *os.File (and thus, os.Stderr and os.Stdout) implement WriteSyncer.

 // LevelEnablerå†³å®šåœ¨è®°å½•æ¶ˆæ¯æ—¶æ˜¯å¦å¯ç”¨ç»™å®šçš„æ—¥å¿—çº§åˆ«ã€‚
 // Each concrete Level value implements a static LevelEnabler which returns
 // true for itself and all higher logging levels. For example WarnLevel.Enabled()
 // will return true for WarnLevel, ErrorLevel, DPanicLevel, PanicLevel, and
 // FatalLevel, but return false for InfoLevel and DebugLevel.
 core := zapcore.NewCore(encoder, writeSyncer, l)

 // New constructs a new Logger from the provided zapcore.Core and Options. If
 // the passed zapcore.Core is nil, it falls back to using a no-op
 // implementation.

 // AddCaller configures the Logger to annotate each message with the filename,
 // line number, and function name of zap's caller. See also WithCaller.
 logger := zap.New(core, zap.AddCaller())
 // æ›¿æ¢ zap åº“ä¸­å…¨å±€çš„logger
 zap.ReplaceGlobals(logger)
 return
 // Sugarå°è£…äº†Loggerï¼Œä»¥æä¾›æ›´ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„APIï¼Œä½†é€Ÿåº¦ç•¥æ…¢ã€‚ç³–åŒ–ä¸€ä¸ªLoggerçš„æˆæœ¬éå¸¸ä½ï¼Œ
 // å› æ­¤ä¸€ä¸ªåº”ç”¨ç¨‹åºåŒæ—¶ä½¿ç”¨Loggerså’ŒSugaredLoggersæ˜¯åˆç†çš„ï¼Œåœ¨æ€§èƒ½æ•æ„Ÿä»£ç çš„è¾¹ç•Œä¸Šåœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚
 //sugarLogger = logger.Sugar()
}

func getEncoder() zapcore.Encoder {
 // NewJSONEncoderåˆ›å»ºäº†ä¸€ä¸ªå¿«é€Ÿã€ä½åˆ†é…çš„JSONç¼–ç å™¨ã€‚ç¼–ç å™¨é€‚å½“åœ°è½¬ä¹‰æ‰€æœ‰å­—æ®µé”®å’Œå€¼ã€‚
 // NewProductionEncoderConfig returns an opinionated EncoderConfig for
 // production environments.
 encoderConfig := zap.NewProductionEncoderConfig()
 encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder
 encoderConfig.TimeKey = "time"
 encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder
 encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder
 encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder
 return zapcore.NewJSONEncoder(encoderConfig)
}

func getLogWriter(filename string, maxSize, maxBackup, maxAge int) zapcore.WriteSyncer {
 // Logger is an io.WriteCloser that writes to the specified filename.
 // æ—¥å¿—è®°å½•å™¨åœ¨ç¬¬ä¸€æ¬¡å†™å…¥æ—¶æ‰“å¼€æˆ–åˆ›å»ºæ—¥å¿—æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶å­˜åœ¨å¹¶ä¸”å°äºMaxSizeå…†å­—èŠ‚ï¼Œåˆ™lumberjackå°†æ‰“å¼€å¹¶è¿½åŠ è¯¥æ–‡ä»¶ã€‚
 // å¦‚æœè¯¥æ–‡ä»¶å­˜åœ¨å¹¶ä¸”å…¶å¤§å°ä¸º>= MaxSizeå…†å­—èŠ‚ï¼Œ
 // åˆ™é€šè¿‡å°†å½“å‰æ—¶é—´æ”¾åœ¨æ–‡ä»¶æ‰©å±•å(æˆ–è€…å¦‚æœæ²¡æœ‰æ‰©å±•ååˆ™æ”¾åœ¨æ–‡ä»¶åçš„æœ«å°¾)çš„åç§°ä¸­çš„æ—¶é—´æˆ³ä¸­æ¥é‡å‘½åè¯¥æ–‡ä»¶ã€‚
 // ç„¶åä½¿ç”¨åŸå§‹æ–‡ä»¶ååˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚
 // æ¯å½“å†™æ“ä½œå¯¼è‡´å½“å‰æ—¥å¿—æ–‡ä»¶è¶…è¿‡MaxSizeå…†å­—èŠ‚æ—¶ï¼Œå°†å…³é—­å½“å‰æ–‡ä»¶ï¼Œé‡æ–°å‘½åï¼Œå¹¶ä½¿ç”¨åŸå§‹åç§°åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚
 // å› æ­¤ï¼Œæ‚¨ç»™Loggerçš„æ–‡ä»¶åå§‹ç»ˆæ˜¯â€œå½“å‰â€æ—¥å¿—æ–‡ä»¶ã€‚
 // å¦‚æœMaxBackupså’ŒMaxAgeå‡ä¸º0ï¼Œåˆ™ä¸ä¼šåˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶ã€‚
 lumberJackLogger := &lumberjack.Logger{
  // Filenameæ˜¯è¦å†™å…¥æ—¥å¿—çš„æ–‡ä»¶ã€‚å¤‡ä»½æ—¥å¿—æ–‡ä»¶å°†ä¿ç•™åœ¨åŒä¸€ç›®å½•ä¸‹
  Filename: filename,
  // MaxSizeæ˜¯æ—¥å¿—æ–‡ä»¶æ—‹è½¬ä¹‹å‰çš„æœ€å¤§å¤§å°(ä»¥å…†å­—èŠ‚ä¸ºå•ä½)ã€‚é»˜è®¤ä¸º100å…†å­—èŠ‚ã€‚
  MaxSize: maxSize, // M
  // MaxBackupsæ˜¯è¦ä¿ç•™çš„æ—§æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§æ•°é‡ã€‚é»˜è®¤æ˜¯ä¿ç•™æ‰€æœ‰æ—§çš„æ—¥å¿—æ–‡ä»¶(å°½ç®¡MaxAgeä»ç„¶å¯èƒ½å¯¼è‡´å®ƒä»¬è¢«åˆ é™¤)ã€‚
  MaxBackups: maxBackup, // å¤‡ä»½æ•°é‡
  // MaxAgeæ˜¯æ ¹æ®æ–‡ä»¶åä¸­ç¼–ç çš„æ—¶é—´æˆ³ä¿ç•™æ—§æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤©æ•°ã€‚
  // è¯·æ³¨æ„ï¼Œä¸€å¤©è¢«å®šä¹‰ä¸º24å°æ—¶ï¼Œç”±äºå¤ä»¤æ—¶ã€é—°ç§’ç­‰åŸå› ï¼Œå¯èƒ½ä¸æ—¥å†æ—¥ä¸å®Œå…¨å¯¹åº”ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸æ ¹æ®æ—¶é—´åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶ã€‚
  MaxAge: maxAge, // å¤‡ä»½å¤©æ•°
  // Compresså†³å®šæ˜¯å¦åº”è¯¥ä½¿ç”¨gzipå‹ç¼©æ—‹è½¬çš„æ—¥å¿—æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ä¸æ‰§è¡Œå‹ç¼©ã€‚
  Compress: false, // æ˜¯å¦å‹ç¼©
 }

 return zapcore.AddSync(lumberJackLogger)
}

// GinLogger
func GinLogger() gin.HandlerFunc {
 return func(c *gin.Context) {
  start := time.Now()
  path := c.Request.URL.Path
  query := c.Request.URL.RawQuery
  c.Next() // æ‰§è¡Œåç»­ä¸­é—´ä»¶

  // Since returns the time elapsed since t.
  // It is shorthand for time.Now().Sub(t).
  cost := time.Since(start)
  zap.L().Info(path,
   zap.Int("status", c.Writer.Status()),
   zap.String("method", c.Request.Method),
   zap.String("path", path),
   zap.String("query", query),
   zap.String("ip", c.ClientIP()),
   zap.String("user-agent", c.Request.UserAgent()),
   zap.String("errors", c.Errors.ByType(gin.ErrorTypePrivate).String()),
   zap.Duration("cost", cost), // è¿è¡Œæ—¶é—´
  )
 }
}

// GinRecovery
func GinRecovery(stack bool) gin.HandlerFunc {
 return func(c *gin.Context) {
  defer func() {
   if err := recover(); err != nil {
    // Check for a broken connection, as it is not really a
    // condition that warrants a panic stack trace.
    var brokenPipe bool
    if ne, ok := err.(*net.OpError); ok {
     if se, ok := ne.Err.(*os.SyscallError); ok {
      if strings.Contains(strings.ToLower(se.Error()), "broken pipe") || strings.Contains(strings.ToLower(se.Error()), "connection reset by peer") {
       brokenPipe = true
      }
     }
    }

    httpRequest, _ := httputil.DumpRequest(c.Request, false)
    if brokenPipe {
     zap.L().Error(c.Request.URL.Path,
      zap.Any("error", err),
      zap.String("request", string(httpRequest)),
     )
     // If the connection is dead, we can't write a status to it.
     c.Error(err.(error)) // nolint: errcheck
     c.Abort()
     return
    }

    if stack {
     zap.L().Error("[Recovery from panic]",
      zap.Any("error", err),
      zap.String("request", string(httpRequest)),
      zap.String("stack", string(debug.Stack())),
     )
    } else {
     zap.L().Error("[Recovery from panic]",
      zap.Any("error", err),
      zap.String("request", string(httpRequest)),
     )
    }
    c.AbortWithStatus(http.StatusInternalServerError)
   }
  }()
  c.Next()
 }
}

```

dao/mysql/mysql.go

```go
package mysql

import (
 "fmt"
 "web_app2/settings"

 "go.uber.org/zap"

 _ "github.com/go-sql-driver/mysql" // åŒ¿åå¯¼å…¥ è‡ªåŠ¨æ‰§è¡Œ init()
 "github.com/jmoiron/sqlx"
)

var db *sqlx.DB

func Init(cfg *settings.MySQLConfig) (err error) {
 //DSN (Data Source Name) Sprintfæ ¹æ®æ ¼å¼è¯´æ˜ç¬¦è¿›è¡Œæ ¼å¼åŒ–ï¼Œå¹¶è¿”å›ç»“æœå­—ç¬¦ä¸²ã€‚
 dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=true",
  cfg.User,
  cfg.Password,
  cfg.Host,
  cfg.Port,
  cfg.DbName,
 )
 // è¿æ¥åˆ°æ•°æ®åº“å¹¶ä½¿ç”¨pingè¿›è¡ŒéªŒè¯ã€‚
 // ä¹Ÿå¯ä»¥ä½¿ç”¨ MustConnect MustConnectè¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶åœ¨å‡ºç°é”™è¯¯æ—¶ææ…Œ panicã€‚
 db, err = sqlx.Connect("mysql", dsn)
 if err != nil {
  zap.L().Error("connect DB failed", zap.Error(err))
  return
 }
 db.SetMaxOpenConns(cfg.MaxOpenConns) // è®¾ç½®æ•°æ®åº“çš„æœ€å¤§æ‰“å¼€è¿æ¥æ•°ã€‚
 db.SetMaxIdleConns(cfg.MaxIdleConns) // è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­çš„æœ€å¤§è¿æ¥æ•°ã€‚
 return
}

func Close() {
 _ = db.Close()
}

```

dao/redis/redis.go

```go
package redis

import (
 "context"
 "fmt"
 "github.com/redis/go-redis/v9"
 "web_app2/settings"
)

// å£°æ˜ä¸€ä¸ªå…¨å±€çš„ rdb å˜é‡
var rdb *redis.Client

// åˆå§‹åŒ–è¿æ¥
func Init(cfg *settings.RedisConfig) (err error) {
 // NewClientå°†å®¢æˆ·ç«¯è¿”å›ç»™OptionsæŒ‡å®šçš„Redis Serverã€‚
 // Optionsä¿ç•™è®¾ç½®ä»¥å»ºç«‹redisè¿æ¥ã€‚
 rdb = redis.NewClient(&redis.Options{
  Addr:     fmt.Sprintf("%s:%d", cfg.Host, cfg.Port),
  Password: cfg.Password, // æ²¡æœ‰å¯†ç ï¼Œé»˜è®¤å€¼
  DB:       cfg.DB,       // é»˜è®¤DB 0 è¿æ¥åˆ°æœåŠ¡å™¨åè¦é€‰æ‹©çš„æ•°æ®åº“ã€‚
  PoolSize: cfg.PoolSize, // æœ€å¤§å¥—æ¥å­—è¿æ¥æ•°ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¯ç”¨CPUæœ‰10ä¸ªè¿æ¥ï¼Œç”±runtime.GOMAXPROCSæŠ¥å‘Šã€‚
 })

 // Backgroundè¿”å›ä¸€ä¸ªéç©ºçš„Contextã€‚å®ƒæ°¸è¿œä¸ä¼šè¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰æˆªæ­¢æ—¥æœŸã€‚
 // å®ƒé€šå¸¸ç”±mainå‡½æ•°ã€åˆå§‹åŒ–å’Œæµ‹è¯•ä½¿ç”¨ï¼Œå¹¶ä½œä¸ºä¼ å…¥è¯·æ±‚çš„é¡¶çº§ä¸Šä¸‹æ–‡
 ctx := context.Background()

 _, err = rdb.Ping(ctx).Result()
 return
}

func Close() {
 _ = rdb.Close()
}

```

routes/routes.go

```go
package routes

import (
 "github.com/gin-gonic/gin"
 "net/http"
 "web_app2/logger"
 "web_app2/settings"
)

func Setup() *gin.Engine {
 r := gin.New()
 r.Use(logger.GinLogger(), logger.GinRecovery(true))

 r.GET("/version", func(context *gin.Context) {
  context.String(http.StatusOK, settings.Conf.Version)
 })
 return r
}

```

main.go

```go
package main

import (
 "context"
 "fmt"
 "log"
 "net/http"
 "os"
 "os/signal"
 "syscall"
 "time"
 "web_app2/dao/mysql"
 "web_app2/dao/redis"
 "web_app2/logger"
 "web_app2/routes"
 "web_app2/settings"

 "go.uber.org/zap"
)

// Go Web å¼€å‘é€šç”¨çš„è„šæ‰‹æ¶æ¨¡ç‰ˆ

func main() {
 // 1. åŠ è½½é…ç½®
 if err := settings.Init(); err != nil {
  fmt.Printf("init settings failed, error: %v\n", err)
  return
 }
 // 2. åˆå§‹åŒ–æ—¥å¿—
 if err := logger.Init(settings.Conf.LogConfig); err != nil {
  fmt.Printf("init logger failed, error: %v\n", err)
  return
 }
 defer zap.L().Sync()
 zap.L().Debug("logger initialized successfully")
 // 3. åˆå§‹åŒ– MySQL è¿æ¥
 if err := mysql.Init(settings.Conf.MySQLConfig); err != nil {
  fmt.Printf("init mysql failed, error: %v\n", err)
  return
 }
 defer mysql.Close()
 // 4. åˆå§‹åŒ– Redis è¿æ¥
 if err := redis.Init(settings.Conf.RedisConfig); err != nil {
  fmt.Printf("init redis failed, error: %v\n", err)
  return
 }
 defer redis.Close()
 // 5. æ³¨å†Œè·¯ç”±
 router := routes.Setup()
 // 6. å¯åŠ¨æœåŠ¡ï¼ˆä¼˜é›…å…³æœºï¼‰
 // æœåŠ¡å™¨å®šä¹‰è¿è¡ŒHTTPæœåŠ¡å™¨çš„å‚æ•°ã€‚Serverçš„é›¶å€¼æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é…ç½®ã€‚
 srv := &http.Server{
  // Addrå¯é€‰åœ°ä»¥â€œhost:portâ€çš„å½¢å¼æŒ‡å®šæœåŠ¡å™¨è¦ç›‘å¬çš„TCPåœ°å€ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨â€œ:httpâ€(ç«¯å£80)ã€‚
  // æœåŠ¡åç§°åœ¨RFC 6335ä¸­å®šä¹‰ï¼Œå¹¶ç”±IANAåˆ†é…
  Addr:    fmt.Sprintf(":%d", settings.Conf.Port),
  Handler: router,
 }

 go func() {
  // å¼€å¯ä¸€ä¸ªgoroutineå¯åŠ¨æœåŠ¡ï¼Œå¦‚æœä¸ç”¨ goroutineï¼Œä¸‹é¢çš„ä»£ç  ListenAndServe ä¼šä¸€ç›´æ¥æ”¶è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚ï¼Œè¿›å…¥æ— é™å¾ªç¯ã€‚ä»£ç å°±ä¸ä¼šå¾€ä¸‹æ‰§è¡Œã€‚

  // ListenAndServeç›‘å¬TCPç½‘ç»œåœ°å€srv.Addrï¼Œç„¶åè°ƒç”¨Serveæ¥å¤„ç†ä¼ å…¥è¿æ¥ä¸Šçš„è¯·æ±‚ã€‚æ¥å—çš„è¿æ¥é…ç½®ä¸ºä½¿TCPèƒ½ä¿æŒè¿æ¥ã€‚
  // ListenAndServe always returns a non-nil error. After Shutdown or Close,
  // the returned error is ErrServerClosed.
  if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
   log.Fatalf("listen: %s\n", err) // Fatalf ç›¸å½“äºPrintf()ä¹‹åå†è°ƒç”¨os.Exit(1)ã€‚
  }
 }()

 // ç­‰å¾…ä¸­æ–­ä¿¡å·æ¥ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ï¼Œä¸ºå…³é—­æœåŠ¡å™¨æ“ä½œè®¾ç½®ä¸€ä¸ª5ç§’çš„è¶…æ—¶

 // makeå†…ç½®å‡½æ•°åˆ†é…å¹¶åˆå§‹åŒ–(ä»…)sliceã€mapæˆ–chanç±»å‹çš„å¯¹è±¡ã€‚
 // ä¸newä¸€æ ·ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å‹ï¼Œè€Œä¸æ˜¯å€¼ã€‚
 // ä¸newä¸åŒï¼Œmakeçš„è¿”å›ç±»å‹ä¸å…¶å‚æ•°çš„ç±»å‹ç›¸åŒï¼Œè€Œä¸æ˜¯æŒ‡å‘å®ƒçš„æŒ‡é’ˆ
 // Channel:é€šé“çš„ç¼“å†²åŒºç”¨æŒ‡å®šçš„ç¼“å†²åŒºå®¹é‡åˆå§‹åŒ–ã€‚å¦‚æœä¸ºé›¶ï¼Œæˆ–è€…å¿½ç•¥å¤§å°ï¼Œåˆ™é€šé“æœªè¢«ç¼“å†²ã€‚

 // ä¿¡å· Signal è¡¨ç¤ºæ“ä½œç³»ç»Ÿä¿¡å·ã€‚é€šå¸¸çš„åº•å±‚å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿ:åœ¨Unixä¸Šæ˜¯syscall.Signalã€‚
 quit := make(chan os.Signal, 1) // åˆ›å»ºä¸€ä¸ªæ¥æ”¶ä¿¡å·çš„é€šé“
 // kill é»˜è®¤ä¼šå‘é€ syscall.SIGTERM ä¿¡å·
 // kill -2 å‘é€ syscall.SIGINT ä¿¡å·ï¼ŒCtrl+C å°±æ˜¯è§¦å‘ç³»ç»ŸSIGINTä¿¡å·
 // kill -9 å‘é€ syscall.SIGKILL ä¿¡å·ï¼Œä½†æ˜¯ä¸èƒ½è¢«æ•è·ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ å®ƒ
 // signal.NotifyæŠŠæ”¶åˆ°çš„ syscall.SIGINTæˆ–syscall.SIGTERM ä¿¡å·è½¬å‘ç»™quit

 // Notifyä½¿åŒ…ä¿¡å·å°†ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦‚æœæ²¡æœ‰æä¾›ä¿¡å·ï¼Œåˆ™å°†æ‰€æœ‰ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦åˆ™ä»…å°†æä¾›çš„ä¿¡å·è½¬å‘ç»™cã€‚
 // åŒ…ä¿¡å·ä¸ä¼šé˜»å¡å‘é€åˆ°c:è°ƒç”¨è€…å¿…é¡»ç¡®ä¿cæœ‰è¶³å¤Ÿçš„ç¼“å†²ç©ºé—´æ¥è·Ÿä¸Šé¢„æœŸçš„ä¿¡å·é€Ÿç‡ã€‚å¯¹äºä»…ç”¨äºé€šçŸ¥ä¸€ä¸ªä¿¡å·å€¼çš„é€šé“ï¼Œå¤§å°ä¸º1çš„ç¼“å†²åŒºå°±è¶³å¤Ÿäº†ã€‚
 // å…è®¸ä½¿ç”¨åŒä¸€é€šé“å¤šæ¬¡è°ƒç”¨Notify:æ¯æ¬¡è°ƒç”¨éƒ½æ‰©å±•å‘é€åˆ°è¯¥é€šé“çš„ä¿¡å·é›†ã€‚ä»é›†åˆä¸­ç§»é™¤ä¿¡å·çš„å”¯ä¸€æ–¹æ³•æ˜¯è°ƒç”¨Stopã€‚
 // å…è®¸ä½¿ç”¨ä¸åŒçš„é€šé“å’Œç›¸åŒçš„ä¿¡å·å¤šæ¬¡è°ƒç”¨Notify:æ¯ä¸ªé€šé“ç‹¬ç«‹åœ°æ¥æ”¶ä¼ å…¥ä¿¡å·çš„å‰¯æœ¬ã€‚
 signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM) // æ­¤å¤„ä¸ä¼šé˜»å¡
 <-quit                                               // é˜»å¡åœ¨æ­¤ï¼Œå½“æ¥æ”¶åˆ°ä¸Šè¿°ä¸¤ç§ä¿¡å·æ—¶æ‰ä¼šå¾€ä¸‹æ‰§è¡Œ
 zap.L().Info("Shutdown Server ...")
 // åˆ›å»ºä¸€ä¸ª5ç§’è¶…æ—¶çš„context
 ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
 defer cancel()
 // 5ç§’å†…ä¼˜é›…å…³é—­æœåŠ¡ï¼ˆå°†æœªå¤„ç†å®Œçš„è¯·æ±‚å¤„ç†å®Œå†å…³é—­æœåŠ¡ï¼‰ï¼Œè¶…è¿‡5ç§’å°±è¶…æ—¶é€€å‡º

 // å…³æœºå°†åœ¨ä¸ä¸­æ–­ä»»ä½•æ´»åŠ¨è¿æ¥çš„æƒ…å†µä¸‹ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ã€‚
 // Shutdownçš„å·¥ä½œåŸç†æ˜¯é¦–å…ˆå…³é—­æ‰€æœ‰æ‰“å¼€çš„ä¾¦å¬å™¨ï¼Œç„¶åå…³é—­æ‰€æœ‰ç©ºé—²è¿æ¥ï¼Œç„¶åæ— é™æœŸåœ°ç­‰å¾…è¿æ¥è¿”å›ç©ºé—²çŠ¶æ€ï¼Œç„¶åå…³é—­ã€‚
 // å¦‚æœæä¾›çš„ä¸Šä¸‹æ–‡åœ¨å…³é—­å®Œæˆä¹‹å‰è¿‡æœŸï¼Œåˆ™shutdownè¿”å›ä¸Šä¸‹æ–‡çš„é”™è¯¯ï¼Œå¦åˆ™è¿”å›å…³é—­æœåŠ¡å™¨çš„åº•å±‚ä¾¦å¬å™¨æ‰€è¿”å›çš„ä»»ä½•é”™è¯¯ã€‚
 // å½“Shutdownè¢«è°ƒç”¨æ—¶ï¼ŒServe, ListenAndServeå’ŒListenAndServeTLSä¼šç«‹å³è¿”å›ErrServerClosedã€‚ç¡®ä¿ç¨‹åºæ²¡æœ‰é€€å‡ºï¼Œè€Œæ˜¯ç­‰å¾…Shutdownè¿”å›ã€‚
 // å…³é—­ä¸è¯•å›¾å…³é—­æˆ–ç­‰å¾…è¢«åŠ«æŒçš„è¿æ¥ï¼Œå¦‚WebSocketsã€‚å¦‚æœéœ€è¦çš„è¯ï¼ŒShutdownçš„è°ƒç”¨è€…åº”è¯¥å•ç‹¬é€šçŸ¥è¿™äº›é•¿å¯¿å‘½è¿æ¥å…³é—­ï¼Œå¹¶ç­‰å¾…å®ƒä»¬å…³é—­ã€‚
 // ä¸€æ—¦åœ¨æœåŠ¡å™¨ä¸Šè°ƒç”¨Shutdownï¼Œå®ƒå¯èƒ½ä¸ä¼šè¢«é‡ç”¨;ä»¥åå¯¹Serveç­‰æ–¹æ³•çš„è°ƒç”¨å°†è¿”å›ErrServerClosedã€‚
 if err := srv.Shutdown(ctx); err != nil {
  zap.L().Fatal("Server Shutdown", zap.Error(err))
 }

 zap.L().Info("Server exiting")
}

```

è¿è¡Œ

```bash
Code/go/web_app2 via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go run main.go 
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)


```

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306200935229.png)

### Git æäº¤

```bash
~/Code/go via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ cd web_app

Code/go/web_app via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ echo "# go_web_app" >> README.md

Code/go/web_app via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git init
æç¤ºï¼šä½¿ç”¨ 'master' ä½œä¸ºåˆå§‹åˆ†æ”¯çš„åç§°ã€‚è¿™ä¸ªé»˜è®¤åˆ†æ”¯åç§°å¯èƒ½ä¼šæ›´æ”¹ã€‚è¦åœ¨æ–°ä»“åº“ä¸­
æç¤ºï¼šé…ç½®ä½¿ç”¨åˆå§‹åˆ†æ”¯åï¼Œå¹¶æ¶ˆé™¤è¿™æ¡è­¦å‘Šï¼Œè¯·æ‰§è¡Œï¼š
æç¤ºï¼š
æç¤ºï¼š git config --global init.defaultBranch <åç§°>
æç¤ºï¼š
æç¤ºï¼šé™¤äº† 'master' ä¹‹å¤–ï¼Œé€šå¸¸é€‰å®šçš„åå­—æœ‰ 'main'ã€'trunk' å’Œ 'development'ã€‚
æç¤ºï¼šå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤é‡å‘½ååˆšåˆ›å»ºçš„åˆ†æ”¯ï¼š
æç¤ºï¼š
æç¤ºï¼š git branch -m <name>
å·²åˆå§‹åŒ–ç©ºçš„ Git ä»“åº“äº /Users/qiaopengjun/Code/go/web_app/.git/

web_app on î‚  master [?] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git add .

web_app on î‚  master [+] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git commit -m "first commit"
[masterï¼ˆæ ¹æäº¤ï¼‰ 6b90b06] first commit
 17 files changed, 1598 insertions(+)
 create mode 100644 .idea/.gitignore
 create mode 100644 .idea/dbnavigator.xml
 create mode 100644 .idea/modules.xml
 create mode 100644 .idea/watcherTasks.xml
 create mode 100644 .idea/web_app.iml
 create mode 100644 README.md
 create mode 100644 config.yaml
 create mode 100644 dao/mysql/mysql.go
 create mode 100644 dao/redis/redis.go
 create mode 100644 go.mod
 create mode 100644 go.sum
 create mode 100644 logger/logger.go
 create mode 100644 main.go
 create mode 100644 routes/routes.go
 create mode 100644 settings/settings.go
 create mode 100755 web_app
 create mode 100644 web_app.log

web_app on î‚  master via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git branch -M main
# go_web_app

web_app on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git remote add origin git@github.com:qiaopengjun5162/go_web_app.git

web_app on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git push -u origin main
æšä¸¾å¯¹è±¡ä¸­: 26, å®Œæˆ.
å¯¹è±¡è®¡æ•°ä¸­: 100% (26/26), å®Œæˆ.
ä½¿ç”¨ 12 ä¸ªçº¿ç¨‹è¿›è¡Œå‹ç¼©
å‹ç¼©å¯¹è±¡ä¸­: 100% (20/20), å®Œæˆ.
å†™å…¥å¯¹è±¡ä¸­: 100% (26/26), 6.68 MiB | 467.00 KiB/s, å®Œæˆ.
æ€»å…± 26ï¼ˆå·®å¼‚ 0ï¼‰ï¼Œå¤ç”¨ 0ï¼ˆå·®å¼‚ 0ï¼‰ï¼ŒåŒ…å¤ç”¨ 0
To github.com:qiaopengjun5162/go_web_app.git
 * [new branch]      main -> main
åˆ†æ”¯ 'main' è®¾ç½®ä¸ºè·Ÿè¸ª 'origin/main'ã€‚


web_app on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base
# https://github.com/github/gitignore/blob/main/community/Golang/Go.AllowList.giâœ vim README.md

web_app on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base took 32.0s
âœ ga

web_app on î‚  main [+] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git commit -m "update readme"
[main 9f5b231] update readme
 1 file changed, 1 insertion(+)

web_app on î‚  main [â‡¡] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ gp
æšä¸¾å¯¹è±¡ä¸­: 5, å®Œæˆ.
å¯¹è±¡è®¡æ•°ä¸­: 100% (5/5), å®Œæˆ.
ä½¿ç”¨ 12 ä¸ªçº¿ç¨‹è¿›è¡Œå‹ç¼©
å‹ç¼©å¯¹è±¡ä¸­: 100% (3/3), å®Œæˆ.
å†™å…¥å¯¹è±¡ä¸­: 100% (3/3), 329 å­—èŠ‚ | 329.00 KiB/s, å®Œæˆ.
æ€»å…± 3ï¼ˆå·®å¼‚ 1ï¼‰ï¼Œå¤ç”¨ 0ï¼ˆå·®å¼‚ 0ï¼‰ï¼ŒåŒ…å¤ç”¨ 0
remote: Resolving deltas: 100% (1/1), completed with 1 local object.
To github.com:qiaopengjun5162/go_web_app.git
   6b90b06..9f5b231  main -> main

web_app on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base took 4.1s
âœ vim .gitignore

web_app on î‚  main [?] via ğŸ¹ v1.20.3 via ğŸ…’ base took 48.1s
âœ ga

web_app on î‚  main [+] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git commit -m "add gitignore"
[main 827e99b] add gitignore
 1 file changed, 23 insertions(+)
 create mode 100644 .gitignore

web_app on î‚  main [â‡¡] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ gp
æšä¸¾å¯¹è±¡ä¸­: 4, å®Œæˆ.
å¯¹è±¡è®¡æ•°ä¸­: 100% (4/4), å®Œæˆ.
ä½¿ç”¨ 12 ä¸ªçº¿ç¨‹è¿›è¡Œå‹ç¼©
å‹ç¼©å¯¹è±¡ä¸­: 100% (3/3), å®Œæˆ.
å†™å…¥å¯¹è±¡ä¸­: 100% (3/3), 586 å­—èŠ‚ | 586.00 KiB/s, å®Œæˆ.
æ€»å…± 3ï¼ˆå·®å¼‚ 1ï¼‰ï¼Œå¤ç”¨ 0ï¼ˆå·®å¼‚ 0ï¼‰ï¼ŒåŒ…å¤ç”¨ 0
remote: Resolving deltas: 100% (1/1), completed with 1 local object.
To github.com:qiaopengjun5162/go_web_app.git
   9f5b231..827e99b  main -> main



# web_app2
Code/go/web_app2 via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git init
æç¤ºï¼šä½¿ç”¨ 'master' ä½œä¸ºåˆå§‹åˆ†æ”¯çš„åç§°ã€‚è¿™ä¸ªé»˜è®¤åˆ†æ”¯åç§°å¯èƒ½ä¼šæ›´æ”¹ã€‚è¦åœ¨æ–°ä»“åº“ä¸­
æç¤ºï¼šé…ç½®ä½¿ç”¨åˆå§‹åˆ†æ”¯åï¼Œå¹¶æ¶ˆé™¤è¿™æ¡è­¦å‘Šï¼Œè¯·æ‰§è¡Œï¼š
æç¤ºï¼š
æç¤ºï¼š git config --global init.defaultBranch <åç§°>
æç¤ºï¼š
æç¤ºï¼šé™¤äº† 'master' ä¹‹å¤–ï¼Œé€šå¸¸é€‰å®šçš„åå­—æœ‰ 'main'ã€'trunk' å’Œ 'development'ã€‚
æç¤ºï¼šå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤é‡å‘½ååˆšåˆ›å»ºçš„åˆ†æ”¯ï¼š
æç¤ºï¼š
æç¤ºï¼š git branch -m <name>
å·²åˆå§‹åŒ–ç©ºçš„ Git ä»“åº“äº /Users/qiaopengjun/Code/go/web_app2/.git/

web_app2 on î‚  master [?] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git add .

web_app2 on î‚  master [+] via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git commit -m "first commit"
[masterï¼ˆæ ¹æäº¤ï¼‰ 00dd14d] first commit
 15 files changed, 1597 insertions(+)
 create mode 100644 .idea/.gitignore
 create mode 100644 .idea/dbnavigator.xml
 create mode 100644 .idea/modules.xml
 create mode 100644 .idea/web_app2.iml
 create mode 100644 config.yaml
 create mode 100644 dao/mysql/mysql.go
 create mode 100644 dao/redis/redis.go
 create mode 100644 go.mod
 create mode 100644 go.sum
 create mode 100644 logger/logger.go
 create mode 100644 main.go
 create mode 100644 routes/routes.go
 create mode 100644 settings/settings.go
 create mode 100644 web_app.log
 create mode 100755 web_app2

web_app2 on î‚  master via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git remote add origin git@github.com:qiaopengjun5162/go_web_app2.git

web_app2 on î‚  master via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git push -u origin main
é”™è¯¯ï¼šæºå¼•ç”¨è§„æ ¼ main æ²¡æœ‰åŒ¹é…
é”™è¯¯ï¼šæ— æ³•æ¨é€ä¸€äº›å¼•ç”¨åˆ° 'github.com:qiaopengjun5162/go_web_app2.git'

web_app2 on î‚  master via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git branch -M main

web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git push -u origin main
To github.com:qiaopengjun5162/go_web_app2.git
 ! [rejected]        main -> main (fetch first)
é”™è¯¯ï¼šæ— æ³•æ¨é€ä¸€äº›å¼•ç”¨åˆ° 'github.com:qiaopengjun5162/go_web_app2.git'
æç¤ºï¼šæ›´æ–°è¢«æ‹’ç»ï¼Œå› ä¸ºè¿œç¨‹ä»“åº“åŒ…å«æ‚¨æœ¬åœ°å°šä¸å­˜åœ¨çš„æäº¤ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºå¦å¤–
æç¤ºï¼šä¸€ä¸ªä»“åº“å·²å‘è¯¥å¼•ç”¨è¿›è¡Œäº†æ¨é€ã€‚å†æ¬¡æ¨é€å‰ï¼Œæ‚¨å¯èƒ½éœ€è¦å…ˆæ•´åˆè¿œç¨‹å˜æ›´
æç¤ºï¼šï¼ˆå¦‚ 'git pull ...'ï¼‰ã€‚
æç¤ºï¼šè¯¦è§ 'git push --help' ä¸­çš„ 'Note about fast-forwards' å°èŠ‚ã€‚

...

web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git push -u origin main
To github.com:qiaopengjun5162/go_web_app2.git
 ! [rejected]        main -> main (non-fast-forward)
é”™è¯¯ï¼šæ— æ³•æ¨é€ä¸€äº›å¼•ç”¨åˆ° 'github.com:qiaopengjun5162/go_web_app2.git'
æç¤ºï¼šæ›´æ–°è¢«æ‹’ç»ï¼Œå› ä¸ºæ‚¨å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤è½åäºå…¶å¯¹åº”çš„è¿œç¨‹åˆ†æ”¯ã€‚
æç¤ºï¼šå†æ¬¡æ¨é€å‰ï¼Œå…ˆä¸è¿œç¨‹å˜æ›´åˆå¹¶ï¼ˆå¦‚ 'git pull ...'ï¼‰ã€‚è¯¦è§
æç¤ºï¼š'git push --help' ä¸­çš„ 'Note about fast-forwards' å°èŠ‚ã€‚

web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base took 4.1s
âœ git fetch origin

web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base took 4.1s
âœ git merge origin/main
è‡´å‘½é”™è¯¯ï¼šæ‹’ç»åˆå¹¶æ— å…³çš„å†å²

web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base
âœ git pull origin main  --allow-unrelated-histories
æ¥è‡ª github.com:qiaopengjun5162/go_web_app2
 * branch            main       -> FETCH_HEAD
Merge made by the 'ort' strategy.
 .gitignore | 21 +++++++++++++++++++++
 LICENSE    | 21 +++++++++++++++++++++
 README.md  |  2 ++
 3 files changed, 44 insertions(+)
 create mode 100644 .gitignore
 create mode 100644 LICENSE
 create mode 100644 README.md

web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base took 1m 37.5s
âœ git push -u origin main
æšä¸¾å¯¹è±¡ä¸­: 27, å®Œæˆ.
å¯¹è±¡è®¡æ•°ä¸­: 100% (27/27), å®Œæˆ.
ä½¿ç”¨ 12 ä¸ªçº¿ç¨‹è¿›è¡Œå‹ç¼©
å‹ç¼©å¯¹è±¡ä¸­: 100% (21/21), å®Œæˆ.
å†™å…¥å¯¹è±¡ä¸­: 100% (26/26), 6.75 MiB | 681.00 KiB/s, å®Œæˆ.
æ€»å…± 26ï¼ˆå·®å¼‚ 1ï¼‰ï¼Œå¤ç”¨ 0ï¼ˆå·®å¼‚ 0ï¼‰ï¼ŒåŒ…å¤ç”¨ 0
remote: Resolving deltas: 100% (1/1), done.
To github.com:qiaopengjun5162/go_web_app2.git
   62e4da1..e023f0b  main -> main
åˆ†æ”¯ 'main' è®¾ç½®ä¸ºè·Ÿè¸ª 'origin/main'ã€‚

web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base took 14.4s
âœ
```

### é€šè¿‡å‘½ä»¤è¡Œç¨‹åºè·å–é…ç½®æ–‡ä»¶çš„è·¯å¾„

é—®é¢˜ï¼šç›®å‰åªèƒ½åœ¨å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œ

```bash
web_app2 on î‚  main via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ ./web_app2 
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)
^C%                                                                                                                                                                                                                                  
web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base took 7.6s 
âœ cd ..    

~/Code/go via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ web_app2/web_app2 
viper.ReadInConfig failed, error: Config File "config" Not Found in "[/Users/qiaopengjun/Code/go]"
init settings failed, error: Config File "config" Not Found in "[/Users/qiaopengjun/Code/go]"

~/Code/go via ğŸ¹ v1.20.3 via ğŸ…’ base 

```

web_app2/web_app2  æ‰§è¡Œï¼Œviper è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥ï¼Œæ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ã€‚

#### ä½¿ç”¨ os.Args ä¼˜åŒ–ä¿®æ”¹

settings.go

```go
package settings

import (
 "fmt"

 "github.com/fsnotify/fsnotify"
 "github.com/spf13/viper"
)

// Conf å…¨å±€å˜é‡ï¼Œç”¨æ¥ä¿å­˜ç¨‹åºçš„æ‰€æœ‰é…ç½®ä¿¡æ¯
var Conf = new(AppConfig)

type AppConfig struct {
 Name    string `mapstructure:"name"`
 Mode    string `mapstructure:"mode"`
 Version string `mapstructure:"version"`
 Port    int    `mapstructure:"port"`

 *LogConfig   `mapstructure:"log"`
 *MySQLConfig `mapstructure:"mysql"`
 *RedisConfig `mapstructure:"redis"`
}

type LogConfig struct {
 Level      string `mapstructure:"level"`
 Filename   string `mapstructure:"filename"`
 MaxSize    int    `mapstructure:"max_size"`
 MaxAge     int    `mapstructure:"max_age"`
 MaxBackups int    `mapstructure:"max_backups"`
}

type MySQLConfig struct {
 Host         string `mapstructure:"host"`
 User         string `mapstructure:"user"`
 Password     string `mapstructure:"password"`
 DbName       string `mapstructure:"db_name"`
 Port         int    `mapstructure:"port"`
 MaxOpenConns int    `mapstructure:"max_open_conns"`
 MaxIdleConns int    `mapstructure:"max_idle_conns"`
}

type RedisConfig struct {
 Host     string `mapstructure:"host"`
 Password string `mapstructure:"password"`
 Port     int    `matstructure:"port"`
 DB       int    `mapstructure:"db"`
 PoolSize int    `mapstructure:"pool_size"`
}

func Init(filePath string) (err error) {
 // æ–¹å¼1ï¼šç›´æ¥æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„æˆ–è€…ç»å¯¹è·¯å¾„ï¼‰
 // ç›¸å¯¹è·¯å¾„ï¼šç›¸å¯¹æ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
 // viper.SetConfigFile("./conf/config.yaml")
 // ç»å¯¹è·¯å¾„ï¼šç³»ç»Ÿä¸­å®é™…çš„æ–‡ä»¶è·¯å¾„
 // viper.SetConfigFile("/Users/qiaopengjun/Desktop/web_app2 /conf/config.yaml")

 // æ–¹å¼2ï¼šæŒ‡å®šé…ç½®æ–‡ä»¶åå’Œé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œviper è‡ªè¡ŒæŸ¥æ‰¾å¯ç”¨çš„é…ç½®æ–‡ä»¶
 // é…ç½®æ–‡ä»¶åä¸éœ€è¦å¸¦åç¼€
 // é…ç½®æ–‡ä»¶ä½ç½®å¯é…ç½®å¤šä¸ª
 // æ³¨æ„ï¼šviper æ˜¯æ ¹æ®æ–‡ä»¶åæŸ¥æ‰¾ï¼Œé…ç½®ç›®å½•é‡Œä¸è¦æœ‰åŒåçš„é…ç½®æ–‡ä»¶ã€‚
 // ä¾‹å¦‚ï¼šåœ¨é…ç½®ç›®å½• ./conf ä¸­ä¸è¦åŒæ—¶å­˜åœ¨ config.yamlã€config.json

 // è¯»å–é…ç½®æ–‡ä»¶
 viper.SetConfigFile(filePath) // æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
 //viper.SetConfigName("config")        // é…ç½®æ–‡ä»¶åç§°(æ— æ‰©å±•å)
 //viper.AddConfigPath(".")             // æŒ‡å®šæŸ¥æ‰¾é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼ˆè¿™é‡Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰å¯ä»¥é…ç½®å¤šä¸ª
 //viper.AddConfigPath("./conf")        // æŒ‡å®šæŸ¥æ‰¾é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼ˆè¿™é‡Œä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰å¯ä»¥é…ç½®å¤šä¸ª
 // SetConfigTypeè®¾ç½®è¿œç«¯æºè¿”å›çš„é…ç½®ç±»å‹ï¼Œä¾‹å¦‚:â€œjsonâ€ã€‚
 // åŸºæœ¬ä¸Šæ˜¯é…åˆè¿œç¨‹é…ç½®ä¸­å¿ƒä½¿ç”¨çš„ï¼Œå‘Šè¯‰viper å½“å‰çš„æ•°æ®ä½¿ç”¨ä»€ä¹ˆæ ¼å¼å»è§£æ
 //viper.SetConfigType("yaml")

 err = viper.ReadInConfig() // æŸ¥æ‰¾å¹¶è¯»å–é…ç½®æ–‡ä»¶
 if err != nil {            // å¤„ç†è¯»å–é…ç½®æ–‡ä»¶çš„é”™è¯¯
  fmt.Printf("viper.ReadInConfig failed, error: %v\n", err)
  return
 }

 // æŠŠè¯»å–åˆ°çš„é…ç½®ä¿¡æ¯ååºåˆ—åŒ–åˆ° Conf å˜é‡ä¸­
 if err = viper.Unmarshal(Conf); err != nil {
  fmt.Printf("viper unmarshal failed, error: %v\n", err)
  return
 }

 // å®æ—¶ç›‘æ§é…ç½®æ–‡ä»¶çš„å˜åŒ– WatchConfig å¼€å§‹ç›‘è§†é…ç½®æ–‡ä»¶çš„æ›´æ”¹ã€‚
 viper.WatchConfig()
 // OnConfigChangeè®¾ç½®é…ç½®æ–‡ä»¶æ›´æ”¹æ—¶è°ƒç”¨çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚
 // å½“é…ç½®æ–‡ä»¶å˜åŒ–ä¹‹åè°ƒç”¨çš„ä¸€ä¸ªå›è°ƒå‡½æ•°
 viper.OnConfigChange(func(e fsnotify.Event) {
  fmt.Println("Config file changed:", e.Name)
  if err = viper.Unmarshal(Conf); err != nil {
   fmt.Printf("viper unmarshal OnConfigChange failed, error: %v\n", err)
  }
 })

 return
}

```

main.go

```go
package main

import (
 "context"
 "fmt"
 "log"
 "net/http"
 "os"
 "os/signal"
 "syscall"
 "time"
 "web_app2/dao/mysql"
 "web_app2/dao/redis"
 "web_app2/logger"
 "web_app2/routes"
 "web_app2/settings"

 "go.uber.org/zap"
)

// Go Web å¼€å‘é€šç”¨çš„è„šæ‰‹æ¶æ¨¡ç‰ˆ

func main() {
 if len(os.Args) < 2 {
  fmt.Println("please need config file.eg: web_app2 config.yaml")
  return
 }
 // 1. åŠ è½½é…ç½®
 if err := settings.Init(os.Args[1]); err != nil {
  fmt.Printf("init settings failed, error: %v\n", err)
  return
 }
 // 2. åˆå§‹åŒ–æ—¥å¿—
 if err := logger.Init(settings.Conf.LogConfig); err != nil {
  fmt.Printf("init logger failed, error: %v\n", err)
  return
 }
 defer zap.L().Sync()
 zap.L().Debug("logger initialized successfully")
 // 3. åˆå§‹åŒ– MySQL è¿æ¥
 if err := mysql.Init(settings.Conf.MySQLConfig); err != nil {
  fmt.Printf("init mysql failed, error: %v\n", err)
  return
 }
 defer mysql.Close()
 // 4. åˆå§‹åŒ– Redis è¿æ¥
 if err := redis.Init(settings.Conf.RedisConfig); err != nil {
  fmt.Printf("init redis failed, error: %v\n", err)
  return
 }
 defer redis.Close()
 // 5. æ³¨å†Œè·¯ç”±
 router := routes.Setup()
 // 6. å¯åŠ¨æœåŠ¡ï¼ˆä¼˜é›…å…³æœºï¼‰
 // æœåŠ¡å™¨å®šä¹‰è¿è¡ŒHTTPæœåŠ¡å™¨çš„å‚æ•°ã€‚Serverçš„é›¶å€¼æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é…ç½®ã€‚
 srv := &http.Server{
  // Addrå¯é€‰åœ°ä»¥â€œhost:portâ€çš„å½¢å¼æŒ‡å®šæœåŠ¡å™¨è¦ç›‘å¬çš„TCPåœ°å€ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨â€œ:httpâ€(ç«¯å£80)ã€‚
  // æœåŠ¡åç§°åœ¨RFC 6335ä¸­å®šä¹‰ï¼Œå¹¶ç”±IANAåˆ†é…
  Addr:    fmt.Sprintf(":%d", settings.Conf.Port),
  Handler: router,
 }

 go func() {
  // å¼€å¯ä¸€ä¸ªgoroutineå¯åŠ¨æœåŠ¡ï¼Œå¦‚æœä¸ç”¨ goroutineï¼Œä¸‹é¢çš„ä»£ç  ListenAndServe ä¼šä¸€ç›´æ¥æ”¶è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚ï¼Œè¿›å…¥æ— é™å¾ªç¯ã€‚ä»£ç å°±ä¸ä¼šå¾€ä¸‹æ‰§è¡Œã€‚

  // ListenAndServeç›‘å¬TCPç½‘ç»œåœ°å€srv.Addrï¼Œç„¶åè°ƒç”¨Serveæ¥å¤„ç†ä¼ å…¥è¿æ¥ä¸Šçš„è¯·æ±‚ã€‚æ¥å—çš„è¿æ¥é…ç½®ä¸ºä½¿TCPèƒ½ä¿æŒè¿æ¥ã€‚
  // ListenAndServe always returns a non-nil error. After Shutdown or Close,
  // the returned error is ErrServerClosed.
  if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
   log.Fatalf("listen: %s\n", err) // Fatalf ç›¸å½“äºPrintf()ä¹‹åå†è°ƒç”¨os.Exit(1)ã€‚
  }
 }()

 // ç­‰å¾…ä¸­æ–­ä¿¡å·æ¥ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ï¼Œä¸ºå…³é—­æœåŠ¡å™¨æ“ä½œè®¾ç½®ä¸€ä¸ª5ç§’çš„è¶…æ—¶

 // makeå†…ç½®å‡½æ•°åˆ†é…å¹¶åˆå§‹åŒ–(ä»…)sliceã€mapæˆ–chanç±»å‹çš„å¯¹è±¡ã€‚
 // ä¸newä¸€æ ·ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å‹ï¼Œè€Œä¸æ˜¯å€¼ã€‚
 // ä¸newä¸åŒï¼Œmakeçš„è¿”å›ç±»å‹ä¸å…¶å‚æ•°çš„ç±»å‹ç›¸åŒï¼Œè€Œä¸æ˜¯æŒ‡å‘å®ƒçš„æŒ‡é’ˆ
 // Channel:é€šé“çš„ç¼“å†²åŒºç”¨æŒ‡å®šçš„ç¼“å†²åŒºå®¹é‡åˆå§‹åŒ–ã€‚å¦‚æœä¸ºé›¶ï¼Œæˆ–è€…å¿½ç•¥å¤§å°ï¼Œåˆ™é€šé“æœªè¢«ç¼“å†²ã€‚

 // ä¿¡å· Signal è¡¨ç¤ºæ“ä½œç³»ç»Ÿä¿¡å·ã€‚é€šå¸¸çš„åº•å±‚å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿ:åœ¨Unixä¸Šæ˜¯syscall.Signalã€‚
 quit := make(chan os.Signal, 1) // åˆ›å»ºä¸€ä¸ªæ¥æ”¶ä¿¡å·çš„é€šé“
 // kill é»˜è®¤ä¼šå‘é€ syscall.SIGTERM ä¿¡å·
 // kill -2 å‘é€ syscall.SIGINT ä¿¡å·ï¼ŒCtrl+C å°±æ˜¯è§¦å‘ç³»ç»ŸSIGINTä¿¡å·
 // kill -9 å‘é€ syscall.SIGKILL ä¿¡å·ï¼Œä½†æ˜¯ä¸èƒ½è¢«æ•è·ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ å®ƒ
 // signal.NotifyæŠŠæ”¶åˆ°çš„ syscall.SIGINTæˆ–syscall.SIGTERM ä¿¡å·è½¬å‘ç»™quit

 // Notifyä½¿åŒ…ä¿¡å·å°†ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦‚æœæ²¡æœ‰æä¾›ä¿¡å·ï¼Œåˆ™å°†æ‰€æœ‰ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦åˆ™ä»…å°†æä¾›çš„ä¿¡å·è½¬å‘ç»™cã€‚
 // åŒ…ä¿¡å·ä¸ä¼šé˜»å¡å‘é€åˆ°c:è°ƒç”¨è€…å¿…é¡»ç¡®ä¿cæœ‰è¶³å¤Ÿçš„ç¼“å†²ç©ºé—´æ¥è·Ÿä¸Šé¢„æœŸçš„ä¿¡å·é€Ÿç‡ã€‚å¯¹äºä»…ç”¨äºé€šçŸ¥ä¸€ä¸ªä¿¡å·å€¼çš„é€šé“ï¼Œå¤§å°ä¸º1çš„ç¼“å†²åŒºå°±è¶³å¤Ÿäº†ã€‚
 // å…è®¸ä½¿ç”¨åŒä¸€é€šé“å¤šæ¬¡è°ƒç”¨Notify:æ¯æ¬¡è°ƒç”¨éƒ½æ‰©å±•å‘é€åˆ°è¯¥é€šé“çš„ä¿¡å·é›†ã€‚ä»é›†åˆä¸­ç§»é™¤ä¿¡å·çš„å”¯ä¸€æ–¹æ³•æ˜¯è°ƒç”¨Stopã€‚
 // å…è®¸ä½¿ç”¨ä¸åŒçš„é€šé“å’Œç›¸åŒçš„ä¿¡å·å¤šæ¬¡è°ƒç”¨Notify:æ¯ä¸ªé€šé“ç‹¬ç«‹åœ°æ¥æ”¶ä¼ å…¥ä¿¡å·çš„å‰¯æœ¬ã€‚
 signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM) // æ­¤å¤„ä¸ä¼šé˜»å¡
 <-quit                                               // é˜»å¡åœ¨æ­¤ï¼Œå½“æ¥æ”¶åˆ°ä¸Šè¿°ä¸¤ç§ä¿¡å·æ—¶æ‰ä¼šå¾€ä¸‹æ‰§è¡Œ
 zap.L().Info("Shutdown Server ...")
 // åˆ›å»ºä¸€ä¸ª5ç§’è¶…æ—¶çš„context
 ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
 defer cancel()
 // 5ç§’å†…ä¼˜é›…å…³é—­æœåŠ¡ï¼ˆå°†æœªå¤„ç†å®Œçš„è¯·æ±‚å¤„ç†å®Œå†å…³é—­æœåŠ¡ï¼‰ï¼Œè¶…è¿‡5ç§’å°±è¶…æ—¶é€€å‡º

 // å…³æœºå°†åœ¨ä¸ä¸­æ–­ä»»ä½•æ´»åŠ¨è¿æ¥çš„æƒ…å†µä¸‹ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ã€‚
 // Shutdownçš„å·¥ä½œåŸç†æ˜¯é¦–å…ˆå…³é—­æ‰€æœ‰æ‰“å¼€çš„ä¾¦å¬å™¨ï¼Œç„¶åå…³é—­æ‰€æœ‰ç©ºé—²è¿æ¥ï¼Œç„¶åæ— é™æœŸåœ°ç­‰å¾…è¿æ¥è¿”å›ç©ºé—²çŠ¶æ€ï¼Œç„¶åå…³é—­ã€‚
 // å¦‚æœæä¾›çš„ä¸Šä¸‹æ–‡åœ¨å…³é—­å®Œæˆä¹‹å‰è¿‡æœŸï¼Œåˆ™shutdownè¿”å›ä¸Šä¸‹æ–‡çš„é”™è¯¯ï¼Œå¦åˆ™è¿”å›å…³é—­æœåŠ¡å™¨çš„åº•å±‚ä¾¦å¬å™¨æ‰€è¿”å›çš„ä»»ä½•é”™è¯¯ã€‚
 // å½“Shutdownè¢«è°ƒç”¨æ—¶ï¼ŒServe, ListenAndServeå’ŒListenAndServeTLSä¼šç«‹å³è¿”å›ErrServerClosedã€‚ç¡®ä¿ç¨‹åºæ²¡æœ‰é€€å‡ºï¼Œè€Œæ˜¯ç­‰å¾…Shutdownè¿”å›ã€‚
 // å…³é—­ä¸è¯•å›¾å…³é—­æˆ–ç­‰å¾…è¢«åŠ«æŒçš„è¿æ¥ï¼Œå¦‚WebSocketsã€‚å¦‚æœéœ€è¦çš„è¯ï¼ŒShutdownçš„è°ƒç”¨è€…åº”è¯¥å•ç‹¬é€šçŸ¥è¿™äº›é•¿å¯¿å‘½è¿æ¥å…³é—­ï¼Œå¹¶ç­‰å¾…å®ƒä»¬å…³é—­ã€‚
 // ä¸€æ—¦åœ¨æœåŠ¡å™¨ä¸Šè°ƒç”¨Shutdownï¼Œå®ƒå¯èƒ½ä¸ä¼šè¢«é‡ç”¨;ä»¥åå¯¹Serveç­‰æ–¹æ³•çš„è°ƒç”¨å°†è¿”å›ErrServerClosedã€‚
 if err := srv.Shutdown(ctx); err != nil {
  zap.L().Fatal("Server Shutdown", zap.Error(err))
 }

 zap.L().Info("Server exiting")
}

```

è¿è¡Œ

```bash
web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go build

web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ ./web_app2 
please need config file.eg: web_app2 config.yaml

web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ ./web_app2 config.yaml 
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)

~/Code/go via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ web_app2/web_app2 web_app2/config.yaml 
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)


```

#### ä½¿ç”¨ flagåŒ… ä¼˜åŒ–ä¿®æ”¹

main.go

```go
package main

import (
 "context"
 "flag"
 "fmt"
 "log"
 "net/http"
 "os"
 "os/signal"
 "syscall"
 "time"
 "web_app2/dao/mysql"
 "web_app2/dao/redis"
 "web_app2/logger"
 "web_app2/routes"
 "web_app2/settings"

 "go.uber.org/zap"
)

// Go Web å¼€å‘é€šç”¨çš„è„šæ‰‹æ¶æ¨¡ç‰ˆ

func main() {
 filename := flag.String("filename", "config.yaml", "config file")
 // è§£æå‘½ä»¤è¡Œå‚æ•°
 flag.Parse()
 fmt.Println(*filename)
 //è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°
 fmt.Println(flag.Args())
 //è¿”å›å‘½ä»¤è¡Œå‚æ•°åçš„å…¶ä»–å‚æ•°ä¸ªæ•°
 fmt.Println("NArg", flag.NArg())
 //è¿”å›ä½¿ç”¨çš„å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°
 fmt.Println("NFlag", flag.NFlag())
 if flag.NArg() != 1 || flag.NArg() != 1 {
  fmt.Println("please need config file.eg: web_app2 config.yaml")
  return
 }
 // 1. åŠ è½½é…ç½®
 if err := settings.Init(*filename); err != nil {
  fmt.Printf("init settings failed, error: %v\n", err)
  return
 }
 // 2. åˆå§‹åŒ–æ—¥å¿—
 if err := logger.Init(settings.Conf.LogConfig); err != nil {
  fmt.Printf("init logger failed, error: %v\n", err)
  return
 }
 defer zap.L().Sync()
 zap.L().Debug("logger initialized successfully")
 // 3. åˆå§‹åŒ– MySQL è¿æ¥
 if err := mysql.Init(settings.Conf.MySQLConfig); err != nil {
  fmt.Printf("init mysql failed, error: %v\n", err)
  return
 }
 defer mysql.Close()
 // 4. åˆå§‹åŒ– Redis è¿æ¥
 if err := redis.Init(settings.Conf.RedisConfig); err != nil {
  fmt.Printf("init redis failed, error: %v\n", err)
  return
 }
 defer redis.Close()
 // 5. æ³¨å†Œè·¯ç”±
 router := routes.Setup()
 // 6. å¯åŠ¨æœåŠ¡ï¼ˆä¼˜é›…å…³æœºï¼‰
 // æœåŠ¡å™¨å®šä¹‰è¿è¡ŒHTTPæœåŠ¡å™¨çš„å‚æ•°ã€‚Serverçš„é›¶å€¼æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é…ç½®ã€‚
 srv := &http.Server{
  // Addrå¯é€‰åœ°ä»¥â€œhost:portâ€çš„å½¢å¼æŒ‡å®šæœåŠ¡å™¨è¦ç›‘å¬çš„TCPåœ°å€ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨â€œ:httpâ€(ç«¯å£80)ã€‚
  // æœåŠ¡åç§°åœ¨RFC 6335ä¸­å®šä¹‰ï¼Œå¹¶ç”±IANAåˆ†é…
  Addr:    fmt.Sprintf(":%d", settings.Conf.Port),
  Handler: router,
 }

 go func() {
  // å¼€å¯ä¸€ä¸ªgoroutineå¯åŠ¨æœåŠ¡ï¼Œå¦‚æœä¸ç”¨ goroutineï¼Œä¸‹é¢çš„ä»£ç  ListenAndServe ä¼šä¸€ç›´æ¥æ”¶è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚ï¼Œè¿›å…¥æ— é™å¾ªç¯ã€‚ä»£ç å°±ä¸ä¼šå¾€ä¸‹æ‰§è¡Œã€‚

  // ListenAndServeç›‘å¬TCPç½‘ç»œåœ°å€srv.Addrï¼Œç„¶åè°ƒç”¨Serveæ¥å¤„ç†ä¼ å…¥è¿æ¥ä¸Šçš„è¯·æ±‚ã€‚æ¥å—çš„è¿æ¥é…ç½®ä¸ºä½¿TCPèƒ½ä¿æŒè¿æ¥ã€‚
  // ListenAndServe always returns a non-nil error. After Shutdown or Close,
  // the returned error is ErrServerClosed.
  if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
   log.Fatalf("listen: %s\n", err) // Fatalf ç›¸å½“äºPrintf()ä¹‹åå†è°ƒç”¨os.Exit(1)ã€‚
  }
 }()

 // ç­‰å¾…ä¸­æ–­ä¿¡å·æ¥ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ï¼Œä¸ºå…³é—­æœåŠ¡å™¨æ“ä½œè®¾ç½®ä¸€ä¸ª5ç§’çš„è¶…æ—¶

 // makeå†…ç½®å‡½æ•°åˆ†é…å¹¶åˆå§‹åŒ–(ä»…)sliceã€mapæˆ–chanç±»å‹çš„å¯¹è±¡ã€‚
 // ä¸newä¸€æ ·ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å‹ï¼Œè€Œä¸æ˜¯å€¼ã€‚
 // ä¸newä¸åŒï¼Œmakeçš„è¿”å›ç±»å‹ä¸å…¶å‚æ•°çš„ç±»å‹ç›¸åŒï¼Œè€Œä¸æ˜¯æŒ‡å‘å®ƒçš„æŒ‡é’ˆ
 // Channel:é€šé“çš„ç¼“å†²åŒºç”¨æŒ‡å®šçš„ç¼“å†²åŒºå®¹é‡åˆå§‹åŒ–ã€‚å¦‚æœä¸ºé›¶ï¼Œæˆ–è€…å¿½ç•¥å¤§å°ï¼Œåˆ™é€šé“æœªè¢«ç¼“å†²ã€‚

 // ä¿¡å· Signal è¡¨ç¤ºæ“ä½œç³»ç»Ÿä¿¡å·ã€‚é€šå¸¸çš„åº•å±‚å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿ:åœ¨Unixä¸Šæ˜¯syscall.Signalã€‚
 quit := make(chan os.Signal, 1) // åˆ›å»ºä¸€ä¸ªæ¥æ”¶ä¿¡å·çš„é€šé“
 // kill é»˜è®¤ä¼šå‘é€ syscall.SIGTERM ä¿¡å·
 // kill -2 å‘é€ syscall.SIGINT ä¿¡å·ï¼ŒCtrl+C å°±æ˜¯è§¦å‘ç³»ç»ŸSIGINTä¿¡å·
 // kill -9 å‘é€ syscall.SIGKILL ä¿¡å·ï¼Œä½†æ˜¯ä¸èƒ½è¢«æ•è·ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ å®ƒ
 // signal.NotifyæŠŠæ”¶åˆ°çš„ syscall.SIGINTæˆ–syscall.SIGTERM ä¿¡å·è½¬å‘ç»™quit

 // Notifyä½¿åŒ…ä¿¡å·å°†ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦‚æœæ²¡æœ‰æä¾›ä¿¡å·ï¼Œåˆ™å°†æ‰€æœ‰ä¼ å…¥çš„ä¿¡å·è½¬å‘ç»™cï¼Œå¦åˆ™ä»…å°†æä¾›çš„ä¿¡å·è½¬å‘ç»™cã€‚
 // åŒ…ä¿¡å·ä¸ä¼šé˜»å¡å‘é€åˆ°c:è°ƒç”¨è€…å¿…é¡»ç¡®ä¿cæœ‰è¶³å¤Ÿçš„ç¼“å†²ç©ºé—´æ¥è·Ÿä¸Šé¢„æœŸçš„ä¿¡å·é€Ÿç‡ã€‚å¯¹äºä»…ç”¨äºé€šçŸ¥ä¸€ä¸ªä¿¡å·å€¼çš„é€šé“ï¼Œå¤§å°ä¸º1çš„ç¼“å†²åŒºå°±è¶³å¤Ÿäº†ã€‚
 // å…è®¸ä½¿ç”¨åŒä¸€é€šé“å¤šæ¬¡è°ƒç”¨Notify:æ¯æ¬¡è°ƒç”¨éƒ½æ‰©å±•å‘é€åˆ°è¯¥é€šé“çš„ä¿¡å·é›†ã€‚ä»é›†åˆä¸­ç§»é™¤ä¿¡å·çš„å”¯ä¸€æ–¹æ³•æ˜¯è°ƒç”¨Stopã€‚
 // å…è®¸ä½¿ç”¨ä¸åŒçš„é€šé“å’Œç›¸åŒçš„ä¿¡å·å¤šæ¬¡è°ƒç”¨Notify:æ¯ä¸ªé€šé“ç‹¬ç«‹åœ°æ¥æ”¶ä¼ å…¥ä¿¡å·çš„å‰¯æœ¬ã€‚
 signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM) // æ­¤å¤„ä¸ä¼šé˜»å¡
 <-quit                                               // é˜»å¡åœ¨æ­¤ï¼Œå½“æ¥æ”¶åˆ°ä¸Šè¿°ä¸¤ç§ä¿¡å·æ—¶æ‰ä¼šå¾€ä¸‹æ‰§è¡Œ
 zap.L().Info("Shutdown Server ...")
 // åˆ›å»ºä¸€ä¸ª5ç§’è¶…æ—¶çš„context
 ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
 defer cancel()
 // 5ç§’å†…ä¼˜é›…å…³é—­æœåŠ¡ï¼ˆå°†æœªå¤„ç†å®Œçš„è¯·æ±‚å¤„ç†å®Œå†å…³é—­æœåŠ¡ï¼‰ï¼Œè¶…è¿‡5ç§’å°±è¶…æ—¶é€€å‡º

 // å…³æœºå°†åœ¨ä¸ä¸­æ–­ä»»ä½•æ´»åŠ¨è¿æ¥çš„æƒ…å†µä¸‹ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨ã€‚
 // Shutdownçš„å·¥ä½œåŸç†æ˜¯é¦–å…ˆå…³é—­æ‰€æœ‰æ‰“å¼€çš„ä¾¦å¬å™¨ï¼Œç„¶åå…³é—­æ‰€æœ‰ç©ºé—²è¿æ¥ï¼Œç„¶åæ— é™æœŸåœ°ç­‰å¾…è¿æ¥è¿”å›ç©ºé—²çŠ¶æ€ï¼Œç„¶åå…³é—­ã€‚
 // å¦‚æœæä¾›çš„ä¸Šä¸‹æ–‡åœ¨å…³é—­å®Œæˆä¹‹å‰è¿‡æœŸï¼Œåˆ™shutdownè¿”å›ä¸Šä¸‹æ–‡çš„é”™è¯¯ï¼Œå¦åˆ™è¿”å›å…³é—­æœåŠ¡å™¨çš„åº•å±‚ä¾¦å¬å™¨æ‰€è¿”å›çš„ä»»ä½•é”™è¯¯ã€‚
 // å½“Shutdownè¢«è°ƒç”¨æ—¶ï¼ŒServe, ListenAndServeå’ŒListenAndServeTLSä¼šç«‹å³è¿”å›ErrServerClosedã€‚ç¡®ä¿ç¨‹åºæ²¡æœ‰é€€å‡ºï¼Œè€Œæ˜¯ç­‰å¾…Shutdownè¿”å›ã€‚
 // å…³é—­ä¸è¯•å›¾å…³é—­æˆ–ç­‰å¾…è¢«åŠ«æŒçš„è¿æ¥ï¼Œå¦‚WebSocketsã€‚å¦‚æœéœ€è¦çš„è¯ï¼ŒShutdownçš„è°ƒç”¨è€…åº”è¯¥å•ç‹¬é€šçŸ¥è¿™äº›é•¿å¯¿å‘½è¿æ¥å…³é—­ï¼Œå¹¶ç­‰å¾…å®ƒä»¬å…³é—­ã€‚
 // ä¸€æ—¦åœ¨æœåŠ¡å™¨ä¸Šè°ƒç”¨Shutdownï¼Œå®ƒå¯èƒ½ä¸ä¼šè¢«é‡ç”¨;ä»¥åå¯¹Serveç­‰æ–¹æ³•çš„è°ƒç”¨å°†è¿”å›ErrServerClosedã€‚
 if err := srv.Shutdown(ctx); err != nil {
  zap.L().Fatal("Server Shutdown", zap.Error(err))
 }

 zap.L().Info("Server exiting")
}

```

è¿è¡Œ

```bash
web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go build                        

web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ ./web_app2 -filename config.yaml
config.yaml
[]
NArg 0
NFlag 1
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)
^C%                                                                                                                                                                                                                                  
web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base took 17.8s 
âœ ./web_app2 -filename=config.yaml
config.yaml
[]
NArg 0
NFlag 1
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)
^C%                                                                                                                                                                                                                                  
web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base took 9.2s 
âœ ./web_app2 --filename=config.yaml
config.yaml
[]
NArg 0
NFlag 1
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)
^C%                                                                                                                                                                                                                                  
web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base took 3.8s 
âœ ./web_app2 --filename config.yaml
config.yaml
[]
NArg 0
NFlag 1
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)
^C%                                                                                                                                                                                                                                  
web_app2 on î‚  main [!] via ğŸ¹ v1.20.3 via ğŸ…’ base took 2.7s 
âœ ./web_app2 config.yaml           
config.yaml
[config.yaml]
NArg 1
NFlag 0
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> web_app2/routes.Setup.func1 (3 handlers)


```
