+++
title = "@solana/web3.js 2.0ï¼šSolana è½¬è´¦å…¨æµç¨‹è§£æ"
description = "@solana/web3.js 2.0ï¼šSolana è½¬è´¦å…¨æµç¨‹è§£æ"
date = 2025-03-25 11:20:10+08:00
[taxonomies]
categories = ["Solana", "Web3"]
tags = ["Solana", "Web3"]
+++

<!-- more -->

# @solana/web3.js 2.0ï¼šSolana è½¬è´¦å…¨æµç¨‹è§£æ

Solana åŒºå—é“¾ä»¥é«˜ååé‡å’Œä½äº¤æ˜“æˆæœ¬ï¼Œå·²æˆä¸ºå¼€å‘è€…çš„çƒ­é—¨é€‰æ‹©ã€‚è€Œ @solana
/web3.js 2.0 ä½œä¸ºæœ€æ–°ä¸€ä»£ JavaScript åº“ï¼Œä¸ºä¸ Solana ç½‘ç»œäº¤äº’æä¾›äº†æ›´é«˜æ•ˆã€æ¨¡å—åŒ–çš„å·¥å…·ã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æå¦‚ä½•ä½¿ç”¨ @solana
/web3.js 2.0 å®ç° Solana åŒºå—é“¾ä¸Šçš„è½¬è´¦æ“ä½œï¼Œä»ç¯å¢ƒé…ç½®åˆ°ä»£ç å®ç°ï¼Œå†åˆ°æœ¬åœ°æµ‹è¯•éªŒè¯ï¼Œæ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›ä¸€ä¸ªå®ç”¨çš„å…¨æµç¨‹æŒ‡å—ã€‚æ— è®ºä½ æ˜¯ Solana æ–°æ‰‹è¿˜æ˜¯èµ„æ·±å¼€å‘è€…ï¼Œéƒ½èƒ½ä»ä¸­è·å¾—ä¸°å¯Œçš„å®è·µæ´å¯Ÿã€‚

æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„è½¬è´¦ç¤ºä¾‹ï¼Œç³»ç»Ÿè§£æäº† @solana
/web3.js 2.0 åœ¨ Solana å¼€å‘ä¸­çš„æ ¸å¿ƒåº”ç”¨ã€‚å†…å®¹æ¶µç›–ï¼šç¯å¢ƒå˜é‡ä¸å¯†é’¥é…ç½®ã€RPC å®¢æˆ·ç«¯è¿æ¥ã€ç­¾åè€…ç”Ÿæˆã€äº¤æ˜“æ¶ˆæ¯æ„å»ºï¼Œä»¥åŠ 0.5 SOL çš„è½¬è´¦é€»è¾‘ï¼Œå¹¶åœ¨æœ¬åœ°æµ‹è¯•éªŒè¯å™¨ä¸ŠéªŒè¯ç»“æœã€‚ä»£ç å®ç°åŸºäº TypeScript çš„ solana_transfer.tsï¼Œé…åˆ package.json é…ç½®ï¼Œå±•ç¤ºäº†ä»å¼€å‘åˆ°éªŒè¯çš„å…¨æµç¨‹æœ€ä½³å®è·µã€‚æ–‡ç« æ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›å¯å¤ç°çš„å‚è€ƒï¼ŒåŠ©åŠ›é«˜æ•ˆæŒæ¡ Solana å¼€å‘ã€‚

## å®æ“

ä»£ç å®ç°ä¸è§£æ
ä»¥ä¸‹æ˜¯å®ç° Solana è½¬è´¦çš„æ ¸å¿ƒä»£ç ï¼Œæˆ‘ä»¬å°†é€æ­¥æ‹†è§£å…¶åŠŸèƒ½å’Œä½œç”¨ã€‚è¿™æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ @solana
/web3.js 2.0 ä»ä¸€ä¸ªè´¦æˆ·å‘å¦ä¸€ä¸ªè´¦æˆ·è½¬è´¦ 0.5 SOLã€‚

### `solann_transfer` æ–‡ä»¶

```ts
import {
    createKeyPairSignerFromBytes,
    createSolanaRpc,
    createSolanaRpcSubscriptions,
    lamports,
    getBase58Encoder,
    sendAndConfirmTransactionFactory,
    pipe,
    createTransactionMessage,
    setTransactionMessageFeePayer,
    setTransactionMessageLifetimeUsingBlockhash,
    appendTransactionMessageInstruction,
    signTransactionMessageWithSigners,
    getSignatureFromTransaction,
    address,
} from "@solana/web3.js";
import { getTransferSolInstruction } from "@solana-program/system";
// å¯¼å…¥ dotenv
import dotenv from "dotenv";

// åŠ è½½ .env æ–‡ä»¶ä¸­çš„å˜é‡
dotenv.config();
import fs from "fs";

// è®¿é—®ç¯å¢ƒå˜é‡
const encoded_data = process.env.ENCODED_DATA;
const private_key = process.env.PRIVATE_KEY;
const user1 = process.env.SOL_ADDRESS1;
const user2 = process.env.SOL_ADDRESS2;
const httpProvider = process.env.SOL_RPC_URL;
const wssProvider = process.env.WSS_PROVIDER;

console.log(`encoded_data: ${encoded_data}`);
if (
    !private_key ||
    !wssProvider ||
    !encoded_data ||
    !user1 ||
    !user2 ||
    !httpProvider
) {
    console.error("Missing environment variables.");
    process.exit(1);
}

const user1Address = address(user1);
const user2Address = address(user2);

// 1 - åˆ›å»ºä¸€ä¸ª Solana RPC å®¢æˆ·ç«¯
const rpc = createSolanaRpc(httpProvider);
const rpcSubscriptions = createSolanaRpcSubscriptions(wssProvider);
console.log(`âœ… - å·²å»ºç«‹ä¸ ${httpProvider} çš„è¿æ¥`);

const LAMPORTS_PER_SOL = BigInt(1_000_000_000);

async function main() {
    const encoded_data = [4, 230, 246];
    // const keypairBytes = JSON.parse(fs.readFileSync("../keys/KeykETTNzif4hHZ8dzqM3xNigyAQ4Z3XXyU9yBbM3y9.json").toString())
    // const signer = await createKeyPairSignerFromBytes(new Uint8Array(keypairBytes as number[]));

    const secretKey = private_key as string;
    const signer = await createKeyPairSignerFromBytes(
        getBase58Encoder().encode(secretKey)
    );

    // const seed = new Uint8Array(encoded_data);
    // const signer = await createKeyPairSignerFromBytes(seed);

    // åˆ›å»ºè½¬è´¦äº¤æ˜“
    const { value: latestBlockhash } = await rpc.getLatestBlockhash().send();

    const transactionMessage = pipe(
        createTransactionMessage({ version: 0 }), // åˆå§‹åŒ–æ–°çš„äº¤æ˜“æ¶ˆæ¯ã€‚ç‰ˆæœ¬ä¸º 0
        (tx) => setTransactionMessageFeePayer(user1Address, tx), // è®¾ç½®äº¤æ˜“çš„æ‰‹ç»­è´¹æ”¯ä»˜è€…
        (tx) => setTransactionMessageLifetimeUsingBlockhash(latestBlockhash, tx), // è®¾ç½®äº¤æ˜“çš„ç”Ÿå‘½å‘¨æœŸ ä½¿ç”¨æœ€è¿‘çš„åŒºå—å“ˆå¸Œè®¾ç½®äº¤æ˜“çš„ç”Ÿå‘½å‘¨æœŸ
        (tx) =>
            appendTransactionMessageInstruction(
                // æ·»åŠ è½¬è´¦æŒ‡ä»¤ å°†è½¬è´¦æŒ‡ä»¤æ·»åŠ åˆ°äº¤æ˜“ä¸­
                getTransferSolInstruction({
                    amount: lamports(LAMPORTS_PER_SOL / BigInt(2)),
                    destination: user2Address,
                    source: signer,
                }),
                tx
            )
    );
    // 5 - ç­¾åå¹¶å‘é€äº¤æ˜“
    const signedTransaction = await signTransactionMessageWithSigners(
        transactionMessage
    );
    const sendAndConfirmTransaction = sendAndConfirmTransactionFactory({
        rpc,
        rpcSubscriptions,
    });

    try {
        await sendAndConfirmTransaction(signedTransaction, {
            commitment: "confirmed",
            skipPreflight: true,
        });
        const signature = getSignatureFromTransaction(signedTransaction);
        console.log("âœ… - è½¬è´¦äº¤æ˜“:", signature);
    } catch (e) {
        console.error("è½¬è´¦å¤±è´¥:", e);
    }
}

main();

/**
 * 
Web3_wallet/solana-demo on î‚  master [âœ˜?] is ğŸ“¦ 1.0.0 via â¬¢ v22.1.0 via ğŸ…’ base 
âœ ts-node solana_transfer.ts
âœ… - å·²å»ºç«‹ä¸ https://solana-devnet.g.alchemy.com/v2/YLgbp9I-spejSR_9EHp_-UYDrIYdrwE1 çš„è¿æ¥
(node:65790) ExperimentalWarning: The Ed25519 Web Crypto API algorithm is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:65790) [UNDICI-WS] Warning: WebSockets are experimental, expect them to change at any time.
âœ… - è½¬è´¦äº¤æ˜“: 5BZMYyU1a7ZHtf6q62nkrvrRfc7ee4pLHyiuUk6sPWHkurpNy4obvD4hGmTwFQpjyhtbstConhXbf4EdUQhba6fu


âœ ts-node solana_transfer.ts
âœ… - å·²å»ºç«‹ä¸ https://solana-devnet.g.alchemy.com/v2/YLgbp9I-spejSR_9EHp_-UYDrIYdrwE1 çš„è¿æ¥
(node:75521) ExperimentalWarning: The Ed25519 Web Crypto API algorithm is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:75521) [UNDICI-WS] Warning: WebSockets are experimental, expect them to change at any time.
âœ… - è½¬è´¦äº¤æ˜“: 5TX6QHZz9BoXdAourteREavDM2q6ZuSc7FyAE69KemrjZZrfJqhML4YqgHeayMAGQEDNJ68HwDymo7D1miHZqcQX

// https://github.com/anamansari062/test-2.0/blob/main/src/index.js
 */

```

### ä»£ç è§£æ

1. å¯¼å…¥æ¨¡å—

ä» @solana/web3.js å¯¼å…¥äº†ä¸€ç³»åˆ—æ ¸å¿ƒå‡½æ•°ï¼Œç”¨äºæ„å»ºå’Œå‘é€äº¤æ˜“ï¼š

- createKeyPairSignerFromBytesï¼šä»ç§é’¥ç”Ÿæˆç­¾åè€…ã€‚
- createSolanaRpc å’Œ createSolanaRpcSubscriptionsï¼šåˆ›å»ºä¸ Solana ç½‘ç»œäº¤äº’çš„ HTTP å’Œ WebSocket å®¢æˆ·ç«¯ã€‚
- lamportsï¼šå°† SOL è½¬æ¢ä¸ºæœ€å°å•ä½ Lamportsï¼ˆ1 SOL = 10äº¿ Lamportsï¼‰ã€‚
- pipeï¼šå‡½æ•°å¼ç¼–ç¨‹å·¥å…·ï¼Œç”¨äºé“¾å¼å¤„ç†äº¤æ˜“æ¶ˆæ¯ã€‚
- createTransactionMessageã€setTransactionMessageFeePayer ç­‰ï¼šæ„å»ºäº¤æ˜“çš„æ­¥éª¤ã€‚
- getTransferSolInstructionï¼šä» @solana-program/system è·å–è½¬è´¦æŒ‡ä»¤ã€‚

2. ç¯å¢ƒé…ç½®

ä½¿ç”¨ dotenv åŠ è½½ .env æ–‡ä»¶ä¸­çš„å˜é‡ï¼ˆå¦‚ç§é’¥ã€åœ°å€ã€RPC URLï¼‰ï¼Œå¹¶è¿›è¡Œæ ¡éªŒã€‚å¦‚æœç¼ºå°‘å…³é”®å˜é‡ï¼Œç¨‹åºä¼šé€€å‡ºï¼Œç¡®ä¿å®‰å…¨æ€§ã€‚

3. RPC å®¢æˆ·ç«¯åˆå§‹åŒ–  

```ts
const rpc = createSolanaRpc(httpProvider);
const rpcSubscriptions = createSolanaRpcSubscriptions(wssProvider);
```

é€šè¿‡ HTTP å’Œ WebSocket åè®®è¿æ¥ Solana ç½‘ç»œï¼Œåˆ†åˆ«ç”¨äºå‘é€è¯·æ±‚å’Œè®¢é˜…äº‹ä»¶ã€‚

4. ç­¾åè€…ç”Ÿæˆ  

```ts
const signer = await createKeyPairSignerFromBytes(getBase58Encoder().encode(secretKey));
```

ä½¿ç”¨ Base58 ç¼–ç çš„ç§é’¥ç”Ÿæˆç­¾åè€…ï¼Œç”¨äºç­¾ç½²äº¤æ˜“ã€‚

5. æ„å»ºäº¤æ˜“æ¶ˆæ¯

ä½¿ç”¨ pipe å‡½æ•°é“¾å¼å¤„ç†ï¼š

- åˆå§‹åŒ–äº¤æ˜“ï¼ˆç‰ˆæœ¬ 0ï¼‰ã€‚
- è®¾ç½®æ‰‹ç»­è´¹æ”¯ä»˜è€…ï¼ˆuser1Addressï¼‰ã€‚
- ä½¿ç”¨æœ€æ–°åŒºå—å“ˆå¸Œï¼ˆlatestBlockhashï¼‰è®¾ç½®äº¤æ˜“æœ‰æ•ˆæœŸã€‚
- æ·»åŠ è½¬è´¦æŒ‡ä»¤ï¼Œè½¬è´¦é‡‘é¢ä¸º 0.5 SOLï¼ˆLAMPORTS_PER_SOL / BigInt(2)ï¼‰ã€‚

6. ç­¾åä¸å‘é€  

```ts
const signedTransaction = await signTransactionMessageWithSigners(transactionMessage);
await sendAndConfirmTransaction(signedTransaction, { commitment: "confirmed", skipPreflight: true });
```

ä½¿ç”¨ç­¾åè€…ç­¾ç½²äº¤æ˜“ï¼Œå¹¶é€šè¿‡å·¥å‚å‡½æ•°å‘é€åˆ°ç½‘ç»œï¼Œç­‰å¾…ç¡®è®¤ã€‚skipPreflight: true è·³è¿‡é¢„æ£€æŸ¥ä»¥åŠ å¿«é€Ÿåº¦ã€‚

7. è¿è¡Œç»“æœ

ç¤ºä¾‹è¾“å‡ºè¡¨æ˜äº¤æ˜“æˆåŠŸï¼š

```
âœ… - è½¬è´¦äº¤æ˜“: 5BZMYyU1a7ZHtf6q62nkrvrRfc7ee4pLHyiuUk6sPWHkurpNy4obvD4hGmTwFQpjyhtbstConhXbf4EdUQhba6fu
```

#### æ‰§è¡Œä¸éªŒè¯

è¿è¡Œ `ts-node solana_transfer.ts`ï¼Œå®Œæˆ 0.5 SOL çš„è½¬è´¦ï¼Œå¹¶è¿”å›äº¤æ˜“ç­¾åï¼Œå¯é€šè¿‡ Solana Explorer æŸ¥çœ‹è¯¦æƒ…ã€‚

### `package.json` æ–‡ä»¶

```json
{
  "name": "solana-demo",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@solana-program/system": "^0.6.2",
    "@solana/web3.js": "2",
    "dotenv": "^16.4.7",
    "ed25519-hd-key": "^1.3.0",
    "bs58": "^6.0.0",
    "bip39": "3.1.0"
  },
  "devDependencies": {
    "@types/node": "^22.13.4"
  }
}

```

### æœ¬åœ°æµ‹è¯•

````bash
# Solana

```bash
âœ solana-test-validator -r

Ledger location: test-ledger
Log: test-ledger/validator.log
â „ Initializing...                                                                                                        Waiting for fees to stabilize 1...
Identity: AvV5zuhWHPCNRhq8qyPrfA4yjLqiFPySFxyYt7NuHicE
Genesis Hash: EQ6H4aqK3RbAP2eYtvrMFHK3SrbKT9NHJ4MtT2hrVCKB
Version: 2.0.15
Shred Version: 290
Gossip Address: 127.0.0.1:1024
TPU Address: 127.0.0.1:1027
JSON RPC URL: http://127.0.0.1:8899
WebSocket PubSub URL: ws://127.0.0.1:8900
â  00:03:00 | Processed Slot: 382 | Confirmed Slot: 382 | Finalized Slot: 351

âœ ts-node transfer.ts

âœ… - å·²å»ºç«‹ä¸ http://127.0.0.1:8899 çš„è¿æ¥
(node:4171) ExperimentalWarning: The Ed25519 Web Crypto API algorithm is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
âœ… - æ–°çš„ user1 åœ°å€å·²åˆ›å»ºï¼š3ziUaeQ1zZwbQf1FYHGYrKQkifEWSG5K47WKPQFzXVpp
âœ… - ä»æ–‡ä»¶ç”Ÿæˆ user2 åœ°å€ï¼šSq7vmiewuLGcQArLUhny1iXtXPqrnC1EWGt5SJ89aS5
âœ… - user1 ä½¿ç”¨ RPC æ–¹æ³•ç©ºæŠ• 1 SOL
âœ… - tx1: 36RRUnQQbPYrXjSTcpw5Aqf9KYW1aBEp8GH9akBAgqfypeyxtWSLx9Ss3e7tqQ83sgwpdhtfaUTXbHBspk58z6dP
(node:4171) [UNDICI-WS] Warning: WebSockets are experimental, expect them to change at any time.
âœ… - user2 ä½¿ç”¨å·¥å‚å‡½æ•°ç©ºæŠ• 1 SOL
âœ… - tx2: 2YFtea2ez4XuDdgKn6Zj9L6ogdt9eFwu4CfSb4Ekgd7kbmUQJEU6frkvVKvCBjBL1fZWM3yaxoKetQyTLZjzsCnj
âœ… - è½¬è´¦äº¤æ˜“: 3Wqnj7Whghqyg9xVXEBkFbTJvCjBJ83eHQ91FPoJ69KzBmWSSppYnvuz7kC9n2uJotVg4eB1ARBbgUQt6SbiHfxe
```

````

## æ€»ç»“

é€šè¿‡å¯¹ @solana
/web3.js 2.0 çš„å…¨æµç¨‹è§£æï¼Œæˆ‘ä»¬æˆåŠŸå®ç°äº† Solana åŒºå—é“¾ä¸Šçš„è½¬è´¦åŠŸèƒ½ã€‚ä»ç¯å¢ƒæ­å»ºåˆ°äº¤æ˜“ç­¾åï¼Œå†åˆ°æœ¬åœ°æµ‹è¯•éªŒè¯ï¼Œæ•´ä¸ªè¿‡ç¨‹å±•ç¤ºäº†è¯¥åº“åœ¨æ€§èƒ½å’Œæ˜“ç”¨æ€§ä¸Šçš„ä¼˜åŠ¿ã€‚å€ŸåŠ© @solana
/web3.js 2.0 çš„æ¨¡å—åŒ–è®¾è®¡ï¼Œå¼€å‘è€…å¯ä»¥æå¤§ç®€åŒ–å¼€å‘å¤æ‚åº¦ï¼Œä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéåº•å±‚ç»†èŠ‚ã€‚æœ¬æ–‡æä¾›çš„ç¤ºä¾‹å¯ä½œä¸ºèµ·ç‚¹ï¼Œå¼€å‘è€…è¿˜å¯è¿›ä¸€æ­¥æ‰©å±•åˆ°æ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼ˆå¦‚æ‰¹é‡äº¤æ˜“æˆ–è·¨ç¨‹åºè°ƒç”¨ï¼‰ï¼Œè§£é” Solana ç”Ÿæ€çš„æ›´å¤šå¯èƒ½ã€‚

## å‚è€ƒ

- <https://www.solanazh.com/>
- <https://github.com/solana-labs>
- <https://github.com/anza-xyz/kit>
- <https://www.jsonrpc.org/specification>
- <https://www.anchor-lang.com/docs>
- <https://solana.com/zh/docs>
- <https://solanacookbook.com/zh/>
- <https://solscan.io/>
- <https://github.com/yihau/anchor-auction/blob/main/programs/auction/src/lib.rs>
- <https://www.solar.team/116d1d99211c81b7b4e3e77e93f231f9>
- <https://explorer.solana.com/>
- <https://websocketking.com/>
- <https://attractive-spade-1e3.notion.site/Solana-fca856aad4e5441f80f28cc4e015ca98>
- <https://github.com/anamansari062/test-2.0/blob/main/src/index.js>
