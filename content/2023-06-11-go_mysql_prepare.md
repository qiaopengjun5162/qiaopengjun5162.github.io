+++
title = "Go è¯­è¨€è¿æ¥æ•°æ®åº“ä¹‹ MySQL é¢„å¤„ç†"
date = 2023-06-11T15:18:41+08:00
description = "Go è¯­è¨€ä¹‹ è¿æ¥ MySQLä¹‹ MySQL é¢„å¤„ç†"
[taxonomies]
tags = ["Go"]
categories = ["Go"]
+++

# Go è¿æ¥ MySQLä¹‹ MySQL é¢„å¤„ç†

## ä¸€ã€ChatGPT å…³äº MySQL é¢„å¤„ç† çš„å›ç­”

### é—®ï¼šä»€ä¹ˆæ˜¯MySQL çš„é¢„å¤„ç† å…·ä½“æ‰§è¡Œè¿‡ç¨‹æ—¶ä»€ä¹ˆ

#### ChatGPT ç­”

MySQLçš„é¢„å¤„ç†æ˜¯ä¸€ç§åœ¨æ‰§è¡ŒSQLè¯­å¥ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç¼–è¯‘å’Œä¼˜åŒ–çš„æœºåˆ¶ã€‚å®ƒå°†SQLè¯­å¥åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼šé¢„å¤„ç†é˜¶æ®µå’Œæ‰§è¡Œé˜¶æ®µã€‚

å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. é¢„å¤„ç†é˜¶æ®µï¼š
   - åº”ç”¨ç¨‹åºå‘é€SQLè¯­å¥ç»™MySQLæœåŠ¡å™¨ï¼Œå°†å…¶ä¸­çš„å‚æ•°éƒ¨åˆ†ç”¨å ä½ç¬¦ï¼ˆå¦‚?ï¼‰ä»£æ›¿ï¼Œå½¢æˆä¸€ä¸ªé¢„å¤„ç†è¯­å¥ã€‚
   - MySQLæœåŠ¡å™¨å¯¹é¢„å¤„ç†è¯­å¥è¿›è¡Œè§£æã€ç¼–è¯‘å’Œä¼˜åŒ–ã€‚
   - åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒMySQLä¼šæ£€æŸ¥è¯­æ³•çš„æ­£ç¡®æ€§ï¼Œåˆ›å»ºæ‰§è¡Œè®¡åˆ’ï¼Œä»¥åŠè¿›è¡Œæƒé™éªŒè¯ç­‰ã€‚
2. æ‰§è¡Œé˜¶æ®µï¼š
   - åœ¨é¢„å¤„ç†å®Œæˆåï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å¤šæ¬¡æ‰§è¡Œè¿™ä¸ªé¢„å¤„ç†è¯­å¥ï¼Œæ¯æ¬¡æ‰§è¡Œæ—¶åªéœ€æä¾›å…·ä½“çš„å‚æ•°å€¼ã€‚
   - åº”ç”¨ç¨‹åºå°†å…·ä½“çš„å‚æ•°å€¼ç»‘å®šåˆ°é¢„å¤„ç†è¯­å¥çš„å ä½ç¬¦ä¸Šã€‚
   - MySQLæœåŠ¡å™¨ä½¿ç”¨ç»‘å®šçš„å‚æ•°å€¼æ‰§è¡Œé¢„å¤„ç†è¯­å¥ï¼Œå¹¶è¿”å›æ‰§è¡Œç»“æœã€‚

é¢„å¤„ç†çš„å¥½å¤„åŒ…æ‹¬ï¼š

- æé«˜æ‰§è¡Œæ•ˆç‡ï¼šé¢„å¤„ç†è¯­å¥åªéœ€è¦ç¼–è¯‘ä¸€æ¬¡ï¼Œåç»­çš„æ‰§è¡Œå¯ä»¥é‡å¤ä½¿ç”¨ï¼Œé¿å…äº†æ¯æ¬¡æ‰§è¡Œéƒ½è¦é‡æ–°è§£æå’Œç¼–è¯‘çš„å¼€é”€ã€‚
- é˜²æ­¢SQLæ³¨å…¥ï¼šé€šè¿‡ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œå°†å‚æ•°å€¼ä¸SQLè¯­å¥åˆ†å¼€å¤„ç†ï¼Œå¯ä»¥é˜²æ­¢æ¶æ„ç”¨æˆ·åˆ©ç”¨è¾“å…¥æ•°æ®è¿›è¡ŒSQLæ³¨å…¥æ”»å‡»ã€‚
- ç®€åŒ–å‚æ•°å¤„ç†ï¼šé¢„å¤„ç†è¯­å¥å¯ä»¥é€šè¿‡å ä½ç¬¦æ¥æ¥æ”¶å‚æ•°ï¼Œé¿å…äº†æ‰‹åŠ¨æ‹¼æ¥SQLè¯­å¥çš„ç¹çå’Œæ½œåœ¨çš„é”™è¯¯ã€‚

æ€»ç»“è€Œè¨€ï¼ŒMySQLçš„é¢„å¤„ç†æ˜¯ä¸€ç§æå‰ç¼–è¯‘å’Œä¼˜åŒ–SQLè¯­å¥çš„æœºåˆ¶ï¼Œå®ƒå°†SQLè¯­å¥åˆ†ä¸ºé¢„å¤„ç†å’Œæ‰§è¡Œä¸¤ä¸ªé˜¶æ®µï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ï¼Œå¹¶ç®€åŒ–äº†å‚æ•°å¤„ç†è¿‡ç¨‹ã€‚

### é—®ï¼šGoå®ç°MySQLé¢„å¤„ç†

#### ChatGPT ç­”

åœ¨ Go ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„ `database/sql` åŒ…æ¥å®ç° MySQL çš„é¢„å¤„ç†ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Go ä¸­è¿›è¡Œ MySQL é¢„å¤„ç†ï¼š

```go
import (
 "database/sql"
 "fmt"
 "log"

 _ "github.com/go-sql-driver/mysql"
)

func main() {
 db, err := sql.Open("mysql", "username:password@tcp(hostname:port)/database")
 if err != nil {
  log.Fatal(err)
 }
 defer db.Close()

 // å‡†å¤‡é¢„å¤„ç†è¯­å¥
 stmt, err := db.Prepare("INSERT INTO users (name, age) VALUES (?, ?)")
 if err != nil {
  log.Fatal(err)
 }
 defer stmt.Close()

 // æ‰§è¡Œé¢„å¤„ç†è¯­å¥
 name := "John"
 age := 30
 _, err = stmt.Exec(name, age)
 if err != nil {
  log.Fatal(err)
 }

 fmt.Println("Insert successful!")
}

```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `sql.Open` å‡½æ•°å»ºç«‹ä¸ MySQL æ•°æ®åº“çš„è¿æ¥ã€‚ç„¶åä½¿ç”¨ `db.Prepare` å‡½æ•°å‡†å¤‡é¢„å¤„ç†è¯­å¥ï¼Œå…¶ä¸­ SQL è¯­å¥ä¸­çš„å‚æ•°ä½ç½®ç”¨å ä½ç¬¦ `?` è¡¨ç¤ºã€‚æ¥ä¸‹æ¥ï¼Œé€šè¿‡ `stmt.Exec` å‡½æ•°æ‰§è¡Œé¢„å¤„ç†è¯­å¥ï¼Œå¹¶ä¼ å…¥å…·ä½“çš„å‚æ•°å€¼ã€‚æœ€åï¼Œæˆ‘ä»¬åœ¨ `main` å‡½æ•°ä¸­è¿›è¡Œäº†é”™è¯¯å¤„ç†ï¼Œå¹¶æ‰“å°äº†æ’å…¥æˆåŠŸçš„æ¶ˆæ¯ã€‚

è¯·ç¡®ä¿åœ¨ä»£ç ä¸­å¡«å…¥æ­£ç¡®çš„ MySQL è¿æ¥ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ã€ä¸»æœºåã€ç«¯å£å·å’Œæ•°æ®åº“åï¼‰ï¼Œä»¥ä¾¿ä¸ç›®æ ‡æ•°æ®åº“å»ºç«‹è¿æ¥ã€‚åŒæ—¶ï¼Œè¯·æ ¹æ®å®é™…çš„é¢„å¤„ç†è¯­å¥å’Œå‚æ•°è¿›è¡Œé€‚å½“çš„ä¿®æ”¹ã€‚

æ³¨æ„ï¼šä¸Šè¿°ç¤ºä¾‹ä»£ç ä»…æ¼”ç¤ºäº†é¢„å¤„ç†çš„åŸºæœ¬æµç¨‹ï¼Œå¹¶æ²¡æœ‰åŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå…¶ä»–åŠŸèƒ½ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå»ºè®®åŠ å…¥é€‚å½“çš„é”™è¯¯å¤„ç†ã€äº‹åŠ¡å¤„ç†ç­‰æœºåˆ¶ï¼Œä»¥ç¡®ä¿ä»£ç çš„å¥å£®æ€§å’Œå®‰å…¨æ€§ã€‚

#### é—®ï¼šMySQLé¢„å¤„ç†é€‚ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ

#### ChatGPT ç­”

MySQLé¢„å¤„ç†é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

1. æ‰§è¡Œé¢‘ç¹çš„é‡å¤æŸ¥è¯¢ï¼šå¦‚æœåº”ç”¨ç¨‹åºéœ€è¦å¤šæ¬¡æ‰§è¡Œç›¸åŒçš„SQLæŸ¥è¯¢ï¼Œä½†åªæ˜¯å‚æ•°å€¼ä¸åŒï¼Œé¢„å¤„ç†å¯ä»¥å‡å°‘æœåŠ¡å™¨çš„å·¥ä½œé‡ã€‚é¢„å¤„ç†è¯­å¥åªéœ€è¦ç¼–è¯‘ä¸€æ¬¡ï¼Œåç»­çš„æ‰§è¡Œå¯ä»¥é‡å¤ä½¿ç”¨ï¼Œé¿å…äº†æ¯æ¬¡éƒ½é‡æ–°è§£æå’Œç¼–è¯‘SQLè¯­å¥çš„å¼€é”€ã€‚
2. å‚æ•°åŒ–æŸ¥è¯¢ï¼šå½“éœ€è¦æ‰§è¡Œå¸¦æœ‰å‚æ•°çš„æŸ¥è¯¢æ—¶ï¼Œé¢„å¤„ç†å¯ä»¥æé«˜å®‰å…¨æ€§å¹¶é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ã€‚é€šè¿‡ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œå°†å‚æ•°å€¼ä¸SQLè¯­å¥åˆ†å¼€å¤„ç†ï¼Œå¯ä»¥ç¡®ä¿è¾“å…¥æ•°æ®è¢«æ­£ç¡®åœ°è½¬ä¹‰å’Œå¤„ç†ï¼Œé¿å…æ¶æ„ç”¨æˆ·åˆ©ç”¨è¾“å…¥æ•°æ®è¿›è¡Œæ”»å‡»ã€‚
3. æé«˜æ€§èƒ½ï¼šé¢„å¤„ç†å¯ä»¥åœ¨ç¼–è¯‘å’Œä¼˜åŒ–é˜¶æ®µå¯¹SQLè¯­å¥è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆæ›´é«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’ã€‚è¿™å¯ä»¥æé«˜æŸ¥è¯¢çš„æ€§èƒ½å’Œå“åº”æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤æ‚æŸ¥è¯¢æˆ–æ¶‰åŠå¤§é‡æ•°æ®çš„æŸ¥è¯¢ã€‚
4. ç®€åŒ–å‚æ•°å¤„ç†ï¼šé¢„å¤„ç†è¯­å¥å¯ä»¥é€šè¿‡å ä½ç¬¦ï¼ˆå¦‚?ï¼‰æ¥æ¥æ”¶å‚æ•°å€¼ï¼Œé¿å…äº†æ‰‹åŠ¨æ‹¼æ¥SQLè¯­å¥çš„ç¹çå’Œæ½œåœ¨çš„é”™è¯¯ã€‚åŒæ—¶ï¼Œä½¿ç”¨é¢„å¤„ç†è¯­å¥å¯ä»¥ç›´æ¥å°†å‚æ•°å€¼ç»‘å®šåˆ°å ä½ç¬¦ä¸Šï¼Œè€Œæ— éœ€æ‰‹åŠ¨è½¬ä¹‰å’Œå¤„ç†å‚æ•°å€¼ã€‚

æ€»ç»“è€Œè¨€ï¼ŒMySQLé¢„å¤„ç†é€‚ç”¨äºéœ€è¦æ‰§è¡Œé‡å¤æŸ¥è¯¢ã€å‚æ•°åŒ–æŸ¥è¯¢ã€æé«˜æ€§èƒ½å’Œç®€åŒ–å‚æ•°å¤„ç†çš„åœºæ™¯ã€‚å®ƒå¯ä»¥å‡å°‘æœåŠ¡å™¨çš„å·¥ä½œé‡ï¼Œæé«˜æŸ¥è¯¢çš„å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Œå¹¶ç®€åŒ–ä»£ç çš„ç¼–å†™å’Œç»´æŠ¤ã€‚

## äºŒã€Go å®ç° MySQL é¢„å¤„ç†

### æŸ¥è¯¢

```go
package main

import (
 "database/sql"
 "fmt"
 "time"

 _ "github.com/go-sql-driver/mysql" // åŒ¿åå¯¼å…¥ è‡ªåŠ¨æ‰§è¡Œ init()
)

var db *sql.DB

func initMySQL() (err error) {
 //DSN (Data Source Name)
 dsn := "root:12345678@tcp(127.0.0.1:3306)/sql_test"
 // æ³¨æ„ï¼šè¦åˆå§‹åŒ–å…¨å±€çš„ db å¯¹è±¡ï¼Œä¸è¦æ–°å£°æ˜ä¸€ä¸ª db å˜é‡
 db, err = sql.Open("mysql", dsn) // åªå¯¹æ ¼å¼è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸ä¼šçœŸæ­£è¿æ¥æ•°æ®åº“
 if err != nil {
  return err
 }

 // Ping éªŒè¯ä¸æ•°æ®åº“çš„è¿æ¥æ˜¯å¦ä»å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶åœ¨å¿…è¦æ—¶å»ºç«‹è¿æ¥ã€‚
 err = db.Ping()
 if err != nil {
  fmt.Printf("connect to db failed, err: %v\n", err)
  return err
 }
 // æ•°å€¼éœ€è¦æ ¹æ®ä¸šåŠ¡å…·ä½“æƒ…å†µæ¥ç¡®å®š
 db.SetConnMaxLifetime(time.Second * 10) // è®¾ç½®å¯ä»¥é‡ç”¨è¿æ¥çš„æœ€é•¿æ—¶é—´
 db.SetConnMaxIdleTime(time.Second * 5)  // è®¾ç½®è¿æ¥å¯èƒ½å¤„äºç©ºé—²çŠ¶æ€çš„æœ€é•¿æ—¶é—´
 db.SetMaxOpenConns(200)                 // è®¾ç½®ä¸æ•°æ®åº“çš„æœ€å¤§æ‰“å¼€è¿æ¥æ•°
 db.SetMaxIdleConns(10)                  //  è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­çš„æœ€å¤§è¿æ¥æ•°
 return nil
}

type user struct {
 id   int
 age  int
 name string
}

// é¢„å¤„ç†æŸ¥è¯¢
func prepareQueryDemo(id int) {
 sqlStr := "SELECT id, name, age FROM user WHERE id > ?"
 stmt, err := db.Prepare(sqlStr)
 if err != nil {
  fmt.Printf("prepare failed, err: %v\n", err)
  return
 }
 defer stmt.Close()
 rows, err := stmt.Query(id)
 if err != nil {
  fmt.Printf("query failed, err: %v\n", err)
  return
 }
 defer rows.Close()
 // å¾ªç¯è¯»å–ç»“æœé›†ä¸­çš„æ•°æ®
 for rows.Next() {
  var u user
  err := rows.Scan(&u.id, &u.name, &u.age)
  if err != nil {
   fmt.Printf("scan failed, err: %v\n", err)
   return
  }
  fmt.Printf("id: %d name: %s age: %d\n", u.id, u.name, u.age)
 }
}

func main() {
 if err := initMySQL(); err != nil {
  fmt.Printf("connect to db failed, err: %v\n", err)
 }
 // æ£€æŸ¥å®Œé”™è¯¯ä¹‹åæ‰§è¡Œï¼Œç¡®ä¿ db ä¸ä¸º nil
 // Close() ç”¨æ¥é‡Šæ”¾æ•°æ®åº“è¿æ¥ç›¸å…³çš„èµ„æº
 // Close å°†å…³é—­æ•°æ®åº“å¹¶é˜»æ­¢å¯åŠ¨æ–°æŸ¥è¯¢ã€‚å…³é—­ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨ä¸Šå·²å¼€å§‹å¤„ç†çš„æ‰€æœ‰æŸ¥è¯¢å®Œæˆã€‚
 defer db.Close()

 fmt.Println("connect to database success")
 // db.xx() å»ä½¿ç”¨æ•°æ®åº“æ“ä½œ...

 // MySQLé¢„å¤„ç†æŸ¥è¯¢å¤šè¡Œæ•°æ®
 prepareQueryDemo(0)
}

```

#### è¿è¡Œ

```bash
Code/go/mysql_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go run main.go
connect to database success
id: 1 name: å°ä¹” age: 16
id: 2 name: å°ä¹” age: 12

Code/go/mysql_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ 
```

### æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œçš„é¢„å¤„ç†åŸºæœ¬ä¸€æ ·ï¼Œä¸‹é¢æ˜¯æ’å…¥ç¤ºä¾‹

```go
package main

import (
 "database/sql"
 "fmt"
 "time"

 _ "github.com/go-sql-driver/mysql" // åŒ¿åå¯¼å…¥ è‡ªåŠ¨æ‰§è¡Œ init()
)

var db *sql.DB

func initMySQL() (err error) {
 //DSN (Data Source Name)
 dsn := "root:12345678@tcp(127.0.0.1:3306)/sql_test"
 // æ³¨æ„ï¼šè¦åˆå§‹åŒ–å…¨å±€çš„ db å¯¹è±¡ï¼Œä¸è¦æ–°å£°æ˜ä¸€ä¸ª db å˜é‡
 db, err = sql.Open("mysql", dsn) // åªå¯¹æ ¼å¼è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸ä¼šçœŸæ­£è¿æ¥æ•°æ®åº“
 if err != nil {
  return err
 }

 // Ping éªŒè¯ä¸æ•°æ®åº“çš„è¿æ¥æ˜¯å¦ä»å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶åœ¨å¿…è¦æ—¶å»ºç«‹è¿æ¥ã€‚
 err = db.Ping()
 if err != nil {
  fmt.Printf("connect to db failed, err: %v\n", err)
  return err
 }
 // æ•°å€¼éœ€è¦æ ¹æ®ä¸šåŠ¡å…·ä½“æƒ…å†µæ¥ç¡®å®š
 db.SetConnMaxLifetime(time.Second * 10) // è®¾ç½®å¯ä»¥é‡ç”¨è¿æ¥çš„æœ€é•¿æ—¶é—´
 db.SetConnMaxIdleTime(time.Second * 5)  // è®¾ç½®è¿æ¥å¯èƒ½å¤„äºç©ºé—²çŠ¶æ€çš„æœ€é•¿æ—¶é—´
 db.SetMaxOpenConns(200)                 // è®¾ç½®ä¸æ•°æ®åº“çš„æœ€å¤§æ‰“å¼€è¿æ¥æ•°
 db.SetMaxIdleConns(10)                  //  è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­çš„æœ€å¤§è¿æ¥æ•°
 return nil
}

type user struct {
 id   int
 age  int
 name string
}

// é¢„å¤„ç†æ’å…¥
func prepareInsertDemo() {
 sqlStr := "INSERT INTO user(name, age) VALUES (?,?)"
 // ä¸ºä»¥åçš„æŸ¥è¯¢æˆ–æ‰§è¡Œåˆ›å»ºé¢„å‡†å¤‡è¯­å¥ã€‚
 // å¯ä»¥ä»è¿”å›çš„è¯­å¥å¹¶å‘è¿è¡Œå¤šä¸ªæŸ¥è¯¢æˆ–æ‰§è¡Œã€‚
 // å½“ä¸å†éœ€è¦è¯­å¥æ—¶ï¼Œè°ƒç”¨æ–¹å¿…é¡»è°ƒç”¨è¯­å¥çš„ Close æ–¹æ³•ã€‚
 stmt, err := db.Prepare(sqlStr)
 if err != nil {
  fmt.Printf("prepare failed, err:%v\n", err)
  return
 }
 defer stmt.Close()
 _, err = stmt.Exec("æ˜­å›", 12)
 if err != nil {
  fmt.Printf("insert failed, err:%v\n", err)
  return
 }
 _, err = stmt.Exec("é»›ç‰", 16)
 if err != nil {
  fmt.Printf("insert failed, err:%v\n", err)
  return
 }
 fmt.Println("insert success.")
}

func main() {
 if err := initMySQL(); err != nil {
  fmt.Printf("connect to db failed, err: %v\n", err)
 }
 // æ£€æŸ¥å®Œé”™è¯¯ä¹‹åæ‰§è¡Œï¼Œç¡®ä¿ db ä¸ä¸º nil
 // Close() ç”¨æ¥é‡Šæ”¾æ•°æ®åº“è¿æ¥ç›¸å…³çš„èµ„æº
 // Close å°†å…³é—­æ•°æ®åº“å¹¶é˜»æ­¢å¯åŠ¨æ–°æŸ¥è¯¢ã€‚å…³é—­ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨ä¸Šå·²å¼€å§‹å¤„ç†çš„æ‰€æœ‰æŸ¥è¯¢å®Œæˆã€‚
 defer db.Close()

 fmt.Println("connect to database success")
 // db.xx() å»ä½¿ç”¨æ•°æ®åº“æ“ä½œ...
 
 // MySQLé¢„å¤„ç† æ’å…¥æ•°æ®
 prepareInsertDemo()
}

```

#### è¿è¡Œ

```bash
Code/go/mysql_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go run main.go
connect to database success
insert success.

Code/go/mysql_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ 
```

#### SQL æŸ¥è¯¢ æ’å…¥ç»“æœ

```sql
mysql> select * from user;
+----+--------+------+
| id | name   | age  |
+----+--------+------+
|  1 | å°ä¹”   |   16 |
|  2 | å°ä¹”   |   12 |
|  5 | æ˜­å›   |   12 |
|  6 | é»›ç‰   |   16 |
+----+--------+------+
4 rows in set (0.00 sec)

mysql>

```

## ä¸‰ã€SQLæ³¨å…¥é—®é¢˜

### é—®ï¼šä»€ä¹ˆæ˜¯SQLæ³¨å…¥é—®é¢˜ï¼Ÿ

#### ChatGPT ç­”

SQLæ³¨å…¥ï¼ˆSQL Injectionï¼‰æ˜¯ä¸€ç§å¸¸è§çš„å®‰å…¨æ¼æ´ï¼ŒæŒ‡çš„æ˜¯æ”»å‡»è€…é€šè¿‡åœ¨åº”ç”¨ç¨‹åºçš„ç”¨æˆ·è¾“å…¥ä¸­æ’å…¥æ¶æ„çš„SQLä»£ç ï¼Œä»è€Œåˆ©ç”¨åº”ç”¨ç¨‹åºå¯¹æ•°æ®åº“çš„ä¸å½“å¤„ç†ï¼Œæ‰§è¡Œæœªç»æˆæƒçš„æ•°æ®åº“æ“ä½œã€‚

SQLæ³¨å…¥æ”»å‡»é€šå¸¸å‘ç”Ÿåœ¨ä½¿ç”¨åŠ¨æ€æ„å»ºSQLè¯­å¥çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¾‹å¦‚Webåº”ç”¨ç¨‹åºã€‚æ”»å‡»è€…åˆ©ç”¨åº”ç”¨ç¨‹åºæ²¡æœ‰æ­£ç¡®éªŒè¯ã€è¿‡æ»¤æˆ–è½¬ä¹‰ç”¨æˆ·è¾“å…¥çš„æ•°æ®ï¼Œå°†æ¶æ„çš„SQLä»£ç æ’å…¥åˆ°æŸ¥è¯¢è¯­å¥ä¸­ã€‚

æ”»å‡»è€…å¯ä»¥åˆ©ç”¨SQLæ³¨å…¥é—®é¢˜è¿›è¡Œå„ç§æ¶æ„è¡Œä¸ºï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹æƒ…å†µï¼š

1. ç»•è¿‡èº«ä»½éªŒè¯ï¼šé€šè¿‡æ³¨å…¥æ¶æ„çš„SQLä»£ç ï¼Œæ”»å‡»è€…å¯ä»¥ç»•è¿‡åº”ç”¨ç¨‹åºçš„èº«ä»½éªŒè¯æœºåˆ¶ï¼Œä»¥ç®¡ç†å‘˜æˆ–å…¶ä»–ç‰¹æƒç”¨æˆ·çš„èº«ä»½æ‰§è¡Œæ“ä½œã€‚
2. æ•°æ®æ³„éœ²ï¼šæ”»å‡»è€…å¯ä»¥é€šè¿‡æ³¨å…¥SELECTè¯­å¥ï¼Œè·å–åº”ç”¨ç¨‹åºæœªæˆæƒè®¿é—®çš„æ•°æ®ï¼ŒåŒ…æ‹¬æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·å¯†ç ã€ä¸ªäººä¿¡æ¯ç­‰ï¼‰ã€‚
3. æ•°æ®ç¯¡æ”¹ï¼šæ”»å‡»è€…å¯ä»¥é€šè¿‡æ³¨å…¥UPDATEæˆ–DELETEè¯­å¥ï¼Œä¿®æ”¹æˆ–åˆ é™¤æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œç ´åæ•°æ®å®Œæ•´æ€§ã€‚
4. æ‰§è¡Œä»»æ„ä»£ç ï¼šæ”»å‡»è€…å¯ä»¥é€šè¿‡æ³¨å…¥æ¶æ„çš„SQLä»£ç ï¼Œæ‰§è¡Œä»»æ„çš„æ•°æ®åº“æ“ä½œæˆ–å…¶ä»–ç³»ç»Ÿå‘½ä»¤ï¼Œå¯¼è‡´ç³»ç»Ÿå´©æºƒã€æœåŠ¡æ‹’ç»æˆ–å…¶ä»–å®‰å…¨é—®é¢˜ã€‚

ä¸ºäº†é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ï¼Œå¼€å‘äººå‘˜åº”è¯¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ–é¢„å¤„ç†è¯­å¥ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ–é¢„å¤„ç†è¯­å¥å¯ä»¥å°†å‚æ•°å€¼ä¸SQLè¯­å¥åˆ†å¼€å¤„ç†ï¼Œç¡®ä¿è¾“å…¥æ•°æ®è¢«æ­£ç¡®è½¬ä¹‰å’Œå¤„ç†ï¼Œé¿å…äº†ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥åˆ°SQLè¯­å¥ä¸­çš„é—®é¢˜ã€‚
- è¾“å…¥éªŒè¯ä¸è¿‡æ»¤ï¼šå¯¹ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œä¸¥æ ¼çš„éªŒè¯å’Œè¿‡æ»¤ï¼Œç¡®ä¿åªæ¥å—ç¬¦åˆé¢„æœŸçš„æ•°æ®æ ¼å¼å’ŒèŒƒå›´ï¼Œå¹¶åœ¨å¿…è¦æ—¶è¿›è¡Œè½¬ä¹‰å¤„ç†ã€‚
- æœ€å°æƒé™åŸåˆ™ï¼šåº”ç”¨ç¨‹åºåœ¨è¿æ¥æ•°æ®åº“æ—¶ï¼Œä½¿ç”¨å…·æœ‰æœ€ä½æƒé™çš„æ•°æ®åº“ç”¨æˆ·ï¼Œä»…å…·å¤‡æ‰§è¡Œå¿…è¦æ“ä½œçš„æƒé™ã€‚
- å®‰å…¨é…ç½®ï¼šç¡®ä¿æ•°æ®åº“å’Œåº”ç”¨ç¨‹åºçš„å®‰å…¨é…ç½®ï¼ŒåŒ…æ‹¬ç¦ç”¨ä¸å¿…è¦çš„æ•°æ®åº“åŠŸèƒ½ã€é™åˆ¶ç½‘ç»œè®¿é—®ã€å®šæœŸæ›´æ–°æ•°æ®åº“è½¯ä»¶ç­‰ã€‚

é€šè¿‡é‡‡å–è¿™äº›å®‰å…¨æªæ–½ï¼Œå¯ä»¥æœ‰æ•ˆå‡è½»SQLæ³¨å…¥æ”»å‡»çš„é£é™©ï¼Œæå‡åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚

#### æ³¨æ„ï¼šä¸è¦è‡ªå·±æ‹¼æ¥SQLè¯­å¥ï¼Œä¸è¦ç›¸ä¿¡ç”¨æˆ·è¾“å…¥çš„å†…å®¹æ˜¯å®‰å…¨çš„ã€åˆæ³•çš„

### ä¾‹å­

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†ä¸€ä¸ªå­˜åœ¨SQLæ³¨å…¥æ¼æ´çš„æƒ…å†µï¼Œå¹¶ä½¿ç”¨Goè¯­è¨€æ¥æ¼”ç¤ºå¦‚ä½•é¢„é˜²æ³¨å…¥é—®é¢˜ï¼š

```go
import (
 "database/sql"
 "fmt"
 "log"

 _ "github.com/go-sql-driver/mysql"
)

func main() {
 db, err := sql.Open("mysql", "username:password@tcp(hostname:port)/database")
 if err != nil {
  log.Fatal(err)
 }
 defer db.Close()

 // å‡è®¾ç”¨æˆ·è¾“å…¥çš„å‚æ•°
 username := "admin' OR 1=1 --"
 password := "123456"

 // æ„å»ºSQLæŸ¥è¯¢è¯­å¥
 query := fmt.Sprintf("SELECT * FROM users WHERE username = '%s' AND password = '%s'", username, password)

 // æ‰§è¡ŒæŸ¥è¯¢
 rows, err := db.Query(query)
 if err != nil {
  log.Fatal(err)
 }
 defer rows.Close()

 // å¤„ç†æŸ¥è¯¢ç»“æœ
 for rows.Next() {
  // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
  var id int
  var username string
  var password string
  err := rows.Scan(&id, &username, &password)
  if err != nil {
   log.Fatal(err)
  }
  fmt.Println(id, username, password)
 }

 if err = rows.Err(); err != nil {
  log.Fatal(err)
 }
}

```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·è¾“å…¥çš„`username`å‚æ•°ä¸º`admin' OR 1=1 --`ï¼Œè¿™æ˜¯ä¸€ç§å¸¸è§çš„æ³¨å…¥å°è¯•ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨å­—ç¬¦ä¸²æ’å€¼çš„æ–¹å¼æ„å»ºäº†ä¸€ä¸ªSQLæŸ¥è¯¢è¯­å¥ï¼Œå°†ç”¨æˆ·è¾“å…¥çš„å‚æ•°ç›´æ¥åµŒå…¥åˆ°SQLè¯­å¥ä¸­ã€‚

è¿™ç§æ„å»ºSQLè¯­å¥çš„æ–¹å¼å­˜åœ¨SQLæ³¨å…¥æ¼æ´ã€‚æ”»å‡»è€…å¯ä»¥åœ¨`username`å‚æ•°ä¸­æ’å…¥æ¶æ„çš„SQLä»£ç ï¼Œä½¿æŸ¥è¯¢è¯­å¥çš„é€»è¾‘è¢«ç ´åã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ`1=1`æ¡ä»¶å°†å§‹ç»ˆä¸ºçœŸï¼Œç»•è¿‡äº†æ­£å¸¸çš„èº«ä»½éªŒè¯ã€‚

ä¸ºäº†é˜²æ­¢SQLæ³¨å…¥ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨é¢„å¤„ç†è¯­å¥æˆ–å‚æ•°åŒ–æŸ¥è¯¢ã€‚ä»¥ä¸‹æ˜¯ä¿®å¤SQLæ³¨å…¥æ¼æ´çš„ç¤ºä¾‹ä»£ç ï¼š

```go
import (
 "database/sql"
 "fmt"
 "log"

 _ "github.com/go-sql-driver/mysql"
)

func main() {
 db, err := sql.Open("mysql", "username:password@tcp(hostname:port)/database")
 if err != nil {
  log.Fatal(err)
 }
 defer db.Close()

 // å‡è®¾ç”¨æˆ·è¾“å…¥çš„å‚æ•°
 username := "admin' OR 1=1 --"
 password := "123456"

 // ä½¿ç”¨é¢„å¤„ç†è¯­å¥
 stmt, err := db.Prepare("SELECT * FROM users WHERE username = ? AND password = ?")
 if err != nil {
  log.Fatal(err)
 }
 defer stmt.Close()

 // æ‰§è¡ŒæŸ¥è¯¢
 rows, err := stmt.Query(username, password)
 if err != nil {
  log.Fatal(err)
 }
 defer rows.Close()

 // å¤„ç†æŸ¥è¯¢ç»“æœ
 for rows.Next() {
  // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
  var id int
  var username string
  var password string
  err := rows.Scan(&id, &username, &password)
  if err != nil {
   log.Fatal(err)
  }
  fmt.Println(id, username, password)
 }

 if err = rows.Err

```

### ä¾‹å­äºŒ

```go
package main

import (
 "database/sql"
 "fmt"
 "time"

 _ "github.com/go-sql-driver/mysql" // åŒ¿åå¯¼å…¥ è‡ªåŠ¨æ‰§è¡Œ init()
)

var db *sql.DB

func initMySQL() (err error) {
 //DSN (Data Source Name)
 dsn := "root:12345678@tcp(127.0.0.1:3306)/sql_test"
 // æ³¨æ„ï¼šè¦åˆå§‹åŒ–å…¨å±€çš„ db å¯¹è±¡ï¼Œä¸è¦æ–°å£°æ˜ä¸€ä¸ª db å˜é‡
 db, err = sql.Open("mysql", dsn) // åªå¯¹æ ¼å¼è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸ä¼šçœŸæ­£è¿æ¥æ•°æ®åº“
 if err != nil {
  return err
 }

 // Ping éªŒè¯ä¸æ•°æ®åº“çš„è¿æ¥æ˜¯å¦ä»å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶åœ¨å¿…è¦æ—¶å»ºç«‹è¿æ¥ã€‚
 err = db.Ping()
 if err != nil {
  fmt.Printf("connect to db failed, err: %v\n", err)
  return err
 }
 // æ•°å€¼éœ€è¦æ ¹æ®ä¸šåŠ¡å…·ä½“æƒ…å†µæ¥ç¡®å®š
 db.SetConnMaxLifetime(time.Second * 10) // è®¾ç½®å¯ä»¥é‡ç”¨è¿æ¥çš„æœ€é•¿æ—¶é—´
 db.SetConnMaxIdleTime(time.Second * 5)  // è®¾ç½®è¿æ¥å¯èƒ½å¤„äºç©ºé—²çŠ¶æ€çš„æœ€é•¿æ—¶é—´
 db.SetMaxOpenConns(200)                 // è®¾ç½®ä¸æ•°æ®åº“çš„æœ€å¤§æ‰“å¼€è¿æ¥æ•°
 db.SetMaxIdleConns(10)                  //  è®¾ç½®ç©ºé—²è¿æ¥æ± ä¸­çš„æœ€å¤§è¿æ¥æ•°
 return nil
}

type user struct {
 id   int
 age  int
 name string
}

// sqlæ³¨å…¥ç¤ºä¾‹
func sqlInjectDemo(name string) {
 sqlStr := fmt.Sprintf("select id, name, age from user where name='%s'", name)
 fmt.Printf("SQL: %s\n", sqlStr)
 var u user
 err := db.QueryRow(sqlStr).Scan(&u.id, &u.name, &u.age)
 if err != nil {
  fmt.Printf("exec failed, err: %v\n", err)
  return
 }
 fmt.Printf("user: %#v\n", u)
}

func main() {
 if err := initMySQL(); err != nil {
  fmt.Printf("connect to db failed, err: %v\n", err)
 }
 // æ£€æŸ¥å®Œé”™è¯¯ä¹‹åæ‰§è¡Œï¼Œç¡®ä¿ db ä¸ä¸º nil
 // Close() ç”¨æ¥é‡Šæ”¾æ•°æ®åº“è¿æ¥ç›¸å…³çš„èµ„æº
 // Close å°†å…³é—­æ•°æ®åº“å¹¶é˜»æ­¢å¯åŠ¨æ–°æŸ¥è¯¢ã€‚å…³é—­ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨ä¸Šå·²å¼€å§‹å¤„ç†çš„æ‰€æœ‰æŸ¥è¯¢å®Œæˆã€‚
 defer db.Close()

 fmt.Println("connect to database success")
 // db.xx() å»ä½¿ç”¨æ•°æ®åº“æ“ä½œ...
 
 // SQL æ³¨å…¥
 //sqlInjectDemo("é»›ç‰")
 //  select id, name, age from user where name='xxx ' or 1=1#'
 sqlInjectDemo("xxx ' or 1=1#")
}

```

#### è¿è¡Œ

```bash
âœ go run main.go
connect to database success
SQL:select id, name, age from user where name='é»›ç‰'
user: main.user{id:6, age:16, name:"é»›ç‰"}

Code/go/mysql_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go run main.go
connect to database success
SQL: select id, name, age from user where name='xxx ' or 1=1#'
user: main.user{id:1, age:16, name:"å°ä¹”"}

Code/go/mysql_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ 

```

## å››ã€SQL å ä½ç¬¦

ä¸åŒçš„æ•°æ®åº“ä½¿ç”¨ä¸åŒçš„å ä½ç¬¦è¯­æ³•ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸è§æ•°æ®åº“çš„å ä½ç¬¦è¯­æ³•ï¼š

1. MySQL ä½¿ç”¨é—®å·ï¼ˆ?ï¼‰ä½œä¸ºå ä½ç¬¦ã€‚

ç¤ºä¾‹ï¼š

```sql
SELECT * FROM table WHERE column = ?
```

2. PostgreSQL ä½¿ç”¨ç¾å…ƒç¬¦å·åŠ æ•°å­—ï¼ˆ$1ã€$2ã€$3...ï¼‰ä½œä¸ºå ä½ç¬¦ã€‚

ç¤ºä¾‹ï¼š

```sql
SELECT * FROM table WHERE column = $1
```

3. SQLite ä½¿ç”¨é—®å·ï¼ˆ?ï¼‰æˆ–å†’å·åŠ æ•°å­—ï¼ˆ:1ã€:2ã€:3...ï¼‰ä½œä¸ºå ä½ç¬¦ã€‚

ç¤ºä¾‹ï¼š

```sql
SELECT * FROM table WHERE column = ?
```

æˆ–

```sql
SELECT * FROM table WHERE column = :1
```

4. Oracle ä½¿ç”¨å†’å·åŠ æ•°å­—ï¼ˆ:1ã€:2ã€:3...ï¼‰ä½œä¸ºå ä½ç¬¦ã€‚

ç¤ºä¾‹ï¼š

```sql
SELECT * FROM table WHERE column = :1
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå ä½ç¬¦çš„è¯­æ³•å¯èƒ½ä¼šå› ä¸åŒçš„æ•°æ®åº“é©±åŠ¨ç¨‹åºæˆ–æ¡†æ¶è€Œç•¥æœ‰å·®å¼‚ã€‚å› æ­¤ï¼Œä½¿ç”¨æ•°æ®åº“é©±åŠ¨ç¨‹åºçš„æ–‡æ¡£æˆ–æ¡†æ¶çš„æŒ‡å—æ¥ç¡®å®šæ­£ç¡®çš„å ä½ç¬¦è¯­æ³•æ˜¯å¾ˆé‡è¦çš„ã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ï¼Œå¦‚GORMã€Hibernateç­‰ï¼Œå®ƒä»¬å¯ä»¥åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­ä½¿ç”¨ç»Ÿä¸€çš„è¯­æ³•å’Œæ–¹å¼æ¥è¡¨ç¤ºå ä½ç¬¦ï¼Œä»¥æä¾›æ›´é«˜çº§çš„æŸ¥è¯¢åŠŸèƒ½å’Œæ›´å¥½çš„è·¨æ•°æ®åº“å…¼å®¹æ€§ã€‚
