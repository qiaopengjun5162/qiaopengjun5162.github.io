+++
title = "探索Rust编程之道：从设计哲学到内存安全的学习笔记"
description = "探索Rust编程之道：从设计哲学到内存安全的学习笔记"
date = 2025-06-29T05:23:34Z
[taxonomies]
categories = ["Rust"]
tags = ["Rust"]
+++

<!-- more -->

# 探索Rust编程之道：从设计哲学到内存安全的学习笔记

在编程世界中，Rust以其内存安全、零成本抽象和高性能的特性迅速崛起，成为系统级编程的新宠。《Rust编程之道》不仅是一本技术书籍，更是一场探索Rust设计哲学与实践的旅程。本文将带你走进Rust的世界，从其语言特性到内存管理，梳理核心概念，助你快速上手这门新时代的编程语言！

本文基于《Rust编程之道》整理的学习笔记，深入剖析了Rust语言的主要特性，包括内存安全、零成本抽象和线程安全等设计哲学。文章从Rust的语言背景、设计理念入手，结合类型系统、所有权机制和并发模型，系统梳理了Rust的核心知识点。通过对《Rust编程之道》的章节概述和第一章内容的提炼，帮助读者理解Rust为何成为现代系统编程的首选语言，并为进一步学习提供清晰路径。

## 主要内容

### Rust语言的主要特点

Rust是一门现代系统级编程语言，具备以下核心特性：  

- 系统级语言：适用于底层开发，直接操控硬件资源。  
- 无垃圾回收（GC）：避免性能开销，确保高效运行。  
- 基于LLVM：利用LLVM编译框架实现跨平台优化。  
- 内存安全：通过所有权和借用机制杜绝内存错误。  
- 强类型+静态类型：编译期检查类型安全，减少运行时错误。  
- 混合编程范式：融合命令式、函数式和面向对象编程风格。  
- 零成本抽象：提供高级抽象而无运行时性能代价。  
- 线程安全：内置并发模型，避免数据竞争。

这些特性使Rust在区块链、游戏、WebAssembly、机器学习等领域得到广泛应用。

### 程序员的快乐

何谓快乐？真正的快乐不仅仅是写代码时的“酸爽”，更应该是代码部署到生产环境之后的“安稳”。

### 程序的三大定律

- 程序必须正确
- 程序必须可维护，但不能违反第一条定律
- 程序必须高效，但不能违反前两条定律

### 程序的正确性

- 程序满足了实际的问题需求
- 满足了自身的程序规约

### 如何保证程序的正确性

- 通过对程序的各种测试、断言和错误处理机制，来保证其满足实际的问题需求。
- 通过较为成熟的类型理论，来保证程序自身的规约正确。

Rust语言对程序的三定律支持的恰到好处。
Rust通过类型系统、所有权机制和编译期检查，完美支持这三大定律，确保程序“正确、可维护、高效”。

目前Rust被陆续应用在区块链、游戏、WebAssembly 技术、机器学习，分布式数据库、网络服务基础设施、Web框架、操作系统和嵌入式等领域。

## 《Rust编程之道》特点与章节概述

Rust 学习曲线陡的根本原因在于 Rust 语言融合了多种语言特性和多种编程范式。

从Rust 的设计哲学出发，牢牢把握它的设计一致性，就可以把它的所有特性都串起来，从而达到掌握它的目的。

### 《Rust 编程之道》特点

- 从设计哲学出发，探索 Rust 语言的内在一致性。
  - 设计哲学是一门优秀编程语言报错语言一致性的关键所在。
  - 设计哲学是语言特性和语法要素设计的诱因和准则。
- 从源码分析入手，探索 Rust 地道的编程风格。
- 从工程角度着手，探索 Rust 对健壮性的支持。
- 从底层原理开始，探索 Rust 内存安全的本质。

### 章节概述

第一章 新时代的语言

第二章 语言精要

第三章 类型系统

第四章 内存管理

第五章 所有权系统

第六章 函数、闭包和迭代器

第七章 结构化编程

第八章 字符串与集合类型

第九章 构建健壮的程序

第十章 模块化编程

第十一章 安全并发

第十二章 元编程

第十三章 超越安全的边界

## 第 1 章 新时代的语言

不谋全局者，不足谋一域。

一门好的语言是有内涵哲学的语言，它表里如一，有所想，有所为。

### 两个难题

- 很难编写内存安全的代码。
- 很难编写线程安全的代码。

Ada 语言

2006 年，自称 “职业编程语言工程师” 的 Graydon Hoare（简称为 GH），开始开发一门名为 Rust 的编程语言。

什么是 “职业编程语言工程师”？用 GH 自己的话说，职业编程语言工程师的日常工作就是给其他语言开发编译器和工具集，但并未参与这些语言本身的设计。

### GH 对 Rust 语言的期望

- 必须是更加安全、不易崩溃的，尤其在操作内存时，这一点更为重要。
- 不需要有垃圾回收这样的系统，不能为了内存安全而引入性能负担。
- 不是一门仅仅拥有一个主要特性的语言，而应该拥有一系列的广泛特性，这些特性之间又不乏一致性。这些特性可以很好地相互协作，从而使该语言更容易编写、维护和调试，让程序员写出更安全、更高效的代码。

Rust 是一门同时追求安全、并发和性能的现代系统级编程语言。

### 设计哲学

- 内存安全
- 零成本抽象
- 实用性

有些事现在不做，一辈子都没机会再做了。    -- 练习曲[2006]

“程序即类型证明”

### 类型系统的好处

- 允许编译器侦测无意义甚至无效的代码，暴露程序中隐含的错误。
- 可以为编译器提供有意义的类型信息，帮助优化代码。
- 可以增强代码的可读性，更直白地阐述开发者的意图。
- 提供了一定程度的高级抽象，提升开发效率。

简单来说，类型安全是指类型系统可以保证程序的行为是意义明确、不出错的。

未定义行为（Undefined Behavior）：发生了语言规范规定之外的行为。

Rust语言如果想保证内存安全，首先要做的就是保证类型安全。

类型安全的语言：OCaml、Haskell

类型系统的作用是定义编程语言中值和表达式的类型，将它们归类，赋予它们不同的行为，指导它们如何相互作用。

### 内存安全

什么是内存安全？简单来说，就是不会出现内存访问错误。

只有当程序访问未定义内存的时候才会产生内存错误。

一般来说，发生以下几种情况就会产生内存错误：

- 引用空指针
- 使用未初始化内存
- 释放后使用，也就是使用悬垂指针
- 缓冲区溢出，比如数组越界
- 非法释放已经释放过的指针或未分配的指针，也就是重复释放

### Rust 语言安全内存管理模型

- 所有权系统
  - 每个被分配的内存都有一个独占其所有权的指针
  - 只有当该指针被销毁时，其对应的内存才能随之被释放
  - RAII 机制
- 借用和生命周期
  - 每个变量都有其生命周期，一旦超出生命周期，变量就会被自动释放
  - 如果是借用，则可以通过标记生命周期参数供编译器检查的方式，防止出现悬垂指针，也就是释放后使用的情况。

### Rust 从 Haskell 的类型系统借鉴了以下特性

- 没有空指针
- 默认不可变
- 表达式
- 高阶函数
- 代数数据类型
- 模式匹配
- 泛型
- Trait 和关联类型
- 本地类型推导

### Rust 独有的特性

- 仿射类型（Affine Type），该类型用来表达 Rust所有权中的 Move 语义
- 借用、生命周期

Rust 编译器可以在编译期对类型进行检查，看其是否满足安全内存模型，在编译器就能发现内存不安全问题，有效地阻止未定义行为的发生。

Rust 编译器会通过静态检查分析，在编译器就检查出多线程并发代码中所有的数据竞争问题。

### 零成本抽象

Rust 的抽象并不会存在运行时性能开销，这一切都是在编译期完成的。

Rust 中零成本抽象的基石就是泛型和Trait。

### 实用性

如何评价一门编程语言的实用性？

- 实践性
- 有益性
- 稳定性

日常开发中一般有三类非正常情况：失败、错误和异常。

Rust 语言针对这三类非正常情况分别提供了专门的处理方式，让开发者可以分情况去选择。

- 对于失败的情况，可以使用断言工具。
- 对于错误，Rust 提供了基于返回值的分层错误处理方式，比如 Option<T> 可以用来处理可能存在空值的情况，而 Result<T> 就专门用来处理可以被合理解决并需要传播的错误。
- 对于异常，Rust 将其看作无法被合理解决的问题，提供了线程恐慌机制，在发生异常的时候，线程可以安全地退出。

Safe Rust 表示开发者将信任编译器能够在编译时保证安全，而 Unsafe Rust 表示让编译器信任开发者有能力保证安全。

Rust 代码是以包（crate）为编译和分发单位的

### 学习Rust

- 保持初学者心态
- 先学习概念再动手实践
- 把编译器当作朋友

2015年，Rust发布1.0版本

2018年，Rust团队推出了新的大版本（edition）计划

Rust 2015 版本

Rust 2018 版本

Rust 2021 版本
  
Rust 2024 版本
  
Rust的编译器可以方便地管理版本的兼容性

![Rust 中概念层次结构梳理图](/images/rust_code_001.png)

Rust 团队维护三个发行分支：稳定版（Stable）、测试版（Beta）和开发版（Nightly）。

其中稳定版和测试版每6周发布一次。

标记为不稳定（Unstable）和特性开关（Feature Gate）的语言特性或标准库特性只能在开发版中使用。

Rust 编译器是一个编译前端，它的工作是对代码进行词法分析、语法分析、类型检查、生成中间代码、进行独立于目标机器的优化等工作。

使用 LLVM 作为编译器后端代码生成框架，则可以利用 LLVM 兼容多个目标机器的特性，实现跨平台编译和优化等工作。

在用户使用Rust时，大多数时候无须考虑各个目标机器平台的特有性质，基本上可以做到一次编写，到处运行。

Rust 源码经过分词和解析，生成AST（抽象语法树）。

然后把 AST 进一步简化处理为 HIR（High-level IR），目的是让编译器更方便地做类型检查。

HIR 会进一步被编译为 MIR（Middle IR），这是一种中间表示。

最终，MIR 会被翻译为 LLVM IR，然后被 LLVM 的处理编译为能在各个平台上运行的目标机器码。

## 总结

Rust作为一门追求安全、并发和性能的现代系统级编程语言，其设计哲学和内存管理模型为开发者提供了强大的工具和保障。通过本文的学习笔记，我们不仅了解了Rust的语言特性、设计理念，还掌握了其类型系统、所有权机制和并发模型的核心思想。希望这些内容能为你的Rust学习之旅提供坚实的基础，助你在编程之路上更进一步！
