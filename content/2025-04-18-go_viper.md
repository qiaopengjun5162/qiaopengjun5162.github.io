+++
title = "Go å¼€å‘å¿…å¤‡ï¼šè§£é” Viper é…ç½®ç®¡ç†çš„æ­£ç¡®å§¿åŠ¿"
description = "Go å¼€å‘å¿…å¤‡ï¼šè§£é” Viper é…ç½®ç®¡ç†çš„æ­£ç¡®å§¿åŠ¿"
date = 2025-04-18T13:42:39Z
[taxonomies]
categories = ["Go", "Viper"]
tags = ["Go", "Viper"]
+++

<!-- more -->

# Go å¼€å‘å¿…å¤‡ï¼šè§£é” Viper é…ç½®ç®¡ç†çš„æ­£ç¡®å§¿åŠ¿
ä½ æ˜¯å¦ä¸º Go åº”ç”¨çš„é…ç½®ç®¡ç†å¤´ç–¼è¿‡ï¼ŸJSONã€YAMLã€ç¯å¢ƒå˜é‡ã€å‘½ä»¤è¡Œå‚æ•°â€¦â€¦å„ç§é…ç½®æ–¹å¼è®©äººçœ¼èŠ±ç¼­ä¹±ï¼åˆ«æ…Œï¼ŒViper æ¥äº†ï¼ä½œä¸º Go ç”Ÿæ€ä¸­çš„é…ç½®ç®¡ç†ç¥å™¨ï¼ŒViper ä¸ä»…æ”¯æŒå¤šç§é…ç½®æ ¼å¼ï¼Œè¿˜èƒ½å®æ—¶ç›‘æ§å˜æ›´ã€ä¼˜é›…å¤„ç†åµŒå¥—é”®ï¼Œè®©ä½ çš„ä»£ç æ›´ç®€æ´ï¼Œå¼€å‘æ›´é«˜æ•ˆã€‚æœ¬æ–‡å°†å¸¦ä½ ä»é›¶ä¸Šæ‰‹ Viperï¼Œé€šè¿‡å®æˆ˜ä»£ç å’Œå®ç”¨æŠ€å·§ï¼Œè§£é”é…ç½®ç®¡ç†çš„æ­£ç¡®å§¿åŠ¿ã€‚ä¸ç®¡ä½ æ˜¯ Go æ–°æ‰‹è¿˜æ˜¯è€å¸æœºï¼Œè¿™ç¯‡å¹²è´§éƒ½èƒ½è®©ä½ å¤§å‘¼è¿‡ç˜¾ï¼å¿«æ¥ä¸€èµ·æ¢ç´¢å§ï¼

Viper æ˜¯ Go å¼€å‘ä¸­ä¸å¯æˆ–ç¼ºçš„é…ç½®ç®¡ç†åˆ©å™¨ï¼æœ¬æ–‡å°†å¸¦ä½ å…¨é¢æŒæ¡ Viper çš„æ ¸å¿ƒåŠŸèƒ½ï¼šä»è®¾ç½®é»˜è®¤å€¼ã€åŠ è½½ JSON/YAML ç­‰é…ç½®æ–‡ä»¶ï¼Œåˆ°å®æ—¶ç›‘æ§é…ç½®å˜æ›´ã€å¤„ç†ç¯å¢ƒå˜é‡å’Œå‘½ä»¤è¡Œæ ‡å¿—ï¼Œç”šè‡³é›†æˆè¿œç¨‹é”®å€¼å­˜å‚¨ï¼Œåº”æœ‰å°½æœ‰ï¼é€šè¿‡æ¸…æ™°çš„ä»£ç ç¤ºä¾‹å’Œå®æˆ˜æŠ€å·§ï¼Œä½ å°†å­¦ä¼šå¦‚ä½•ç”¨ Viper ç®€åŒ– Go åº”ç”¨çš„é…ç½®ç®¡ç†ã€‚æ— è®ºä½ æ˜¯æƒ³å¿«é€Ÿä¸Šæ‰‹è¿˜æ˜¯è¿›é˜¶ä¼˜åŒ–ï¼Œè¿™ç¯‡æ•™ç¨‹éƒ½èƒ½è®©ä½ è½»æ¾æå®šé…ç½®éš¾é¢˜ï¼Œå¼€å‘æ•ˆç‡ç›´æ¥èµ·é£ï¼
## Viper ä»‹ç»

[Viper](https://github.com/spf13/viper)ï¼š<https://github.com/spf13/viper> 

### å®‰è£…

```bash
go get github.com/spf13/viper
```

### Viper æ˜¯ä»€ä¹ˆï¼Ÿ

Viper æ˜¯ä¸€ä¸ªé’ˆå¯¹ Go åº”ç”¨ç¨‹åºçš„å®Œæ•´é…ç½®è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬12-Factor åº”ç”¨ç¨‹åºã€‚å®ƒå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­å·¥ä½œï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†æ‰€æœ‰ç±»å‹çš„é…ç½®éœ€æ±‚å’Œæ ¼å¼ã€‚å®ƒæ”¯æŒ:

Viper is a complete configuration solution for Go applications including [12-Factor apps](https://12factor.net/#the_twelve_factors). It is designed to work within an application, and can handle all types of configuration needs and formats. It supports:

- setting defaults
- reading from JSON, TOML, YAML, HCL, envfile and Java properties config files
- live watching and re-reading of config files (optional)
- reading from environment variables
- reading from remote config systems (etcd or Consul), and watching changes
- reading from command line flags
- reading from buffer
- setting explicit values

Viper can be thought of as a registry for all of your applications configuration needs.

Viper å¯ä»¥è¢«è®¤ä¸ºæ˜¯æ»¡è¶³æ‰€æœ‰åº”ç”¨ç¨‹åºé…ç½®éœ€æ±‚çš„æ³¨å†Œè¡¨ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ Viperï¼Ÿ

åœ¨æ„å»ºç°ä»£åº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨ä¸éœ€è¦æ‹…å¿ƒé…ç½®æ–‡ä»¶æ ¼å¼; æ‚¨éœ€è¦ä¸“æ³¨äºæ„å»ºä»¤äººæ»¡æ„çš„è½¯ä»¶ã€‚Viper å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿçš„ã€‚

Viper å¯ä»¥ä¸ºä½ åšä»¥ä¸‹äº‹æƒ…:

1. Find, load, and unmarshal a configuration file in JSON, TOML, YAML, HCL, INI, envfile or Java properties formats.
2. Provide a mechanism to set default values for your different configuration options.
3. Provide a mechanism to set override values for options specified through command line flags.
4. Provide an alias system to easily rename parameters without breaking existing code.
5. Make it easy to tell the difference between when a user has provided a command line or config file which is the same as the default.

Viper uses the following precedence order. Each item takes precedence over the item below it:

- explicit call to `Set`
- flag
- env
- config
- key/value store
- default

**Important:** Viper configuration keys are case insensitive. There are ongoing discussions about making that optional.

é‡è¦æç¤º: Viper é…ç½®é”®æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ã€‚ç›®å‰æ­£åœ¨è®¨è®ºæ˜¯å¦å°†å…¶è®¾ç½®ä¸ºå¯é€‰çš„ã€‚

## Viper å®æ“ Putting Values into Viper

### å»ºç«‹é»˜è®¤å€¼

ä¸€ä¸ªå¥½çš„é…ç½®ç³»ç»Ÿå°†æ”¯æŒé»˜è®¤å€¼ã€‚å¯†é’¥ä¸éœ€è¦é»˜è®¤å€¼ï¼Œä½†å¦‚æœæ²¡æœ‰é€šè¿‡é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹é…ç½®æˆ–æ ‡å¿—è®¾ç½®å¯†é’¥ï¼Œåˆ™é»˜è®¤å€¼éå¸¸æœ‰ç”¨ã€‚

Examples:

```go
viper.SetDefault("ContentDir", "content")
viper.SetDefault("LayoutDir", "layouts")
viper.SetDefault("Taxonomies", map[string]string{"tag": "tags", "category": "categories"})
```

### è¯»å–é…ç½®æ–‡ä»¶

Viper éœ€è¦æœ€å°çš„é…ç½®ï¼Œè¿™æ ·å®ƒå°±çŸ¥é“åœ¨å“ªé‡ŒæŸ¥æ‰¾é…ç½®æ–‡ä»¶ã€‚Viper æ”¯æŒ JSONã€ TOMLã€ YAMLã€ HCLã€ INIã€ envfile å’Œ JavaProperties æ–‡ä»¶ã€‚Viper å¯ä»¥æœç´¢å¤šä¸ªè·¯å¾„ï¼Œä½†ç›®å‰å•ä¸ª Viper å®ä¾‹åªæ”¯æŒå•ä¸ªé…ç½®æ–‡ä»¶ã€‚Viper ä¸é»˜è®¤ä»»ä½•é…ç½®æœç´¢è·¯å¾„ï¼Œå°†é»˜è®¤å†³ç­–ç•™ç»™åº”ç”¨ç¨‹åºã€‚

ä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ Viper æœç´¢å’Œè¯»å–é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹ã€‚ä¸éœ€è¦ä»»ä½•ç‰¹å®šçš„è·¯å¾„ï¼Œä½†è‡³å°‘åº”è¯¥åœ¨éœ€è¦é…ç½®æ–‡ä»¶çš„åœ°æ–¹æä¾›ä¸€ä¸ªè·¯å¾„ã€‚

```go
viper.SetConfigName("config") // name of config file (without extension)
viper.SetConfigType("yaml") // REQUIRED if the config file does not have the extension in the name
viper.AddConfigPath("/etc/appname/")   // path to look for the config file in
viper.AddConfigPath("$HOME/.appname")  // call multiple times to add many search paths
viper.AddConfigPath(".")               // optionally look for config in the working directory
err := viper.ReadInConfig() // Find and read the config file
if err != nil { // Handle errors reading the config file
 panic(fmt.Errorf("fatal error config file: %w", err))
}
```

æ‚¨å¯ä»¥å¤„ç†æ²¡æœ‰å¦‚ä¸‹é…ç½®æ–‡ä»¶çš„ç‰¹å®šæƒ…å†µ:

```go
if err := viper.ReadInConfig(); err != nil {
 if _, ok := err.(viper.ConfigFileNotFoundError); ok {
  // Config file not found; ignore error if desired
 } else {
  // Config file was found but another error was produced
 }
}

// Config file found and successfully parsed
```

### å†™å…¥é…ç½®æ–‡ä»¶

ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–æ˜¯æœ‰ç”¨çš„ï¼Œä½†æœ‰æ—¶æ‚¨å¸Œæœ›å­˜å‚¨åœ¨è¿è¡Œæ—¶æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹ã€‚ä¸ºæ­¤ï¼Œæä¾›äº†ä¸€ç³»åˆ—å‘½ä»¤ï¼Œæ¯ä¸ªå‘½ä»¤éƒ½æœ‰è‡ªå·±çš„ç”¨é€”:

- WriteConfig-å°†å½“å‰ viper é…ç½®å†™å…¥é¢„å®šä¹‰çš„è·¯å¾„(å¦‚æœå­˜åœ¨)ã€‚å¦‚æœæ²¡æœ‰é¢„å®šä¹‰çš„è·¯å¾„å°±ä¼šå‡ºé”™ã€‚å°†è¦†ç›–å½“å‰é…ç½®æ–‡ä»¶(å¦‚æœå­˜åœ¨)ã€‚
- SafeWriteConfig-å°†å½“å‰ viper é…ç½®å†™å…¥é¢„å®šä¹‰çš„è·¯å¾„ã€‚å¦‚æœæ²¡æœ‰é¢„å®šä¹‰çš„è·¯å¾„å°±ä¼šå‡ºé”™ã€‚ä¸ä¼šè¦†ç›–å½“å‰é…ç½®æ–‡ä»¶(å¦‚æœå­˜åœ¨)ã€‚
- WriteConfigAs-å°†å½“å‰ viper é…ç½®å†™å…¥ç»™å®šçš„æ–‡ä»¶è·¯å¾„ã€‚å°†è¦†ç›–ç»™å®šçš„æ–‡ä»¶(å¦‚æœå­˜åœ¨)ã€‚
- SafeWriteConfigAs-å°†å½“å‰ viper é…ç½®å†™å…¥ç»™å®šçš„æ–‡ä»¶è·¯å¾„ã€‚ä¸ä¼šè¦†ç›–ç»™å®šçš„æ–‡ä»¶(å¦‚æœå­˜åœ¨)ã€‚

As a rule of the thumb, everything marked with safe won't overwrite any file, but just create if not existent, whilst the default behavior is to create or truncate.

æ ¹æ®ç»éªŒï¼Œæ‰€æœ‰æ ‡è®°ä¸º safe çš„æ–‡ä»¶éƒ½ä¸ä¼šè¦†ç›–ä»»ä½•æ–‡ä»¶ï¼Œåªæ˜¯åˆ›å»º(å¦‚æœä¸å­˜åœ¨çš„è¯) ï¼Œè€Œé»˜è®¤è¡Œä¸ºæ˜¯åˆ›å»ºæˆ–æˆªæ–­ã€‚

A small examples section:

```go
viper.WriteConfig() // writes current config to predefined path set by 'viper.AddConfigPath()' and 'viper.SetConfigName'
viper.SafeWriteConfig()
viper.WriteConfigAs("/path/to/my/.config")
viper.SafeWriteConfigAs("/path/to/my/.config") // will error since it has already been written
viper.SafeWriteConfigAs("/path/to/my/.other_config")
```

### ç›‘è§†å’Œé‡æ–°è¯»å–é…ç½®æ–‡ä»¶

Viper æ”¯æŒè®©åº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶å®æ—¶è¯»å–é…ç½®æ–‡ä»¶çš„èƒ½åŠ›ã€‚

éœ€è¦é‡æ–°å¯åŠ¨æœåŠ¡å™¨æ‰èƒ½ä½¿é…ç½®ç”Ÿæ•ˆçš„æ—¥å­å·²ç»ä¸€å»ä¸å¤è¿”äº†ï¼Œä½¿ç”¨ viper çš„åº”ç”¨ç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶è¯»å–é…ç½®æ–‡ä»¶çš„æ›´æ–°ï¼Œè€Œä¸”ä¸ä¼šé”™è¿‡ä»»ä½•ä¸€æ¬¡æ›´æ–°ã€‚

åªéœ€å‘Šè¯‰ viper å®ä¾‹ç›‘è§† Configã€‚æ‚¨è¿˜å¯ä»¥ä¸º Viper æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡å‘ç”Ÿæ›´æ”¹æ—¶è¿è¡Œè¯¥å‡½æ•°ã€‚

ç¡®ä¿åœ¨è°ƒç”¨ WatchConfig ()ä¹‹å‰æ·»åŠ äº†æ‰€æœ‰çš„ configPath

```go
viper.OnConfigChange(func(e fsnotify.Event) {
 fmt.Println("Config file changed:", e.Name)
})
viper.WatchConfig()
```

#### é…ç½®æ–‡ä»¶å®æ—¶åŠ è½½å®æ“

```go
package main

import (
 "fmt"
 "net/http"

 "github.com/fsnotify/fsnotify"
 "github.com/gin-gonic/gin"

 "github.com/spf13/viper"
)

func main() {
 // è®¾ç½®é»˜è®¤å€¼
 viper.SetDefault("fileDir", "./")
 // è¯»å–é…ç½®æ–‡ä»¶
 viper.SetConfigFile("./config.yaml")  // æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
 viper.SetConfigName("config")         // é…ç½®æ–‡ä»¶åç§°(æ— æ‰©å±•å)
 viper.SetConfigType("yaml")           // å¦‚æœé…ç½®æ–‡ä»¶çš„åç§°ä¸­æ²¡æœ‰æ‰©å±•åï¼Œåˆ™éœ€è¦é…ç½®æ­¤é¡¹
 viper.AddConfigPath("/etc/appname/")  // æŸ¥æ‰¾é…ç½®æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
 viper.AddConfigPath("$HOME/.appname") // å¤šæ¬¡è°ƒç”¨ä»¥æ·»åŠ å¤šä¸ªæœç´¢è·¯å¾„
 viper.AddConfigPath(".")              // è¿˜å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­æŸ¥æ‰¾é…ç½®

 err := viper.ReadInConfig() // æŸ¥æ‰¾å¹¶è¯»å–é…ç½®æ–‡ä»¶
 if err != nil {             // å¤„ç†è¯»å–é…ç½®æ–‡ä»¶çš„é”™è¯¯
  panic(fmt.Errorf("Fatal error config file: %s \n", err))
 }

 // å®æ—¶ç›‘æ§é…ç½®æ–‡ä»¶çš„å˜åŒ– WatchConfig å¼€å§‹ç›‘è§†é…ç½®æ–‡ä»¶çš„æ›´æ”¹ã€‚
 viper.WatchConfig()
 // OnConfigChangeè®¾ç½®é…ç½®æ–‡ä»¶æ›´æ”¹æ—¶è°ƒç”¨çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚
 // å½“é…ç½®æ–‡ä»¶å˜åŒ–ä¹‹åè°ƒç”¨çš„ä¸€ä¸ªå›è°ƒå‡½æ•°
 viper.OnConfigChange(func(e fsnotify.Event) {
  fmt.Println("Config file changed:", e.Name)
 })

 r := gin.Default()
 r.GET("/version", func(c *gin.Context) {
  // GetStringä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¿”å›ä¸é”®ç›¸å…³çš„å€¼ã€‚
  c.String(http.StatusOK, viper.GetString("version"))
 })
 r.Run()
}

```

è¿è¡Œå¹¶è®¿é—®ï¼š<http://127.0.0.1:8080/version>

```bash
Code/go/viper_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go run main.go 
[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.

[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
 - using env:   export GIN_MODE=release
 - using code:  gin.SetMode(gin.ReleaseMode)

[GIN-debug] GET    /version                  --> main.main.func2 (3 handlers)
[GIN-debug] [WARNING] You trusted all proxies, this is NOT safe. We recommend you to set a value.
Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies for details.
[GIN-debug] Environment variable PORT is undefined. Using port :8080 by default
[GIN-debug] Listening and serving HTTP on :8080
[GIN] 2023/06/18 - 11:42:10 | 200 |        39.5Âµs |       127.0.0.1 | GET      "/version"
[GIN] 2023/06/18 - 11:42:10 | 404 |         750ns |       127.0.0.1 | GET      "/favicon.ico"
Config file changed: /Users/qiaopengjun/Code/go/viper_demo/config.yaml
[GIN] 2023/06/18 - 11:43:41 | 200 |      17.459Âµs |       127.0.0.1 | GET      "/version"


```

config.yaml

```yaml
host: "127.0.0.1"
port: 8080
version: "v0.0.2"

mysql:
  host: "127.0.0.1"
  port: 3306
  dbname: "sql_demo"

```

è¿è¡Œä¹‹åï¼Œè®¿é—®ï¼š<http://127.0.0.1:8080/versionã€‚æ­¤æ—¶ç»“æœè¿”å›> v0.0.1

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306181147275.png)

ä¿®æ”¹ config.yaml æ–‡ä»¶ä¸­çš„versionä¸º "v0.0.2"åï¼Œæ§åˆ¶å°è¾“å‡º Config file changed: /Users/qiaopengjun/Code/go/viper_demo/config.yaml ã€‚é…ç½®æ–‡ä»¶å®æ—¶åŠ è½½ï¼Œè®¿é—®ï¼š<http://127.0.0.1:8080/versionã€‚æ­¤æ—¶ç»“æœè¿”å›> v0.0.2ã€‚

![](https://raw.githubusercontent.com/qiaopengjun5162/blogpicgo/master/img202306181150032.png)

### ä» io.Reader è¯»å–é…ç½®

Viper é¢„å®šä¹‰äº†è®¸å¤šé…ç½®æºï¼Œä¾‹å¦‚æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€æ ‡å¿—å’Œè¿œç¨‹ K/V å­˜å‚¨ï¼Œä½†æ˜¯æ‚¨å¹¶ä¸ç»‘å®šåˆ°å®ƒä»¬ã€‚æ‚¨è¿˜å¯ä»¥å®ç°è‡ªå·±æ‰€éœ€çš„é…ç½®æºï¼Œå¹¶å°†å…¶æä¾›ç»™ viperã€‚

```go
viper.SetConfigType("yaml") // or viper.SetConfigType("YAML")

// any approach to require this configuration into your program.
var yamlExample = []byte(`
Hacker: true
name: steve
hobbies:
- skateboarding
- snowboarding
- go
clothing:
  jacket: leather
  trousers: denim
age: 35
eyes : brown
beard: true
`)

viper.ReadConfig(bytes.NewBuffer(yamlExample))

viper.Get("name") // this would be "steve"
```

### è®¾ç½®è¦†ç›–

å®ƒä»¬å¯ä»¥æ¥è‡ªå‘½ä»¤è¡Œæ ‡å¿—ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªæ‚¨è‡ªå·±çš„åº”ç”¨ç¨‹åºé€»è¾‘ã€‚

```go
viper.Set("Verbose", true)
viper.Set("LogFile", LogFile)
```

### æ³¨å†Œå’Œä½¿ç”¨åˆ«å

åˆ«åå…è®¸å¤šä¸ªé”®å¼•ç”¨å•ä¸ªå€¼

```go
viper.RegisterAlias("loud", "Verbose")

viper.Set("verbose", true) // same result as next line
viper.Set("loud", true)   // same result as prior line

viper.GetBool("loud") // true
viper.GetBool("verbose") // true
```

### ä½¿ç”¨ç¯å¢ƒå˜é‡

Viper å®Œå…¨æ”¯æŒç¯å¢ƒå˜é‡ã€‚è¿™ä½¿[12-Factor apps](https://12factor.net/#the_twelve_factors)å¼€ç®±å³ç”¨ã€‚æœ‰äº”ç§æ–¹æ³•å¯ä»¥å¸®åŠ© ENV çš„å·¥ä½œ:

- `AutomaticEnv()`
- `BindEnv(string...) : error`
- `SetEnvPrefix(string)`
- `SetEnvKeyReplacer(string...) *strings.Replacer`
- `AllowEmptyEnv(bool)`

å½“ä½¿ç”¨ ENV å˜é‡æ—¶ï¼Œé‡è¦çš„æ˜¯è¦è®¤è¯†åˆ° Viper å°† ENV å˜é‡è§†ä¸ºåŒºåˆ†å¤§å°å†™çš„ã€‚

Viper æä¾›äº†ä¸€ç§æœºåˆ¶æ¥å°è¯•ç¡®ä¿ ENV å˜é‡æ˜¯å”¯ä¸€çš„ã€‚é€šè¿‡ä½¿ç”¨ `SetEnvPrefix`ï¼Œå¯ä»¥å‘Šè¯‰ Viper åœ¨è¯»å–ç¯å¢ƒå˜é‡æ—¶ä½¿ç”¨å‰ç¼€ã€‚`BindEnv` å’Œ `AutomaticEnv` éƒ½å°†ä½¿ç”¨æ­¤å‰ç¼€ã€‚

`BindEnv` æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”®åï¼Œå…¶ä½™çš„æ˜¯è¦ç»‘å®šåˆ°è¿™ä¸ªé”®çš„ç¯å¢ƒå˜é‡çš„åç§°ã€‚å¦‚æœæä¾›äº†å¤šä¸ªï¼Œå®ƒä»¬å°†æŒ‰ç…§æŒ‡å®šçš„é¡ºåºä¼˜å…ˆã€‚ç¯å¢ƒå˜é‡çš„åå­—æ˜¯åŒºåˆ†å¤§å°å†™çš„ã€‚å¦‚æœæ²¡æœ‰æä¾› ENV å˜é‡åï¼Œé‚£ä¹ˆ Viper å°†è‡ªåŠ¨å‡å®š ENV å˜é‡åŒ¹é…ä»¥ä¸‹æ ¼å¼: å‰ç¼€ + â€œ _â€+ ALL CAPS ä¸­çš„é”®åã€‚å½“æ˜¾å¼æä¾› ENV å˜é‡å(ç¬¬äºŒä¸ªå‚æ•°)æ—¶ï¼Œå®ƒä¸ä¼šè‡ªåŠ¨æ·»åŠ å‰ç¼€ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯â€œ IDâ€ï¼ŒViper å°†æŸ¥æ‰¾ ENV å˜é‡â€œ IDâ€ã€‚

ä½¿ç”¨ ENV å˜é‡æ—¶éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œæ¯æ¬¡è®¿é—®è¯¥å€¼æ—¶éƒ½ä¼šè¯»å–å®ƒã€‚å½“è°ƒç”¨ BindEnv æ—¶ï¼ŒViper ä¸ä¼šä¿®å¤è¯¥å€¼ã€‚

AutomaticEnv æ˜¯ä¸€ä¸ªå¼ºå¤§çš„åŠ©æ‰‹ï¼Œç‰¹åˆ«æ˜¯å½“ä¸ SetEnvPrefix ç»„åˆæ—¶ã€‚å½“å¬å”¤æ—¶ï¼ŒViperä¼šéšæ—¶æ£€æŸ¥æ˜¯å¦æœ‰ç¯å¢ƒå˜é‡ã€‚è¯·æ±‚å·²ç»æå‡ºã€‚å®ƒå°†é€‚ç”¨ä»¥ä¸‹è§„åˆ™ã€‚å¦‚æœè®¾ç½®äº†å¤§å†™å’Œå‰ç¼€ä¸º EnvPrefix çš„é”®ï¼Œå®ƒå°†æ£€æŸ¥æ˜¯å¦æœ‰åç§°ä¸ä¹‹åŒ¹é…çš„ç¯å¢ƒå˜é‡ã€‚

SetEnvKeyReplace å…è®¸æ‚¨ä½¿ç”¨å­—ç¬¦ä¸²ã€‚å¯¹è±¡é‡å†™ä¸€å®šèŒƒå›´å†…çš„ Env é”®ã€‚å¦‚æœæ‚¨å¸Œæœ›åœ¨ Get ()è°ƒç”¨ä¸­ä½¿ç”¨-æˆ–å…¶ä»–å†…å®¹ï¼Œä½†å¸Œæœ›ç¯å¢ƒå˜é‡ä½¿ç”¨ _ åˆ†éš”ç¬¦ï¼Œé‚£ä¹ˆè¿™å¾ˆæœ‰ç”¨ã€‚åœ¨`viper_test.go` ä¸­å¯ä»¥æ‰¾åˆ°ä½¿ç”¨å®ƒçš„ç¤ºä¾‹ã€‚

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¸¦æœ‰ NewWithOptions å·¥å‚å‡½æ•°çš„ EnvKeyReplaceã€‚ä¸ SetEnvKeyReplace ä¸åŒï¼Œå®ƒæ¥å— StringReplace æ¥å£ï¼Œå…è®¸æ‚¨ç¼–å†™è‡ªå®šä¹‰å­—ç¬¦ä¸²æ›¿æ¢é€»è¾‘ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œç©ºç¯å¢ƒå˜é‡è¢«è®¤ä¸ºæ˜¯æœªè®¾ç½®çš„ï¼Œå¹¶å°†å›é€€åˆ°ä¸‹ä¸€ä¸ªé…ç½®æºã€‚è‹¥è¦å°†ç©ºç¯å¢ƒå˜é‡è§†ä¸ºè®¾ç½®ï¼Œè¯·ä½¿ç”¨ AllowEmptyEnv æ–¹æ³•ã€‚

#### Env example

```go
SetEnvPrefix("spf") // will be uppercased automatically
BindEnv("id")

os.Setenv("SPF_ID", "13") // typically done outside of the app

id := Get("id") // 13
```

### Flags çš„ä½¿ç”¨

Viper å…·æœ‰ç»‘å®šåˆ°æ ‡å¿—çš„èƒ½åŠ›ã€‚å…·ä½“æ¥è¯´ï¼ŒViper æ”¯æŒåœ¨ [Cobra](https://github.com/spf13/cobra)  åº“ä¸­ä½¿ç”¨çš„ `Pflags`ã€‚

ä¸ `BindEnv` ä¸€æ ·ï¼Œè¯¥å€¼ä¸æ˜¯åœ¨è°ƒç”¨ç»‘å®šæ–¹æ³•æ—¶è®¾ç½®çš„ï¼Œè€Œæ˜¯åœ¨è®¿é—®è¯¥æ–¹æ³•æ—¶è®¾ç½®çš„ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥å°½æ—©è¿›è¡Œç»‘å®šï¼Œå³ä½¿åœ¨ `init ()`å‡½æ•°ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

å¯¹äºå•ä¸ªæ ‡å¿—ï¼Œ`BindPFlag ()`æ–¹æ³•æä¾›äº†æ­¤åŠŸèƒ½ã€‚

Example:

```go
serverCmd.Flags().Int("port", 1138, "Port to run Application server on")
viper.BindPFlag("port", serverCmd.Flags().Lookup("port"))
```

æ‚¨è¿˜å¯ä»¥ç»‘å®šä¸€ç»„ç°æœ‰çš„ pFlag (pFlag. FlagSet) :

Example:

```go
pflag.Int("flagname", 1234, "help message for flagname")

pflag.Parse()
viper.BindPFlags(pflag.CommandLine)

i := viper.GetInt("flagname") // retrieve values from viper instead of pflag
```

åœ¨ Viper ä¸­ä½¿ç”¨ pFlag å¹¶ä¸æ’é™¤åœ¨å…¶å®ƒåŒ…ä½¿ç”¨æ ‡å‡†åº“ä¸­ [flag](https://golang.org/pkg/flag/) packageã€‚ pflag  åŒ…å¯ä»¥é€šè¿‡å¯¼å…¥è¿™äº›flag æ¥å¤„ç†ä¸ºflag åŒ…å®šä¹‰çš„flagsã€‚è¿™æ˜¯é€šè¿‡è°ƒç”¨ä¸€ä¸ªåä¸º `AddGoFlagSet ()`çš„ pFlag åŒ…æä¾›çš„ä¾¿åˆ©å‡½æ•°æ¥å®ç°çš„ã€‚

Example:

```go
package main

import (
 "flag"
 "github.com/spf13/pflag"
)

func main() {

 // using standard library "flag" package
 flag.Int("flagname", 1234, "help message for flagname")

 pflag.CommandLine.AddGoFlagSet(flag.CommandLine)
 pflag.Parse()
 viper.BindPFlags(pflag.CommandLine)

 i := viper.GetInt("flagname") // retrieve value from viper

 // ...
}
```

#### Flag interfaces

Viper æä¾›äº†ä¸¤ä¸ª Go æ¥å£æ¥ç»‘å®šå…¶ä»–æ ‡å¿—ç³»ç»Ÿï¼Œå¦‚æœä½ ä¸ä½¿ç”¨æ ‡å¿—çš„è¯ã€‚

FlagValue è¡¨ç¤ºä¸€ä¸ªæ ‡å¿—ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•å®ç°è¿™ä¸ªæ¥å£çš„éå¸¸ç®€å•çš„ä¾‹å­:

```go
type myFlag struct {}
func (f myFlag) HasChanged() bool { return false }
func (f myFlag) Name() string { return "my-flag-name" }
func (f myFlag) ValueString() string { return "my-flag-value" }
func (f myFlag) ValueType() string { return "string" }
```

ä¸€æ—¦ä½ çš„æ ‡å¿—å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œä½ å¯ä»¥ç®€å•åœ°å‘Šè¯‰ Viper ç»‘å®šå®ƒ:

```go
viper.BindFlagValue("my-flag-name", myFlag{})
```

`FlagValueSet` represents a group of flags. è¿™æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•å®ç°è¿™ä¸ªæ¥å£çš„éå¸¸ç®€å•çš„ä¾‹å­:

```go
type myFlagSet struct {
 flags []myFlag
}

func (f myFlagSet) VisitAll(fn func(FlagValue)) {
 for _, flag := range flags {
  fn(flag)
 }
}
```

Once your flag set implements this interface, you can simply tell Viper to bind it:

```go
fSet := myFlagSet{
 flags: []myFlag{myFlag{}, myFlag{}},
}
viper.BindFlagValues("my-flags", fSet)
```

### Remote Key/Value Store Support  è¿œç¨‹ Key/Value å­˜å‚¨æ”¯æŒ

è¦åœ¨ Viper ä¸­å¯ç”¨è¿œç¨‹æ”¯æŒï¼Œè¯·å¯¹ Viper/remote åŒ…æ‰§è¡ŒåŒ¿åå¯¼å…¥:

```go
import _ "github.com/spf13/viper/remote"
```

Viper å°†è¯»å–ä» Key/Value å­˜å‚¨(å¦‚ etcd æˆ– Consule)ä¸­çš„è·¯å¾„æ£€ç´¢åˆ°çš„é…ç½®å­—ç¬¦ä¸²(å¦‚ JSONã€ TOMLã€ YAMLã€ HCL æˆ– envfile)ã€‚è¿™äº›å€¼ä¼˜å…ˆäºé»˜è®¤å€¼ï¼Œä½†æ˜¯è¢«ä»ç£ç›˜ã€æ ‡å¿—æˆ–ç¯å¢ƒå˜é‡æ£€ç´¢åˆ°çš„é…ç½®å€¼è¦†ç›–ã€‚

Viper ä½¿ç”¨  [crypt](https://github.com/bketelsen/crypt)  ä» K/V å­˜å‚¨ä¸­æ£€ç´¢é…ç½®ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥å­˜å‚¨åŠ å¯†çš„é…ç½®å€¼ï¼Œå¦‚æœæ‚¨æœ‰æ­£ç¡®çš„ gpg å¯†é’¥ç¯ï¼Œåˆ™å¯ä»¥è‡ªåŠ¨è§£å¯†å®ƒä»¬ã€‚åŠ å¯†æ˜¯å¯é€‰çš„ã€‚

æ‚¨å¯ä»¥å°†è¿œç¨‹é…ç½®ä¸æœ¬åœ°é…ç½®ç»“åˆä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹äºæœ¬åœ°é…ç½®ä½¿ç”¨ã€‚

[crypt](https://github.com/bketelsen/crypt)  æœ‰ä¸€ä¸ªå‘½ä»¤è¡ŒåŠ©æ‰‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒåœ¨ K/V å­˜å‚¨ä¸­æ”¾ç½®é…ç½®ã€‚åœ¨ <http://127.0.0.1:4001ä¸Šï¼Œcrypt> é»˜è®¤ä¸º etcdã€‚

```bash
go get github.com/bketelsen/crypt/bin/crypt
crypt set -plaintext /config/hugo.json /Users/hugo/settings/config.json
```

Confirm that your value was set:

```bash
crypt get -plaintext /config/hugo.json
```

æœ‰å…³å¦‚ä½•è®¾ç½®åŠ å¯†å€¼æˆ–å¦‚ä½•ä½¿ç”¨ Consul çš„ç¤ºä¾‹ï¼Œè¯·å‚è§  [crypt](https://github.com/bketelsen/crypt)  æ–‡æ¡£ã€‚

### Remote Key/Value Store Example - Unencrypted è¿œç¨‹Key/Valueå­˜å‚¨ç¤ºä¾‹-æœªåŠ å¯†

#### etcd

```go
viper.AddRemoteProvider("etcd", "http://127.0.0.1:4001","/config/hugo.json")
viper.SetConfigType("json") // because there is no file extension in a stream of bytes, supported extensions are "json", "toml", "yaml", "yml", "properties", "props", "prop", "env", "dotenv"
err := viper.ReadRemoteConfig()
```

#### etcd3

```go
viper.AddRemoteProvider("etcd3", "http://127.0.0.1:4001","/config/hugo.json")
viper.SetConfigType("json") // because there is no file extension in a stream of bytes, supported extensions are "json", "toml", "yaml", "yml", "properties", "props", "prop", "env", "dotenv"
err := viper.ReadRemoteConfig()
```

#### Consul

You need to set a key to Consul key/value storage with JSON value containing your desired config. For example, create a Consul key/value store key `MY_CONSUL_KEY` with value:

æ‚¨éœ€è¦ä½¿ç”¨åŒ…å«æ‰€éœ€é…ç½®çš„ JSON å€¼å°†ä¸€ä¸ªé”®è®¾ç½®ä¸º Consul key/value å­˜å‚¨ã€‚ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ª Consul key/value store key MY _CONSUL_ KEYï¼Œå…¶å€¼ä¸º:

```go
{
    "port": 8080,
    "hostname": "myhostname.com"
}
viper.AddRemoteProvider("consul", "localhost:8500", "MY_CONSUL_KEY")
viper.SetConfigType("json") // Need to explicitly set this to json
err := viper.ReadRemoteConfig()

fmt.Println(viper.Get("port")) // 8080
fmt.Println(viper.Get("hostname")) // myhostname.com
```

#### Firestore

```go
viper.AddRemoteProvider("firestore", "google-cloud-project-id", "collection/document")
viper.SetConfigType("json") // Config's format: "json", "toml", "yaml", "yml"
err := viper.ReadRemoteConfig()
```

å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ `SecureRemoteProvider`

### Remote Key/Value Store Example - Encrypted è¿œç¨‹Key/Valueå­˜å‚¨ç¤ºä¾‹-åŠ å¯†

```go
viper.AddSecureRemoteProvider("etcd","http://127.0.0.1:4001","/config/hugo.json","/etc/secrets/mykeyring.gpg")
viper.SetConfigType("json") // because there is no file extension in a stream of bytes,  supported extensions are "json", "toml", "yaml", "yml", "properties", "props", "prop", "env", "dotenv"
err := viper.ReadRemoteConfig()
```

### Watching Changes in etcd - Unencrypted  ç›‘å¬etcd ä¸­çš„æ›´æ”¹-æœªåŠ å¯†

```go
// alternatively, you can create a new viper instance.
var runtime_viper = viper.New()

runtime_viper.AddRemoteProvider("etcd", "http://127.0.0.1:4001", "/config/hugo.yml")
runtime_viper.SetConfigType("yaml") // because there is no file extension in a stream of bytes, supported extensions are "json", "toml", "yaml", "yml", "properties", "props", "prop", "env", "dotenv"

// read from remote config the first time.
err := runtime_viper.ReadRemoteConfig()

// unmarshal config ååºåˆ—åŒ–
runtime_viper.Unmarshal(&runtime_conf)

// open a goroutine to watch remote changes forever
go func(){
 for {
  time.Sleep(time.Second * 5) // delay after each request

  // currently, only tested with etcd support
  err := runtime_viper.WatchRemoteConfig()
  if err != nil {
   log.Errorf("unable to read remote config: %v", err)
   continue
  }

  // unmarshal new config into our runtime config struct. you can also use channel
  // to implement a signal to notify the system of the changes
  runtime_viper.Unmarshal(&runtime_conf)
 }
}()
```

## ä» Viper è·å–å€¼

åœ¨ Viper ä¸­ï¼Œæœ‰å‡ ç§æ ¹æ®å€¼çš„ç±»å‹è·å–å€¼çš„æ–¹æ³•ã€‚ç°æœ‰ä»¥ä¸‹èŒèƒ½å’Œæ–¹æ³•:

- `Get(key string) : interface{}`
- `GetBool(key string) : bool`
- `GetFloat64(key string) : float64`
- `GetInt(key string) : int`
- `GetIntSlice(key string) : []int`
- `GetString(key string) : string`
- `GetStringMap(key string) : map[string]interface{}`
- `GetStringMapString(key string) : map[string]string`
- `GetStringSlice(key string) : []string`
- `GetTime(key string) : time.Time`
- `GetDuration(key string) : time.Duration`
- `IsSet(key string) : bool`
- `AllSettings() : map[string]interface{}`

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ¯ä¸ª Get å‡½æ•°å°†è¿”å›ä¸€ä¸ªé›¶å€¼ã€‚ä¸ºäº†æ£€æŸ¥ç»™å®šçš„é”®æ˜¯å¦å­˜åœ¨ï¼Œæä¾›äº†`IsSet ()`æ–¹æ³•ã€‚

Example:

```go
viper.GetString("logfile") // case-insensitive Setting & Getting
if viper.GetBool("verbose") {
 fmt.Println("verbose enabled")
}
```

### Accessing nested keys  è®¿é—®åµŒå¥—é”®

è®¿é—®å™¨æ–¹æ³•è¿˜æ¥å—æ·±åº¦åµŒå¥—é”®çš„æ ¼å¼åŒ–è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåŠ è½½äº†ä»¥ä¸‹ JSON æ–‡ä»¶:

```json
{
    "host": {
        "address": "localhost",
        "port": 5799
    },
    "datastore": {
        "metric": {
            "host": "127.0.0.1",
            "port": 3099
        },
        "warehouse": {
            "host": "198.0.0.1",
            "port": 2112
        }
    }
}

```

Viper å¯ä»¥é€šè¿‡ä¼ é€’` . `åˆ†éš”çš„é”®è·¯å¾„æ¥è®¿é—®åµŒå¥—å­—æ®µ:

```go
GetString("datastore.metric.host") // (returns "127.0.0.1")
```

è¿™ç¬¦åˆä¸Šé¢å»ºç«‹çš„ä¼˜å…ˆçº§è§„åˆ™; å¯¹è·¯å¾„çš„æœç´¢å°†é€šè¿‡å‰©ä½™çš„é…ç½®æ³¨å†Œä¸­å¿ƒçº§è”ï¼Œç›´åˆ°æ‰¾åˆ°ã€‚

ä¾‹å¦‚ï¼Œç»™å®šè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œdatastore.metric.host å’Œ datastore.metric.port éƒ½å·²ç»å®šä¹‰(å¹¶ä¸”å¯èƒ½è¢«è¦†ç›–)ã€‚å¦‚æœåœ¨é»˜è®¤æƒ…å†µä¸‹å¦å¤–å®šä¹‰äº† datastore.metric.protocolï¼ŒViper ä¹Ÿä¼šæ‰¾åˆ°å®ƒã€‚

ä½†æ˜¯ï¼Œå¦‚æœ datastore.metrics è¢«è¦†ç›–(é€šè¿‡ä¸€ä¸ªæ ‡å¿—ã€ä¸€ä¸ªç¯å¢ƒå˜é‡ã€ Set ()æ–¹æ³•ï¼Œ...)å¹¶ä¸”æœ‰ä¸€ä¸ªç«‹å³çš„å€¼ï¼Œé‚£ä¹ˆ datastore.metrics çš„æ‰€æœ‰å­é”®éƒ½å°†å˜å¾—æœªå®šä¹‰ï¼Œå®ƒä»¬å°†è¢«æ›´é«˜ä¼˜å…ˆçº§çš„é…ç½®çº§åˆ«â€œéšè—â€ã€‚

Viper å¯ä»¥é€šè¿‡è·¯å¾„ä¸­çš„æ•°å­—è®¿é—®æ•°ç»„ç´¢å¼•ã€‚ä¾‹å¦‚:

```go
{
    "host": {
        "address": "localhost",
        "ports": [
            5799,
            6029
        ]
    },
    "datastore": {
        "metric": {
            "host": "127.0.0.1",
            "port": 3099
        },
        "warehouse": {
            "host": "198.0.0.1",
            "port": 2112
        }
    }
}

GetInt("host.ports.1") // returns 6029

```

æœ€åï¼Œå¦‚æœå­˜åœ¨ä¸åˆ†éš”çš„é”®è·¯å¾„åŒ¹é…çš„é”®ï¼Œåˆ™å°†è¿”å›å…¶å€¼ã€‚

```go
{
    "datastore.metric.host": "0.0.0.0",
    "host": {
        "address": "localhost",
        "port": 5799
    },
    "datastore": {
        "metric": {
            "host": "127.0.0.1",
            "port": 3099
        },
        "warehouse": {
            "host": "198.0.0.1",
            "port": 2112
        }
    }
}

GetString("datastore.metric.host") // returns "0.0.0.0"
```

### æå–å­æ ‘

åœ¨å¼€å‘å¯é‡ç”¨æ¨¡å—æ—¶ï¼Œæå–é…ç½®çš„å­é›†å¹¶å°†å…¶ä¼ é€’ç»™æ¨¡å—é€šå¸¸å¾ˆæœ‰ç”¨ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„é…ç½®å¤šæ¬¡å®ä¾‹åŒ–æ¨¡å—ã€‚

ä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¸ºä¸åŒç›®çš„ä½¿ç”¨å¤šä¸ªä¸åŒçš„ç¼“å­˜å­˜å‚¨åŒº:

```yaml
cache:
  cache1:
    max-items: 100
    item-size: 64
  cache2:
    max-items: 200
    item-size: 80
```

æˆ‘ä»¬å¯ä»¥å°†ç¼“å­˜åä¼ é€’ç»™ä¸€ä¸ªæ¨¡å—(ä¾‹å¦‚ã€‚NewCache (â€œ cache1â€) ï¼Œä½†æ˜¯è®¿é—®é…ç½®é”®éœ€è¦å¥‡æ€ªçš„è¿æ¥ï¼Œå¹¶ä¸”ä¸å…¨å±€é…ç½®çš„åˆ†ç¦»ç¨‹åº¦è¾ƒä½ã€‚

å› æ­¤ï¼Œä¸å…¶è¿™æ ·åšï¼Œä¸å¦‚å°† Viper å®ä¾‹ä¼ é€’ç»™ä»£è¡¨é…ç½®å­é›†çš„æ„é€ å‡½æ•°:

```go
cache1Config := viper.Sub("cache.cache1")
if cache1Config == nil { // Sub returns nil if the key cannot be found
 panic("cache configuration not found")
}

cache1 := NewCache(cache1Config)
```

æ³¨æ„: å§‹ç»ˆæ£€æŸ¥ Sub çš„è¿”å›å€¼ã€‚å¦‚æœæ‰¾ä¸åˆ°é”®ï¼Œå®ƒä¼šè¿”å› nilã€‚

åœ¨å†…éƒ¨ï¼ŒNewCache å‡½æ•°å¯ä»¥ç›´æ¥å¤„ç† max-item å’Œ item-size é”®:

```go
func NewCache(v *Viper) *Cache {
 return &Cache{
  MaxItems: v.GetInt("max-items"),
  ItemSize: v.GetInt("item-size"),
 }
}
```

äº§ç”Ÿçš„ä»£ç å¾ˆå®¹æ˜“æµ‹è¯•ï¼Œå› ä¸ºå®ƒä¸ä¸»é…ç½®ç»“æ„è§£è€¦ï¼Œå¹¶ä¸”å‡ºäºåŒæ ·çš„åŸå› æ›´å®¹æ˜“é‡ç”¨ã€‚

### Unmarshaling ååºåˆ—åŒ–

æ‚¨è¿˜å¯ä»¥é€‰æ‹©å°†æ‰€æœ‰å€¼æˆ–ç‰¹å®šå€¼ååºåˆ—åŒ–åˆ°ç»“æ„ä½“ã€mapç­‰ã€‚

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹:

- `Unmarshal(rawVal interface{}) : error`
- `UnmarshalKey(key string, rawVal interface{}) : error`

Example:

```go
type config struct {
 Port int
 Name string
 PathMap string `mapstructure:"path_map"`
}

var C config

err := viper.Unmarshal(&C)
if err != nil {
 t.Fatalf("unable to decode into struct, %v", err)
}
```

å¦‚æœè¦ååºåˆ—åŒ–é”®æœ¬èº«åŒ…å«ç‚¹(é»˜è®¤çš„é”®åˆ†éš”ç¬¦)çš„é…ç½®ï¼Œå¿…é¡»æ›´æ”¹åˆ†éš”ç¬¦:

```go
v := viper.NewWithOptions(viper.KeyDelimiter("::"))

v.SetDefault("chart::values", map[string]interface{}{
 "ingress": map[string]interface{}{
  "annotations": map[string]interface{}{
   "traefik.frontend.rule.type":                 "PathPrefix",
   "traefik.ingress.kubernetes.io/ssl-redirect": "true",
  },
 },
})

type config struct {
 Chart struct{
  Values map[string]interface{}
 }
}

var C config

v.Unmarshal(&C)
```

Viper è¿˜æ”¯æŒå°†æ•°æ®è§£æä¸ºåµŒå…¥å¼ç»“æ„:

```go
/*
Example config:

module:
    enabled: true
    token: 89h3f98hbwf987h3f98wenf89ehf
*/
type config struct {
 Module struct {
  Enabled bool

  moduleConfig `mapstructure:",squash"`
 }
}

// moduleConfig could be in a module specific package
type moduleConfig struct {
 Token string
}

var C config

err := viper.Unmarshal(&C)
if err != nil {
 t.Fatalf("unable to decode into struct, %v", err)
}
```

Viper ä½¿ç”¨åº•å±‚ [github.com/mitchellh/mapstructure](https://github.com/mitchellh/mapstructure)  æ¥è§£æå€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ `mapstructure`ã€‚

#### å®æ“

```go
package main

import (
 "fmt"

 "github.com/fsnotify/fsnotify"
 "github.com/spf13/viper"
)

type Config struct {
 Host        string `mapstructure:"host"`
 Version     string `mapstructure:"version"`
 Port        int    `mapstructure:"port"`
 MySQLConfig `mapstructure:"mysql"`
}

type MySQLConfig struct {
 Host   string `mapstructure:"host"`
 DbName string `mapstructure:"dbname"`
 Port   int    `mapstructure:"port"`
}

func main() {
 // è®¾ç½®é»˜è®¤å€¼
 viper.SetDefault("fileDir", "./")
 // è¯»å–é…ç½®æ–‡ä»¶
 viper.SetConfigFile("./config.yaml")  // æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
 viper.SetConfigName("config")         // é…ç½®æ–‡ä»¶åç§°(æ— æ‰©å±•å)
 viper.SetConfigType("yaml")           // å¦‚æœé…ç½®æ–‡ä»¶çš„åç§°ä¸­æ²¡æœ‰æ‰©å±•åï¼Œåˆ™éœ€è¦é…ç½®æ­¤é¡¹
 viper.AddConfigPath("/etc/appname/")  // æŸ¥æ‰¾é…ç½®æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
 viper.AddConfigPath("$HOME/.appname") // å¤šæ¬¡è°ƒç”¨ä»¥æ·»åŠ å¤šä¸ªæœç´¢è·¯å¾„
 viper.AddConfigPath(".")              // è¿˜å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­æŸ¥æ‰¾é…ç½®

 err := viper.ReadInConfig() // æŸ¥æ‰¾å¹¶è¯»å–é…ç½®æ–‡ä»¶
 if err != nil {             // å¤„ç†è¯»å–é…ç½®æ–‡ä»¶çš„é”™è¯¯
  panic(fmt.Errorf("Fatal error config file: %s \n", err))
 }

 // å®æ—¶ç›‘æ§é…ç½®æ–‡ä»¶çš„å˜åŒ– WatchConfig å¼€å§‹ç›‘è§†é…ç½®æ–‡ä»¶çš„æ›´æ”¹ã€‚
 viper.WatchConfig()
 // OnConfigChangeè®¾ç½®é…ç½®æ–‡ä»¶æ›´æ”¹æ—¶è°ƒç”¨çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚
 // å½“é…ç½®æ–‡ä»¶å˜åŒ–ä¹‹åè°ƒç”¨çš„ä¸€ä¸ªå›è°ƒå‡½æ•°
 viper.OnConfigChange(func(e fsnotify.Event) {
  fmt.Println("Config file changed:", e.Name)
 })

 //r := gin.Default()
 //r.GET("/version", func(c *gin.Context) {
 // // GetStringä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¿”å›ä¸é”®ç›¸å…³çš„å€¼ã€‚
 // c.String(http.StatusOK, viper.GetString("version"))
 //})
 //r.Run()

 var c Config

 if err := viper.Unmarshal(&c); err != nil {
  fmt.Printf("viper Unmarshal failed, err: %v\n", err)
  return
 }
 fmt.Printf("viper unmarshal success. c: %#v\n", c)
}

```

config.yaml

```yaml
host: "127.0.0.1"
port: 8080
version: "v0.0.2"

mysql:
  host: "127.0.0.1"
  port: 3306
  dbname: "sql_demo"

```

è¿è¡Œ

```bash
Code/go/viper_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ go run main.go
viper unmarshal success. c: main.Config{Host:"127.0.0.1", Version:"v0.0.2", Port:8080, MySQLConfig:main.MySQLConfig{Host:"127.0.0.1", DbName:"sql_demo", Port:3306}}

Code/go/viper_demo via ğŸ¹ v1.20.3 via ğŸ…’ base 
âœ 
```

### Decoding custom formats

Viper ç»å¸¸éœ€è¦çš„ä¸€ä¸ªç‰¹æ€§æ˜¯æ·»åŠ æ›´å¤šçš„å€¼æ ¼å¼å’Œè§£ç å™¨ã€‚ä¾‹å¦‚ï¼Œè§£æå­—ç¬¦(ç‚¹ã€é€—å·ã€åˆ†å·ç­‰)å°†å­—ç¬¦ä¸²åˆ†éš”æˆç‰‡ã€‚

è¿™åœ¨ä½¿ç”¨æ˜ å°„ç»“æ„è§£ç é’©å­çš„ Viper ä¸­å·²ç»å¯ç”¨ã€‚

é˜…è¯»æ›´å¤šå…³äº [this blog post](https://sagikazarmark.hu/blog/decoding-custom-formats-with-viper/)ï¼šhttps://sagikazarmark.hu/blog/decoding-custom-formats-with-viper/ã€‚

### Marshalling to string åºåˆ—åŒ–æˆå­—ç¬¦ä¸²

**æ‚¨å¯èƒ½éœ€è¦å°† viper ä¸­ä¿å­˜çš„æ‰€æœ‰è®¾ç½®ç¼–ç»„æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯å°†å®ƒä»¬å†™å…¥æ–‡ä»¶ã€‚æ‚¨å¯ä»¥å¯¹ AllSettings ()è¿”å›çš„é…ç½®ä½¿ç”¨æ‚¨å–œæ¬¢çš„æ ¼å¼çš„ç¼–ç»„å™¨ã€‚**

```go
import (
 yaml "gopkg.in/yaml.v2"
 // ...
)

func yamlStringSettings() string {
 c := viper.AllSettings()
 bs, err := yaml.Marshal(c)
 if err != nil {
  log.Fatalf("unable to marshal config to YAML: %v", err)
 }
 return string(bs)
}
```

## Viper or Vipers? å•ä¸ªå’Œå¤šä¸ª Viper çš„é€‰æ‹©

Viperå·²ç»å‡†å¤‡å¥½å¼€ç®±ä½¿ç”¨äº†ã€‚å¼€å§‹ä½¿ç”¨ Viper ä¸éœ€è¦é…ç½®æˆ–åˆå§‹åŒ–ã€‚ç”±äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºéƒ½å¸Œæœ›ä½¿ç”¨å•ä¸ªä¸­å¤®å­˜å‚¨åº“è¿›è¡Œé…ç½®ï¼Œå› æ­¤ viper åŒ…æä¾›äº†è¿™ä¸€åŠŸèƒ½ã€‚å®ƒç±»ä¼¼äºå•ä¾‹æ¨¡å¼ã€‚

åœ¨ä¸Šé¢çš„æ‰€æœ‰ç¤ºä¾‹ä¸­ï¼Œå®ƒä»¬éƒ½æ¼”ç¤ºäº†å¦‚ä½•åœ¨å•ä¾‹æ ·å¼æ–¹æ³•ä¸­ä½¿ç”¨ viper

#### å¤šä¸ª Viper çš„ä½¿ç”¨

æ‚¨è¿˜å¯ä»¥åˆ›å»ºè®¸å¤šä¸åŒçš„vipersåœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚æ¯ä¸€ä¸ªéƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„ä¸€ç»„é…ç½®å’Œå€¼ã€‚æ¯ä¸ªéƒ½å¯ä»¥ä»ä¸åŒçš„é…ç½®æ–‡ä»¶ã€é”®å€¼å­˜å‚¨ç­‰è¯»å–ã€‚Viper åŒ…æ”¯æŒçš„æ‰€æœ‰åŠŸèƒ½éƒ½åæ˜ ä¸º viper ä¸Šçš„æ–¹æ³•ã€‚

Example:

```go
x := viper.New()
y := viper.New()

x.SetDefault("ContentDir", "content")
y.SetDefault("ContentDir", "foobar")

//...
```

åœ¨å¤„ç†å¤šæ¡vipersæ—¶ï¼Œç”±ç”¨æˆ·æ¥è·Ÿè¸ªä¸åŒçš„vipersã€‚


æ›´å¤šè¯¦æƒ…è¯·[é˜…è¯»](https://github.com/spf13/viper/blob/master/README.md)ï¼š<https://github.com/spf13/viper/blob/master/README.md>

## æ€»ç»“
Viperï¼ŒGo å¼€å‘è€…çš„é…ç½®ç®¡ç†â€œæ•‘æ˜Ÿâ€ï¼é€šè¿‡æœ¬æ–‡ï¼Œä½ å·²ç»æŒæ¡äº† Viper çš„ç²¾é«“ï¼šä»çµæ´»åŠ è½½å¤šç§é…ç½®æ–‡ä»¶ï¼Œåˆ°å®æ—¶æ›´æ–°é…ç½®ã€å¤„ç†åµŒå¥—é”®å’Œååºåˆ—åŒ–ï¼Œå†åˆ°è¿œç¨‹é…ç½®çš„è¿›é˜¶ç”¨æ³•ï¼ŒViper è®©ä½ çš„ Go åº”ç”¨é…ç½®ç®¡ç†å˜å¾—ä¼˜é›…åˆé«˜æ•ˆã€‚ä¸ç®¡æ˜¯å°å‹é¡¹ç›®è¿˜æ˜¯å¤æ‚ç³»ç»Ÿï¼ŒViper éƒ½èƒ½å¸®ä½ çœæ—¶çœåŠ›ã€‚ç°åœ¨å°±åŠ¨æ‰‹è¯•è¯•ï¼ŒæŠŠè¿™äº›æŠ€å·§ç”¨èµ·æ¥ï¼Œè®©ä½ çš„ä»£ç æ›´ä¸Šä¸€å±‚æ¥¼ï¼å¿«åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„ Viper ä½¿ç”¨å¿ƒå¾—ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘ä»¬ä½ è¿˜æƒ³å­¦å“ªäº› Go ç¥å™¨å§ï¼
## å‚è€ƒ
- https://sagikazarmark.hu/blog/decoding-custom-formats-with-viper/
- https://github.com/spf13/viper/blob/master/README.md
- https://github.com/mitchellh/mapstructure
- https://github.com/spf13/viper

