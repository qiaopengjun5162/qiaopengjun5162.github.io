+++
title = "Rust å®æˆ˜ï¼šSQLx CLI å·¥å…·ä½¿ç”¨ä¸æ•°æ®åº“è¿ç§»æŒ‡å—"
description = "Rust å®æˆ˜ï¼šSQLx CLI å·¥å…·ä½¿ç”¨ä¸æ•°æ®åº“è¿ç§»æŒ‡å—"
date = 2025-12-06T07:24:10Z
[taxonomies]
categories = ["Rust"]
tags = ["Rust"]
+++

<!-- more -->

# **Rust å®æˆ˜ï¼šSQLx CLI å·¥å…·ä½¿ç”¨ä¸æ•°æ®åº“è¿ç§»æŒ‡å—**

åœ¨ Rust çš„ Web å¼€å‘ç”Ÿæ€ä¸­ï¼ŒSQLx å‡­å€Ÿå…¶å¼‚æ­¥ç‰¹æ€§å’Œç‹¬ç‰¹çš„â€œç¼–è¯‘æ—¶ SQL æ£€æŸ¥â€åŠŸèƒ½ï¼Œæˆä¸ºäº†è®¸å¤šå¼€å‘è€…çš„é¦–é€‰ã€‚å®ƒä¸éœ€è¦å¤æ‚çš„ DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ï¼Œè®©ä½ èƒ½ç›´æ¥ç¼–å†™åŸç”Ÿ SQLï¼ŒåŒæ—¶äº«å— Rust å¼ºç±»å‹çš„å®‰å…¨ä¿éšœã€‚

ä½†åœ¨å¼€å§‹ç¼–å†™ Rust ä»£ç ä¹‹å‰ï¼Œå¦‚ä½•æ­å»ºæ•°æ®åº“ç¯å¢ƒï¼Ÿå¦‚ä½•é«˜æ•ˆåœ°ç®¡ç†æ•°æ®åº“è¡¨ç»“æ„çš„å˜æ›´ï¼Ÿæœ¬æ–‡å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œå®æ“ SQLx CLI å·¥å…·çš„å®‰è£…ã€PostgreSQL æ•°æ®åº“çš„åˆ›å»ºã€pgcli çš„ä½¿ç”¨ï¼Œä»¥åŠæœ€æ ¸å¿ƒçš„æ•°æ®åº“è¿ç§»ï¼ˆMigrationï¼‰æµç¨‹ã€‚è®©æˆ‘ä»¬å…ˆæŠŠåŸºç¡€è®¾æ–½æ­å»ºå¥½ï¼Œä¸ºåç»­çš„ä¸šåŠ¡å¼€å‘æ‰«æ¸…éšœç¢ã€‚

æœ¬æ–‡è®°å½•äº† Rust å¼‚æ­¥æ•°æ®åº“åº“ SQLx çš„ç¯å¢ƒæ­å»ºä¸å®æ“æµç¨‹ã€‚å†…å®¹æ¶µç›– SQLx CLI çš„å®‰è£…é…ç½®ã€PostgreSQL æ•°æ®åº“çš„åˆ›å»ºåŠ pgcli å‘½ä»¤è¡Œå·¥å…·çš„ä½¿ç”¨æŠ€å·§ã€‚é‡ç‚¹æ¼”ç¤ºäº† sqlx migrate ç³»åˆ—å‘½ä»¤çš„å®æˆ˜åº”ç”¨ï¼ŒåŒ…æ‹¬åˆ›å»ºè¿ç§»è„šæœ¬ã€æ‰§è¡Œæ•°æ®åº“å‡çº§ã€ä»¥åŠé€šè¿‡ psql å…ƒå‘½ä»¤éªŒè¯è¡¨ç»“æ„å˜æ›´ã€‚é€‚åˆ Rust åˆå­¦è€…åŠå¸Œæœ›è§„èŒƒåŒ–ç®¡ç†æ•°æ®åº“ç‰ˆæœ¬çš„å¼€å‘è€…é˜…è¯»ã€‚

## Rust SQLx

SQLx æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€çº¯ Rustâ€  SQL crateï¼Œå…·æœ‰ç¼–è¯‘æ—¶æ£€æŸ¥æŸ¥è¯¢çš„åŠŸèƒ½ï¼Œæ²¡æœ‰ DSLã€‚

## å®æ“

### å®‰è£… SQLx CLI

```bash
âœ cargo install sqlx-cli --no-default-features --features rustls --features postgres
```

### æŸ¥çœ‹`SQLx CLI`å‘½ä»¤

```bash
âœ sqlx
Command-line utility for SQLx, the Rust SQL toolkit.

Usage: sqlx [OPTIONS] <COMMAND>

Commands:
  database  Group of commands for creating and dropping your database
  prepare   Generate query metadata to support offline compile-time verification
  migrate   Group of commands for creating and running migrations
  help      Print this message or the help of the given subcommand(s)

Options:
      --no-dotenv  Do not automatically load `.env` files
  -h, --help       Print help
  -V, --version    Print version
```

### åˆ›å»ºæ•°æ®åº“

```bash
âœ createdb chat
```

### å®‰è£… `pgcli`

[https://www.pgcli.com/](https://www.pgcli.com/)

```bash
brew install pgcli
```

### ä½¿ç”¨ `pgcli`è¿›å…¥æ•°æ®åº“

```sql
âœ pgcli chat
Using local time zone Asia/Shanghai (server uses Asia/Shanghai)
Use `set time zone <TZ>` to override, or set `use_local_timezone = False` in the config
Server: PostgreSQL 17.6 (Homebrew)
Version: 4.3.0
Home: http://pgcli.com
qiaopengjun@/tmp:chat>



 [F2] Smart Completion: ON  [F3] Multiline: OFF  [F4] Emacs-mode  [F5] Explain: OFF
```

### æŸ¥çœ‹æ•°æ®åº“ä¸­çš„è¡¨

`\dt` æ˜¯ **psql å…ƒå‘½ä»¤**ï¼Œç”¨äºåˆ—å‡ºå½“å‰æ•°æ®åº“ä¸­çš„ **è¡¨ï¼ˆtablesï¼‰**ã€‚

å®ƒç›¸å½“äºï¼š

```sql
SELECT * FROM pg_catalog.pg_tables;
```

å®æ“ï¼š

```sql
âœ pgcli chat
Using local time zone Asia/Shanghai (server uses Asia/Shanghai)
Use `set time zone <TZ>` to override, or set `use_local_timezone = False` in the config
Server: PostgreSQL 17.6 (Homebrew)
Version: 4.3.0
Home: http://pgcli.com
qiaopengjun@/tmp:chat> \dt
+--------+------+------+-------+
| Schema | Name | Type | Owner |
|--------+------+------+-------|
+--------+------+------+-------+
SELECT 0
Time: 0.037s
qiaopengjun@/tmp:chat> \dt;
+--------+------+------+-------+
| Schema | Name | Type | Owner |
|--------+------+------+-------|
+--------+------+------+-------+
SELECT 0
Time: 0.007s
qiaopengjun@/tmp:chat>



 [F2] Smart Completion: ON  [F3] Multiline: OFF  [F4] Emacs-mode  [F5] Explain: OFF
```

### `Psql` å¸¸ç”¨å‘½ä»¤

**PostgreSQLï¼ˆpsql å‘½ä»¤è¡Œå·¥å…·ï¼‰** ä¸­å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤         | ä½œç”¨           |
| ------------ | -------------- |
| `\dt`        | åˆ—å‡ºæ‰€æœ‰æ™®é€šè¡¨ |
| `\dv`        | åˆ—å‡ºè§†å›¾       |
| `\di`        | åˆ—å‡ºç´¢å¼•       |
| `\ds`        | åˆ—å‡ºåºåˆ—       |
| `\d <table>` | æŸ¥çœ‹è¡¨ç»“æ„     |
| `\l`         | åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“ |
| `\c dbname`  | åˆ‡æ¢æ•°æ®åº“     |
| `\dn`        | åˆ—å‡º schema    |

### æŸ¥çœ‹`sqlx migrate`

ğŸš€ **sqlx migrate å‘½ä»¤è§£é‡Šï¼ˆRust é¡¹ç›®å¸¸ç”¨ï¼‰**

`sqlx migrate` æ˜¯ SQLx æä¾›çš„æ•°æ®åº“è¿ç§»å·¥å…·ï¼Œç”¨äºï¼š

- åˆ›å»º migration æ–‡ä»¶ï¼ˆup/downï¼‰
- æ‰§è¡Œæ•°æ®åº“è¡¨ç»“æ„æ›´æ–°
- å›æ»šè¿ç§»
- æŸ¥çœ‹è¿ç§»çŠ¶æ€

```sql
âœ sqlx migrate
Group of commands for creating and running migrations

Usage: sqlx migrate <COMMAND>

Commands:
  add           Create a new migration with the given description
  run           Run all pending migrations
  revert        Revert the latest migration with a down file
  info          List all available migrations
  build-script  Generate a `build.rs` to trigger recompilation when a new migration is added
  help          Print this message or the help of the given subcommand(s)

Options:
  -h, --help  Print help

```

### æ‰§è¡Œ`migrate add`å‘½ä»¤

```sql
âœ sqlx migrate add initial
Creating migrations/20251203080702_initial.sql
```

æŸ¥çœ‹ç”Ÿæˆçš„è„šæœ¬ç›®å½•ç»“æ„

```bash
â”œâ”€â”€ migrations
â”‚   â””â”€â”€ 20251203080702_initial.sql
```

ç”Ÿæˆæ–‡ä»¶åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `migrations/2025xxx_initial.sql` æ–‡ä»¶ä¸­å†™å…¥å»ºè¡¨è¯­å¥ï¼ˆCreate Table...ï¼‰ï¼Œä¿å­˜åå†æ‰§è¡Œè¿ç§»ã€‚

### æ‰§è¡Œ`migrate run`å‘½ä»¤

```sql
âœ sqlx migrate run
Applied 20251203080702/migrate initial (23.433375ms)
```

æŸ¥çœ‹è¿è¡Œç»“æœ

```sql
âœ pgcli chat
Using local time zone Asia/Shanghai (server uses Asia/Shanghai)
Use `set time zone <TZ>` to override, or set `use_local_timezone = False` in the config
Server: PostgreSQL 17.6 (Homebrew)
Version: 4.3.0
Home: http://pgcli.com
qiaopengjun@/tmp:chat> \dt
+--------+------------------+-------+----------+
| Schema | Name             | Type  | Owner    |
|--------+------------------+-------+----------|
| public | _sqlx_migrations | table | postgres |
| public | chats            | table | postgres |
| public | messages         | table | postgres |
| public | users            | table | postgres |
+--------+------------------+-------+----------+
SELECT 4
Time: 0.017s
qiaopengjun@/tmp:chat> select * FROM _sqlx_migrations;
+----------------+-------------+------------------------------+---------+----------------------------------------------------------------------------------------------------+----------------+
| version        | description | installed_on                 | success | checksum                                                                                           | execution_time |
|----------------+-------------+------------------------------+---------+----------------------------------------------------------------------------------------------------+----------------|
| 20251203080702 | initial     | 2025-12-03 17:09:47.59188+08 | True    | \x33d8304d5f29003cdd8320d95b1c5ba1a32ed60a1663f850bac7e4d807f00efce535159dcd2a5a60ab2a18a0670ef29c | 23433375       |
+----------------+-------------+------------------------------+---------+----------------------------------------------------------------------------------------------------+----------------+
SELECT 1
Time: 0.013s
qiaopengjun@/tmp:chat>
Goodbye!
```

## æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„å®æ“ï¼Œæˆ‘ä»¬å®Œæˆäº† Rust é¡¹ç›®ä¸­æ•°æ®åº“åŸºç¡€è®¾æ–½çš„æ­å»ºã€‚ä»å®‰è£… `sqlx-cli` å’Œè¾…åŠ©å·¥å…· `pgcli` å¼€å§‹ï¼Œæˆ‘ä»¬æˆåŠŸåˆ›å»ºäº† `chat` æ•°æ®åº“ï¼Œå¹¶æŒæ¡äº†é€šè¿‡ `sqlx migrate add` ç”Ÿæˆç‰ˆæœ¬æ§åˆ¶è„šæœ¬ï¼Œä»¥åŠåˆ©ç”¨ `sqlx migrate run` å°†å˜æ›´åº”ç”¨åˆ°å®é™…æ•°æ®åº“çš„å…¨è¿‡ç¨‹ã€‚

è¿™ä¸€å¥—æ ‡å‡†åŒ–çš„æµç¨‹ï¼ˆMigration Workflowï¼‰æ˜¯å¤šäººåä½œå’Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„åŸºçŸ³ã€‚æŒæ¡äº†è¿™äº› CLI å‘½ä»¤åï¼Œä½ å°±å¯ä»¥æ”¾å¿ƒåœ°åœ¨ Rust é¡¹ç›®ä¸­å¼•å…¥æ•°æ®åº“ä¾èµ–ï¼Œå¼€å§‹æ„å»ºçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘äº†ã€‚

## å‚è€ƒ

- <https://github.com/launchbadge/sqlx>
- <https://github.com/launchbadge/sqlx/tree/main/sqlx-cli>
- <https://github.com/tokio-rs/axum>
- <https://www.pgcli.com/>
