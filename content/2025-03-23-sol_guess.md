+++
title = "Web3 å¼€å‘å®æˆ˜ï¼šç”¨ Anchor æ‰“é€  Solana çŒœæ•°æ¸¸æˆ"
description = "Web3 å¼€å‘å®æˆ˜ï¼šç”¨ Anchor æ‰“é€  Solana çŒœæ•°æ¸¸æˆ"
date = 2025-03-23 15:23:17+08:00
[taxonomies]
categories = ["Solana", "Web3"]
tags = ["Solana", "Web3"]

+++

<!-- more -->

# Web3 å¼€å‘å®æˆ˜ï¼šç”¨ Anchor æ‰“é€  Solana çŒœæ•°æ¸¸æˆ
åœ¨ Web3 æµªæ½®å¸­å·å…¨çƒçš„ä»Šå¤©ï¼ŒSolana ä»¥å…¶è¶…é«˜çš„äº¤æ˜“é€Ÿåº¦å’Œä½å»‰çš„æˆæœ¬ï¼Œæˆä¸ºåŒºå—é“¾å¼€å‘è€…çš„çƒ­é—¨é€‰æ‹©ã€‚è€Œ Anchor æ¡†æ¶ä½œä¸º Solana ç”Ÿæ€çš„åˆ©å™¨ï¼Œè®©æ™ºèƒ½åˆçº¦å¼€å‘å˜å¾—ç®€å•åˆé«˜æ•ˆã€‚æœ¬æ–‡å°†å¸¦ä½ èµ°è¿› Web3 å¼€å‘çš„ä¸–ç•Œï¼Œé€šè¿‡ä¸€ä¸ªæœ‰è¶£çš„çŒœæ•°æ¸¸æˆå®æˆ˜æ¡ˆä¾‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•åˆ©ç”¨ Anchor åœ¨ Solana ä¸Šæ„å»ºé“¾ä¸Šåº”ç”¨ã€‚æ— è®ºä½ æ˜¯æƒ³å…¥é—¨ Web3ï¼Œè¿˜æ˜¯å¸Œæœ›æŒæ¡ Solana å¼€å‘çš„å®ç”¨æŠ€å·§ï¼Œè¿™ç¯‡æ–‡ç« éƒ½å°†æ˜¯ä½ å¼€å¯åŒºå—é“¾ä¹‹æ—…çš„ç»ä½³èµ·ç‚¹ï¼

æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ Web3 å¼€å‘å®æˆ˜æ¡ˆä¾‹ï¼Œè¯¦ç»†å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Anchor æ¡†æ¶åœ¨ Solana åŒºå—é“¾ä¸Šæ„å»ºå¹¶éƒ¨ç½²ä¸€ä¸ªçŒœæ•°æ¸¸æˆã€‚å†…å®¹æ¶µç›– Anchor çš„å®‰è£…ä¸æ ¸å¿ƒå‘½ä»¤ï¼ˆå¦‚ initã€buildã€deploy ç­‰ï¼‰çš„ä½¿ç”¨æ–¹æ³•ï¼Œæ·±å…¥è§£æé«˜çº§åŠŸèƒ½ï¼ˆå¦‚ verify å’Œ upgradeï¼‰ï¼Œå¹¶æä¾›ä»ä»£ç ç¼–å†™åˆ°æœ¬åœ°æµ‹è¯•ç½‘ç»œéƒ¨ç½²çš„å…¨æµç¨‹æŒ‡å¯¼ã€‚æ­¤å¤–ï¼Œè¿˜åˆ†äº«äº†å¼€å‘ä¸­å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©è¯»è€…å¿«é€Ÿä¸Šæ‰‹ã€‚é€šè¿‡è¿™ä¸ªæ¡ˆä¾‹ï¼Œä½ å°†æŒæ¡ Web3 å¼€å‘çš„å…³é”®æŠ€èƒ½ï¼Œè§£é” Solana çš„æ— é™å¯èƒ½ã€‚

## å®‰è£…
è¦åœ¨ Solana ä¸Šä½¿ç”¨ Anchor å¼€å‘ï¼Œé¦–å…ˆéœ€è¦å®‰è£…å¿…è¦çš„å·¥å…·ã€‚ä»¥ä¸‹æ˜¯ç®€æ˜çš„å®‰è£…æ­¥éª¤ï¼Œæ›´å¤šç»†èŠ‚å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šAnchor å®‰è£…æŒ‡å—ï¼š
https://www.anchor-lang.com/docs/installation
### å…·ä½“æ­¥éª¤
1. å®‰è£… Rust å’Œ Cargo

Anchor ä¾èµ– Rust ç¼–ç¨‹è¯­è¨€ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼š
```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```
å®‰è£…å®Œæˆåï¼Œæ£€æŸ¥ç‰ˆæœ¬ï¼š
```bash
rustc --version  # ç¤ºä¾‹è¾“å‡ºï¼šrustc 1.87.0-nightly (be73c1f46 2025-03-21)
cargo --version  # ç¤ºä¾‹è¾“å‡ºï¼šcargo 1.87.0-nightly (6cf826701 2025-03-14)
```
2. å®‰è£… Solana CLI

Solana å·¥å…·é“¾æ˜¯éƒ¨ç½²å’Œæµ‹è¯•çš„åŸºç¡€ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```bash
sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
```
éªŒè¯å®‰è£…ï¼š
```bash
solana --version  # ç¤ºä¾‹è¾“å‡ºï¼šsolana-cli 2.1.16
```
3. å®‰è£… Anchor CLI

ä½¿ç”¨ Cargo å®‰è£… Anchor çš„å‘½ä»¤è¡Œå·¥å…·ï¼š
```bash
cargo install --git https://github.com/coral-xyz/anchor anchor-cli --locked
```
æ£€æŸ¥ç‰ˆæœ¬ï¼š
```bash
anchor --version  # ç¤ºä¾‹è¾“å‡ºï¼šanchor-cli 0.30.1
```
æ³¨æ„äº‹é¡¹
- ç¡®ä¿ç½‘ç»œç•…é€šï¼Œå®‰è£…è¿‡ç¨‹ä¸­å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚
- å¦‚æœé‡åˆ°ç‰ˆæœ¬å…¼å®¹é—®é¢˜ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£è°ƒæ•´å·¥å…·ç‰ˆæœ¬ã€‚

4. æ£€æŸ¥å®‰è£…æƒ…å†µ
```bash
rustc --version
rustc 1.87.0-nightly (be73c1f46 2025-03-21)

cargo --version
cargo 1.87.0-nightly (6cf826701 2025-03-14)

anchor --version
anchor-cli 0.30.1
```



## Anchor å¸¸ç”¨å‘½ä»¤è¯¦è§£

### åˆ›å»ºæ–°é¡¹ç›®

```bash
anchor init my_project
```

### æ„å»ºç¼–è¯‘ç¨‹åº

```bash
anchor build [my_project]
```

å®ƒä¼šåœ¨`target/deploy`ç›®å½•ä¸‹ç”Ÿæˆç¼–è¯‘åçš„åˆçº¦äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¦‚æœåœ¨é¡¹ç›®ç›®å½•ä¸‹å¯ä»¥çœç•¥é¡¹ç›®åç§°ã€‚

### æµ‹è¯•

```bash
anchor test
```

### éƒ¨ç½²

```bash
anchor deploy
```

### æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯

```bash
anchor help
Usage: anchor [OPTIONS] <COMMAND>

Commands:
  init      Initializes a workspace
  build     Builds the workspace
  expand    Expands macros (wrapper around cargo expand)
  verify    Verifies the on-chain bytecode matches the locally compiled artifact. Run this command inside a program subdirectory, i.e., in the dir containing the program's Cargo.toml
  test      Runs integration tests
  new       Creates a new program
  idl       Commands for interacting with interface definitions
  clean     Remove all artifacts from the target directory except program keypairs
  deploy    Deploys each program in the workspace
  migrate   Runs the deploy migration script
  upgrade   Deploys, initializes an IDL, and migrates all in one command. Upgrades a single program. The configured wallet must be the upgrade authority
  cluster   Cluster commands
  shell     Starts a node shell with an Anchor client setup according to the local config
  run       Runs the script defined by the current workspace's Anchor.toml
  login     Saves an api token from the registry locally
  publish   Publishes a verified build to the Anchor registry
  keys      Keypair commands
  localnet  Localnet commands
  account   Fetch and deserialize an account using the IDL provided
  help      Print this message or the help of the given subcommand(s)

Options:
      --provider.cluster <CLUSTER>  Cluster override
      --provider.wallet <WALLET>    Wallet override
  -h, --help                        Print help
  -V, --version                     Print version
```

### **æŸ¥çœ‹** `migrate`æŒ‡ä»¤çš„è¯¦ç»†ä¿¡æ¯

```bash
anchor help migrate
Runs the deploy migration script

Usage: anchor migrate [OPTIONS]

Options:
      --provider.cluster <CLUSTER>  Cluster override
      --provider.wallet <WALLET>    Wallet override
  -h, --help                        Print help
```

**æŸ¥çœ‹** `migrate`æŒ‡ä»¤çš„è¯¦ç»†ä¿¡æ¯

```bash
anchor help deploy
Deploys each program in the workspace

Usage: anchor deploy [OPTIONS] [-- <SOLANA_ARGS>...]

Arguments:
  [SOLANA_ARGS]...  Arguments to pass to the underlying `solana program deploy` command

Options:
  -p, --program-name <PROGRAM_NAME>        Only deploy this program
      --provider.cluster <CLUSTER>         Cluster override
      --program-keypair <PROGRAM_KEYPAIR>  Keypair of the program (filepath) (requires program-name)
      --provider.wallet <WALLET>           Wallet override
  -v, --verifiable                         If true, deploy from path target/verifiable
  -h, --help                               Print help
```

### **anchor init** **å’Œ** **anchor new** **æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

åœ¨ Anchor æ¡†æ¶ä¸­ï¼Œanchor init å’Œ anchor new éƒ½æ˜¯ç”¨äºåˆ›å»ºé¡¹ç›®çš„å‘½ä»¤ï¼Œä½†å®ƒä»¬çš„ç”¨é€”å’Œä½¿ç”¨åœºæ™¯æœ‰æ‰€ä¸åŒï¼š

1. `anchor init`  Initializes a workspace

   è¯¥å‘½ä»¤ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Anchor å·¥ä½œç©ºé—´ã€‚å®ƒä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«åŸºæœ¬é¡¹ç›®ç»“æ„å’Œå¿…è¦é…ç½®æ–‡ä»¶ï¼ˆå¦‚ Anchor.tomlï¼‰çš„å·¥ä½œç©ºé—´ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦æŒ‡å®šå·¥ä½œç©ºé—´çš„åç§°ï¼Œä¾‹å¦‚ï¼š  

   ```bash
   anchor init my_workspace
   ```

   å…¶ä¸­ï¼Œmy_workspace æ˜¯ä½ å®šä¹‰çš„å·¥ä½œç©ºé—´åç§°ã€‚æ‰§è¡Œåï¼Œå°†åˆ›å»ºä¸€ä¸ªåŸºç¡€ç›®å½•ï¼Œæ–¹ä¾¿åç»­å¼€å‘ã€‚

2. `anchor new`  Creates a new program
   è¯¥å‘½ä»¤ç”¨äºåœ¨å·²æœ‰å·¥ä½œç©ºé—´å†…åˆ›å»ºä¸€ä¸ªæ–°çš„ Anchor ç¨‹åºï¼ˆå³ Solana æ™ºèƒ½åˆçº¦ï¼‰ã€‚å®ƒä¼šç”Ÿæˆç¨‹åºç›¸å…³çš„ç›®å½•å’Œæ–‡ä»¶ï¼ˆå¦‚ Rust æºä»£ç å’Œæµ‹è¯•æ–‡ä»¶ï¼‰ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦æŒ‡å®šç¨‹åºåç§°ï¼Œä¾‹å¦‚ï¼š  

   bash

   ```bash
   anchor new my_program
   ```

   å…¶ä¸­ï¼Œmy_program æ˜¯æ–°ç¨‹åºçš„åç§°ã€‚æ³¨æ„ï¼Œæ­¤å‘½ä»¤éœ€åœ¨å·²åˆå§‹åŒ–çš„å·¥ä½œç©ºé—´ä¸­è¿è¡Œã€‚

**å…¸å‹ç”¨æ³•**ï¼šé€šå¸¸ï¼Œä½ ä¼šå…ˆä½¿ç”¨ anchor init åˆå§‹åŒ–ä¸€ä¸ªå·¥ä½œç©ºé—´ï¼Œç„¶ååœ¨è¯¥å·¥ä½œç©ºé—´å†…é€šè¿‡ anchor new åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªç¨‹åºã€‚è¿™ç§åˆ†æ­¥æ“ä½œèƒ½æœ‰æ•ˆç»„ç»‡é¡¹ç›®ç»“æ„ï¼Œç¡®ä¿å¼€å‘æµç¨‹æ¸…æ™°æœ‰åºã€‚

### anchor verify æŒ‡ä»¤çš„ä½œç”¨ä¸ç”¨æ³•

`anchor verify` æ˜¯ Anchor æ¡†æ¶ä¸­çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºéªŒè¯å·²éƒ¨ç½²åˆ° Solana åŒºå—é“¾ä¸Šçš„ç¨‹åºå­—èŠ‚ç æ˜¯å¦ä¸æœ¬åœ°ç¼–è¯‘çš„æ„ä»¶ï¼ˆartifactï¼‰ä¸€è‡´ã€‚å…¶ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿é“¾ä¸Šç¨‹åºä¸å¼€å‘è€…æœ¬åœ°ä»£ç ç‰ˆæœ¬åŒ¹é…ï¼Œä»è€Œæå‡ç¨‹åºçš„å®‰å…¨æ€§ä¸é€æ˜åº¦ã€‚è¯¥å‘½ä»¤é€šå¸¸åœ¨ç¨‹åºéƒ¨ç½²åä½¿ç”¨ï¼Œå°¤å…¶é€‚ç”¨äºéœ€è¦å®¡è®¡æˆ–å‘ç¤¾åŒºè¯æ˜ä»£ç ä¸€è‡´æ€§çš„åœºæ™¯ã€‚

#### ä½œç”¨

- **ä¸€è‡´æ€§éªŒè¯**ï¼šæ¯”è¾ƒé“¾ä¸Šç¨‹åºå­—èŠ‚ç ä¸æœ¬åœ°ç¼–è¯‘ç»“æœï¼Œç¡®ä¿ä¸¤è€…å®Œå…¨ç›¸åŒï¼Œé¿å…éƒ¨ç½²é”™è¯¯æˆ–ç¯¡æ”¹ã€‚
- **å¯éªŒè¯æ„å»ºæ”¯æŒ**ï¼šé…åˆ `anchor build --verifiable` ä½¿ç”¨ï¼ŒéªŒè¯é“¾ä¸Šç¨‹åºæ˜¯å¦æ¥è‡ªå¯é‡ç°çš„æ„å»ºã€‚
- **å¢å¼ºä¿¡ä»»**ï¼šä¸ºå¼€å‘è€…æä¾›å·¥å…·ï¼Œç¡®ä¿æœ¬åœ°å¼€å‘çš„æ™ºèƒ½åˆçº¦ä¸é“¾ä¸Šç‰ˆæœ¬ä¸€è‡´ï¼Œé€‚ç”¨äºå¼€æºé¡¹ç›®æˆ–é«˜å®‰å…¨æ€§éœ€æ±‚åœºæ™¯ã€‚

#### ä½¿ç”¨æ–¹æ³•

åŸºæœ¬è¯­æ³•ï¼š

```bash
anchor verify --provider.cluster <CLUSTER> -p <PROGRAM_NAME> <PROGRAM_ID>
```

- --provider.cluster <CLUSTER>ï¼šæŒ‡å®šç›®æ ‡é›†ç¾¤ï¼ˆå¦‚ devnetã€mainnetï¼‰ã€‚
- -p <PROGRAM_NAME>ï¼šæŒ‡å®šç¨‹åºåç§°ï¼ˆä¸ Cargo.toml ä¸­çš„åº“åä¸€è‡´ï¼‰ã€‚
- <PROGRAM_ID>ï¼šé“¾ä¸Šç¨‹åºçš„å…¬é’¥åœ°å€ã€‚

**è¿è¡Œå‰æ**ï¼šéœ€åœ¨åŒ…å« Cargo.toml çš„ç¨‹åºç›®å½•ä¸­æ‰§è¡Œã€‚

#### **ç¤ºä¾‹**ï¼š

```bash
anchor verify --provider.cluster devnet -p my_program 3ynNB373Q3VAzKp7m4x238po36hjAGFXFJB4ybN2iTyg
```

##### æ‰§è¡Œæ­¥éª¤

1. **æ£€æŸ¥ç¨‹åº ID**ï¼šç¡®è®¤é“¾ä¸Šç¨‹åº ID ä¸æœ¬åœ°é¢„æœŸä¸€è‡´ã€‚
2. **é‡æ–°ç¼–è¯‘**ï¼šåœ¨ Docker å®¹å™¨ä¸­åŸºäºæœ¬åœ°ä»£ç é‡æ–°æ„å»ºç¨‹åºï¼Œç¡®ä¿ç¯å¢ƒæ ‡å‡†åŒ–ã€‚
3. **å­—èŠ‚ç å¯¹æ¯”**ï¼šå°†æœ¬åœ°ç¼–è¯‘çš„ .so æ–‡ä»¶ä¸é“¾ä¸Šå­—èŠ‚ç é€ä¸€æ¯”è¾ƒã€‚
4. **ç»“æœè¾“å‡º**ï¼šè‹¥åŒ¹é…ï¼ŒéªŒè¯é€šè¿‡ï¼›å¦åˆ™æç¤ºå¤±è´¥ã€‚

#### æ³¨æ„äº‹é¡¹

- **æ„å»ºæ¨¡å¼**ï¼šç¨‹åºéœ€ä»¥ --verifiable æ¨¡å¼æ„å»ºå¹¶éƒ¨ç½²ï¼Œå¦åˆ™éªŒè¯å¯èƒ½å› ç¯å¢ƒå·®å¼‚å¤±è´¥ã€‚
- **ç¯å¢ƒä¾èµ–**ï¼šéœ€å®‰è£… Dockerï¼Œå¹¶ç¡®ä¿ç½‘ç»œå¯è®¿é—®æŒ‡å®šé›†ç¾¤ã€‚
- **ä»£ç ç‰ˆæœ¬**ï¼šæœ¬åœ°ä»£ç éœ€ä¸éƒ¨ç½²æ—¶çš„æäº¤ç‰ˆæœ¬ä¸€è‡´ï¼ˆå¦‚é€šè¿‡ git checkout <COMMIT_HASH> åˆ‡æ¢ï¼‰ã€‚

#### å®é™…åº”ç”¨

- **è°ƒè¯•ä¸æ’æŸ¥**ï¼šæ£€æŸ¥é“¾ä¸Šç¨‹åºå¼‚å¸¸æ—¶ï¼ŒéªŒè¯æ˜¯å¦éƒ¨ç½²äº†æ­£ç¡®ç‰ˆæœ¬ã€‚
- **å®¡è®¡ä¸é€æ˜åº¦**ï¼šä¾¿äºå®¡è®¡äººå‘˜æˆ–ç”¨æˆ·ç‹¬ç«‹éªŒè¯é“¾ä¸Šç¨‹åºä¸æºä»£ç çš„ä¸€è‡´æ€§ã€‚
- **éƒ¨ç½²åæ£€æŸ¥**ï¼šå‡å°‘å› ç¼–è¯‘æˆ–ç¯å¢ƒé—®é¢˜å¯¼è‡´çš„æ½œåœ¨é”™è¯¯ã€‚

é€šè¿‡ anchor verifyï¼Œå¼€å‘è€…å¯ä»¥ç¡®ä¿æœ¬åœ°å¼€å‘çš„ Solana ç¨‹åºä¸é“¾ä¸Šéƒ¨ç½²ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œæ˜¯ç»´æŠ¤é¡¹ç›®å¯ä¿¡åº¦å’Œå®‰å…¨æ€§çš„é‡è¦å·¥å…·ã€‚

### anchor upgrade æŒ‡ä»¤çš„ä½œç”¨

`anchor upgrade` æ˜¯ Anchor æ¡†æ¶ä¸­çš„ä¸€ä¸ªå‘½ä»¤ï¼Œç”¨äºä¸€æ¬¡æ€§å‡çº§å•ä¸ª Solana ç¨‹åºã€‚å®ƒé›†æˆäº†ç¨‹åºéƒ¨ç½²ã€æ¥å£å®šä¹‰ï¼ˆIDLï¼‰åˆå§‹åŒ–ä»¥åŠè¿ç§»æ‰§è¡Œçš„å…¨è¿‡ç¨‹ï¼Œä¸»è¦é’ˆå¯¹ç‰¹å®šç¨‹åºçš„æ›´æ–°ï¼Œè€Œéæ•´ä¸ªå·¥ä½œç©ºé—´ã€‚ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒåŠŸèƒ½å’Œæ‰§è¡Œæ­¥éª¤ï¼š

#### ä½œç”¨

- **ç¨‹åºå‡çº§**ï¼šå°†æœ€æ–°ç‰ˆæœ¬çš„ç¨‹åºéƒ¨ç½²åˆ° Solana åŒºå—é“¾ï¼Œæ›¿æ¢æ—§ç‰ˆæœ¬ã€‚
- **æ¥å£åˆå§‹åŒ–**ï¼šæ›´æ–°é“¾ä¸Šçš„æ¥å£å®šä¹‰ï¼ˆIDLï¼‰ï¼Œç¡®ä¿å®¢æˆ·ç«¯èƒ½æ­£ç¡®äº¤äº’ã€‚
- **æ•°æ®è¿ç§»**ï¼šæ‰§è¡Œè¿ç§»è„šæœ¬ï¼Œå®ç°æ–°æ—§ç‰ˆæœ¬é—´çš„çŠ¶æ€è¿‡æ¸¡å’Œå…¼å®¹æ€§ã€‚

#### æ‰§è¡Œæ­¥éª¤

1. **éƒ¨ç½²æœ€æ–°ç¨‹åºç‰ˆæœ¬**
   å°†æœ¬åœ°ç¼–è¯‘çš„ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ åˆ° Solana åŒºå—é“¾ï¼Œè¦†ç›–ä¹‹å‰çš„ç¨‹åºå®ä¾‹ï¼Œå®Œæˆé“¾ä¸Šä»£ç æ›´æ–°ã€‚
2. **åˆå§‹åŒ–æ¥å£å®šä¹‰ï¼ˆIDLï¼‰**
   éƒ¨ç½²ç¨‹åºçš„æ¥å£å®šä¹‰è¯­è¨€ï¼ˆIDLï¼‰ï¼Œå®šä¹‰æ•°æ®ç»“æ„ã€æ–¹æ³•å’Œäº‹ä»¶ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯è§£æå¹¶ä¸ç¨‹åºäº¤äº’ã€‚
3. **æ‰§è¡Œè¿ç§»è„šæœ¬**
   è¿è¡Œé¢„å®šä¹‰çš„è¿ç§»é€»è¾‘ï¼ˆå¦‚æ›´æ–°å­˜å‚¨ç»“æ„æˆ–è¿ç§»æ•°æ®ï¼‰ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬ç¨‹åºä¸æ—§ç‰ˆçŠ¶æ€æ— ç¼è¡”æ¥ã€‚

#### ä½¿ç”¨åœºæ™¯

anchor upgrade é€‚ç”¨äºéœ€è¦æ›´æ–°å•ä¸€ç¨‹åºçš„æƒ…å†µï¼Œä¾‹å¦‚ä¿®å¤ Bugã€æ·»åŠ åŠŸèƒ½æˆ–ä¼˜åŒ–æ€§èƒ½æ—¶ã€‚é€šè¿‡é›†æˆéƒ¨ç½²ã€IDL åˆå§‹åŒ–å’Œè¿ç§»æ­¥éª¤ï¼Œè¯¥å‘½ä»¤ç®€åŒ–äº†å‡çº§æµç¨‹ï¼Œç¡®ä¿ç¨‹åºåœ¨é“¾ä¸Šçš„å¹³æ»‘è¿‡æ¸¡ã€‚

## å®æ“ Solana çŒœæ•°æ¸¸æˆ

### Solana ç¨‹åºåˆå§‹åŒ–

- å¯¼å…¥ Anchor ä¾èµ–
- å£°æ˜ç¨‹åºIDï¼šä½¿ç”¨ declare_id! å®æ¥æŒ‡å®šç¨‹åºçš„é“¾ä¸Šåœ°å€ï¼Œå³ç¨‹åº IDï¼ˆProgram IDï¼‰
- å®šä¹‰ Solana ç¨‹åºæ¨¡å—

```rust
use anchor_lang::prelude::*;

declare_id!("4RzWwFZU8c4iPgRqioET5AcKXNmVdNwJ36SGZqhsJ8v5");

#[program]
pub mod sol_guess {
    use super::*;
}
```

### å®ç°ç”Ÿæˆéšæœºæ•°åŠŸèƒ½

- å®šä¹‰éšæœºæ•°ç”Ÿæˆå‡½æ•°
- å¯¼å…¥ Solana ç¨‹åºåº“ä¸­çš„ **Clock** æ¨¡å—
- è·å–å½“å‰æ—¶é—´
- ç”Ÿæˆéšæœºæ•°
- å¤„ç†éšæœºæ•°

æ³¨æ„ï¼šSolana çš„ Clock æ¨¡å—å¹¶ä¸æ˜¯ç»å¯¹ç²¾ç¡®çš„ç°å®æ—¶é—´åæ˜ ï¼Œè€Œæ˜¯ç½‘ç»œå…±è¯†ä¸‹çš„ä¼°è®¡å€¼ã€‚

```rust
use solana_program::clock::Clock;

fn generate_random_number() -> u32 {
    let clock = Clock::get().expect("Failed to get clock");
    let last_digit = (clock.unix_timestamp % 10) as u8;
    let result = (last_digit + 1) as u32;
    result
}
```

**%**ï¼šå–æ¨¡è¿ç®—ã€‚

**as**ï¼šç±»å‹è½¬æ¢

### å®šä¹‰ç©å®¶è´¦æˆ·

- å®šä¹‰çŒœæ•°ç»“æ„ä½“
- æ·»åŠ éšæœºæ•°å­—æ®µ
- å®šä¹‰ç¨‹åºè´¦æˆ·ç»“æ„ä½“
- æ·»åŠ ç©å®¶çŒœæ•°å­—æ®µ
- å®Œå–„ç¨‹åºè´¦æˆ·ç»“æ„ä½“çš„å…¶ä»–å­—æ®µ

`#[account]` æ˜¯ `Anchor` æ¡†æ¶ä¸­ç”¨äºæ ‡æ³¨ç»“æ„ä½“ï¼ˆstructï¼‰çš„å®ï¼Œè¡¨ç¤ºè¿™ä¸ªç»“æ„ä½“ä»£è¡¨ä¸€ä¸ª Solana è´¦æˆ·ã€‚å®ƒä¼šè‡ªåŠ¨ç”Ÿæˆè´¦æˆ·çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–é€»è¾‘ï¼Œå¹¶æ”¯æŒè´¦æˆ·çš„åˆå§‹åŒ–å’Œçº¦æŸã€‚

`#[derive(Accounts)]` æ˜¯ä¸€ä¸ª `Anchor` æä¾›çš„å®ï¼Œä½œç”¨äºç»“æ„ä½“ï¼ˆstructï¼‰ï¼Œç”¨äºå£°æ˜æŸä¸ªæŒ‡ä»¤ï¼ˆinstructionï¼‰éœ€è¦çš„è´¦æˆ·åˆ—è¡¨ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆååºåˆ—åŒ–å’ŒéªŒè¯é€»è¾‘ã€‚

```rust
#[account]
pub struct GuessingAccount {
    pub number: u32,
}

#[derive(Accounts)]
pub struct AccountContext<'info> {
    #[account(
        init_if_needed, // init_if_neededï¼šå¦‚æœè´¦æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒ
        space=8+4, // space=8+4ï¼šåˆ†é… 12 ä¸ªå­—èŠ‚ï¼ˆ8 å­—èŠ‚ç”¨äºåŒºåˆ†ç¬¦ + 4 å­—èŠ‚ç”¨äºæ•°æ®ï¼‰
        payer=payer, // payer=payerï¼šæŒ‡å®šè°ä¸ºè´¦æˆ·åˆ›å»ºä»˜è´¹
        seeds = [b"guessing pda"], // seeds = [b"guessing pda"]ï¼šå®šä¹‰ç¨‹åºæ´¾ç”Ÿåœ°å€ï¼ˆPDAï¼‰çš„ç§å­
        bump // bumpï¼šä½¿ç”¨ä¸€ä¸ª bump ç§å­æ¥æ´¾ç”Ÿ PDA
    )]
    pub guessing_account: Account<'info, GuessingAccount>,
    #[account(mut)]
    pub payer: Signer<'info>,
    pub system_program: Program<'info, System>,
}
```

### å®ç°ç©å®¶çŒœæ•°åŠŸèƒ½

- ç¼–å†™åˆå§‹åŒ–éšæœºæ•°çš„å‡½æ•°
- ä¸ºæ¸¸æˆç”Ÿæˆä¸€ä¸ªéšæœºç›®æ ‡æ•°å­—
- å®ç°çŒœæ•°å‡½æ•°

```rust
use std::cmp::Ordering;

pub fn initialize(ctx: Context<AccountContext>) -> Result<()> {
    let guessing_account = &mut ctx.accounts.guessing_account;
    guessing_account.number = generate_random_number();

    Ok(())
}

pub fn guess(ctx: Context<AccountContext>, number: u32) -> Result<()> {
    let guessing_account = &mut ctx.accounts.guessing_account;
    let target = guessing_account.number;

    match number.cmp(&target) {
        Ordering::Less => return err!(MyError::NumberTooSmall),
        Ordering::Greater => {
            return err!(MyError::NumberTooLarge);
        }
        Ordering::Equal => return Ok(()),
    }
}

#[error_code]
pub enum MyError {
    #[msg("Too small")]
    NumberTooSmall,
    #[msg("Too largest")]
    NumberTooLarge,
}
```

### å®Œæ•´ä»£ç 

```rust
use anchor_lang::prelude::*;
use anchor_lang::solana_program::clock::Clock;
use anchor_lang::solana_program::sysvar::Sysvar;

declare_id!("DscJp1fdxHqWKhAu8zhkBiUhhbAmG8BU5QcjRyALcSgL");

#[program]
pub mod sol_guess {
    use super::*;
    use std::cmp::Ordering;

    pub fn initialize(ctx: Context<AccountContext>) -> Result<()> {
        let guessing_account = &mut ctx.accounts.guessing_account;
        guessing_account.number = generate_random_number();

        Ok(())
    }

    pub fn guess(ctx: Context<AccountContext>, number: u32) -> Result<()> {
        let guessing_account = &mut ctx.accounts.guessing_account;
        let target = guessing_account.number;

        match number.cmp(&target) {
            Ordering::Less => return err!(MyError::NumberTooSmall),
            Ordering::Greater => {
                return err!(MyError::NumberTooLarge);
            }
            Ordering::Equal => return Ok(()),
        }
    }
}

fn generate_random_number() -> u32 {
    let clock = Clock::get().expect("Failed to get clock");
    let last_digit = (clock.unix_timestamp % 10) as u8;
    let result = (last_digit + 1) as u32;
    result
}

#[account]
pub struct GuessingAccount {
    pub number: u32,
}

#[derive(Accounts)]
pub struct AccountContext<'info> {
    #[account(
        init_if_needed,
        space=8+4,
        payer=payer,
        seeds = [b"guessing pda"],
        bump
    )]
    pub guessing_account: Account<'info, GuessingAccount>,
    #[account(mut)]
    pub payer: Signer<'info>,
    pub system_program: Program<'info, System>,
}

#[error_code]
pub enum MyError {
    #[msg("Too small")]
    NumberTooSmall,
    #[msg("Too largest")]
    NumberTooLarge,
}

```

### å°†æ¸¸æˆéƒ¨ç½²åˆ° Solana æœ¬åœ°æµ‹è¯•ç½‘ç»œ

å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹

```bash
solana-test-validator
--faucet-sol argument ignored, ledger already exists
Ledger location: test-ledger
Log: test-ledger/validator.log
â   Initializing...                                                                                                                           Waiting for fees to stabilize 1...
Identity: 2WTRcDAP2KYRwMLYHowYEeCqRcx1VHbW6ZmUzAGASt54
Genesis Hash: 6nsaMUBm8mQGy9XRNnd8Vjkr7eiQhivnVdSsLYQfDn2j
Version: 2.2.3
Shred Version: 50437
Gossip Address: 127.0.0.1:1024
TPU Address: 127.0.0.1:1027
JSON RPC URL: http://127.0.0.1:8899
WebSocket PubSub URL: ws://127.0.0.1:8900
â š 00:00:43 | Processed Slot: 584800 | Confirmed Slot: 584800 | Finalized Slot: 584800 | Full Snapshot Slot: 584800 | Incremental Snapshot Slot                                                                                                                                          
```

deploy program

```bash
sol-guess on î‚  master [?] via â¬¢ v22.1.0 via ğŸ¦€ 1.85.1 via ğŸ…’ base 
âœ anchor deploy   

Deploying cluster: http://127.0.0.1:8899
Upgrade authority: /Users/qiaopengjun/.config/solana/id.json
Deploying program "sol_guess"...
Program path: /Users/qiaopengjun/Code/solana-code/2025/SolanaSandbox/sol-guess/target/deploy/sol_guess.so...
Program Id: DscJp1fdxHqWKhAu8zhkBiUhhbAmG8BU5QcjRyALcSgL

Signature: 3FTdGZU8U2Ux2ofQPmprpx68vbDzF1BSpNwRuErDBXDAdmTytNwAVv12h1nSde9oG8VG7y6hCVrVj6UMyDXAjf96

Deploy success

```





### é—®é¢˜è§£å†³

```bash
# é—®é¢˜ä¸€
sol-guess on î‚  master [?] via â¬¢ v22.1.0 via ğŸ¦€ 1.85.1 via ğŸ…’ base 
âœ anchor build
error: not a file: '/Users/qiaopengjun/.local/share/solana/install/releases/stable-a5744e79a3d121364f937673d855c4fe3103a36c/solana-release/bin/sdk/sbf/dependencies/platform-tools/rust/bin/rustc'
# è§£å†³ä¸€
anchor_counter on î‚  master [?] via â¬¢ v22.1.0 via ğŸ¦€ 1.85.1 via ğŸ…’ base 
âœ rm -rf ~/.cache/solana/*
zsh: sure you want to delete all 6 files in /Users/qiaopengjun/.cache/solana [yn]? y

# é—®é¢˜äºŒ
sol-guess on î‚  master [?] via â¬¢ v22.1.0 via ğŸ¦€ 1.85.1 via ğŸ…’ base 
âœ anchor build
error: rustc 1.79.0-dev is not supported by the following package:

                 Note that this is the rustc version that ships with Solana tools and not your system's rustc version. Use `solana-install update` or head over to https://docs.solanalabs.com/cli/install to install a newer version.
  bytemuck_derive@1.9.2 requires rustc 1.84
Either upgrade rustc or select compatible dependency versions with
`cargo update <name>@<current-ver> --precise <compatible-ver>`
where `<compatible-ver>` is the latest version supporting rustc 1.79.0-dev

# è§£å†³äºŒ
ç¬¬ä¸€æ­¥ï¼šåœ¨ cargo.toml ä¸­æ·»åŠ  bytemuck_derive = "=1.8.1"
ç¬¬äºŒæ­¥ï¼šæ¸…ç†ç¼“å­˜
cargo clean
rm -rf ~/.cargo/registry
é‡æ–° anchor build å³å¯

# é—®é¢˜ä¸‰
my-program on î‚  master [?] via â¬¢ v22.1.0 via ğŸ¦€ 1.85.1 via ğŸ…’ base took 11.5s 
âœ anchor deploy
Deploying cluster: https://api.devnet.solana.com
Upgrade authority: /Users/qiaopengjun/.config/solana/id.json
Deploying program "my_program"...
Program path: /Users/qiaopengjun/Code/solana-code/2025/SolanaSandbox/my-program/target/deploy/my_program.so...
Error: Unable to open program file: No such file or directory (os error 2)
There was a problem deploying: Output { status: ExitStatus(unix_wait_status(256)), stdout: "", stderr: "" }.

# è§£å†³ä¸‰
cargo build-sbf --manifest-path=./Cargo.toml --sbf-out-dir=target/deploy

# é—®é¢˜å››
sol-guess on î‚  master [?] via â¬¢ v22.1.0 via ğŸ¦€ 1.85.1 via ğŸ…’ base 
âœ anchor deploy               

Deploying cluster: http://127.0.0.1:8899
Upgrade authority: /Users/qiaopengjun/.config/solana/id.json
Deploying program "sol_guess"...
Program path: /Users/qiaopengjun/Code/solana-code/2025/SolanaSandbox/sol-guess/target/deploy/sol_guess.so...
Error: No new programs can be deployed on loader-v3. Please use the program-v4 subcommand instead.
There was a problem deploying: Output { status: ExitStatus(unix_wait_status(256)), stdout: "", stderr: "" }.

# è§£å†³å››
sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
downloading stable installer
  âœ¨ stable commit a5744e7 initialized
  
 solana --version
solana-cli 2.1.16 (src:a5744e79; feat:3271415109, client:Agave)
```

## æ€»ç»“
é€šè¿‡è¿™åœº Web3 å¼€å‘å®æˆ˜ï¼Œæˆ‘ä»¬ä»é›¶å¼€å§‹ï¼Œåˆ©ç”¨ Anchor æ¡†æ¶åœ¨ Solana ä¸ŠæˆåŠŸæ‰“é€ äº†ä¸€ä¸ªçŒœæ•°æ¸¸æˆã€‚ä»ç¯å¢ƒæ­å»ºåˆ°ä»£ç å®ç°ï¼Œå†åˆ°æœ¬åœ°éƒ¨ç½²ï¼Œæ¯ä¸€æ­¥éƒ½å±•ç¤ºäº† Anchor çš„å¼ºå¤§ä¸ Solana çš„é«˜æ•ˆã€‚æ— è®ºä½ æ˜¯ Web3 æ–°æ‰‹è¿˜æ˜¯è¿›é˜¶å¼€å‘è€…ï¼Œè¿™ä¸ªæ¡ˆä¾‹éƒ½ä¸ºä½ æä¾›äº†ä¸€ä¸ªå¯å¤åˆ¶çš„æ¨¡æ¿ï¼Œè®©ä½ è½»æ¾è¿ˆå…¥åŒºå—é“¾å¼€å‘çš„å®æˆ˜é¢†åŸŸã€‚æœªæ¥ï¼Œä½ å¯ä»¥åŸºäºæ­¤æ‰©å±•æ›´å¤šåˆ›æ„åŠŸèƒ½ï¼Œæ¯”å¦‚æ’è¡Œæ¦œæˆ–ä»£å¸å¥–åŠ±ï¼Œåœ¨ Web3 ä¸–ç•Œä¸­å¤§å±•èº«æ‰‹ã€‚åŠ¨æ‰‹è¯•è¯•å§ï¼Œä½ çš„ä¸‹ä¸€ä¸ªé“¾ä¸Šæ°ä½œå°±åœ¨çœ¼å‰ï¼

## å‚è€ƒ

- https://www.anchor-lang.com/docs/quickstart/local
- https://www.anchor-lang.com/docs/installation
- https://solana.stackexchange.com/questions/13174/anchor-build-fail-due-to-no-platform-tools-rust-lib
- https://docs.anza.xyz/cli/install/
- https://github.com/anza-xyz/agave/
- https://github.com/coral-xyz/anchor/issues/3614
- https://blog.web3idea.xyz/post/blockchain%2Fsolana%2Flearn_solana_contract
- https://stackoverflow.com/questions/71267943/solana-deploy-account-data-too-small-for-instruction
