+++
title = "Web3å®æˆ˜ï¼šSolana CPIå…¨è§£æï¼Œä»Anchorå°è£…åˆ°PDAè½¬è´¦"
description = "Web3å®æˆ˜ï¼šSolana CPIå…¨è§£æï¼Œä»Anchorå°è£…åˆ°PDAè½¬è´¦"
date = 2025-06-07T02:54:55Z
[taxonomies]
categories = ["Web3", "Solana"]
tags = ["Web3", "Solana"]
+++

<!-- more -->

# Web3å®æˆ˜ï¼šSolana CPIå…¨è§£æï¼Œä»Anchorå°è£…åˆ°PDAè½¬è´¦

Web3æ—¶ä»£ï¼ŒSolanaå‡­å€Ÿå…¶é«˜ååé‡å’Œä½æˆæœ¬æˆä¸ºåŒºå—é“¾å¼€å‘çš„çƒ­é—¨é€‰æ‹©ã€‚è·¨ç¨‹åºè°ƒç”¨ï¼ˆCPIï¼‰ä½œä¸ºSolanaæ™ºèƒ½åˆçº¦çš„â€œè¶…çº§è¿æ¥å™¨â€ï¼Œè®©ç¨‹åºåƒæ­ç§¯æœ¨ä¸€æ ·å®ç°æ¨¡å—åŒ–åä½œï¼Œèµ‹èƒ½DeFiã€NFTç­‰å¤æ‚åº”ç”¨ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªåŸºäºAnchoræ¡†æ¶çš„å®æˆ˜é¡¹ç›®ï¼Œå¸¦ä½ ä»é«˜é˜¶å°è£…åˆ°ä½é˜¶æ‰‹åŠ¨æ„å»ºï¼Œå†åˆ°PDAè´¦æˆ·çš„ç‹¬ç‰¹æ“ä½œï¼Œå…¨é¢è§£æSolana CPIçš„å¼€å‘ç²¾é«“ã€‚æ— è®ºä½ æ˜¯Web3æ–°æ‰‹è¿˜æ˜¯èµ„æ·±å¼€å‘è€…ï¼Œè¿™ç¯‡æ•™ç¨‹å°†åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹ï¼Œè§£é”Solanaçš„æ— é™å¯èƒ½ï¼

æœ¬æ–‡é€šè¿‡ä¸€ä¸ªAnchoræ¡†æ¶å¼€å‘çš„Solanaæ™ºèƒ½åˆçº¦é¡¹ç›®ï¼Œæ·±å…¥å‰–æè·¨ç¨‹åºè°ƒç”¨ï¼ˆCPIï¼‰çš„æ ¸å¿ƒåŸç†ä¸å®ç°æ–¹å¼ï¼Œè¦†ç›–äº”ç§SOLè½¬è´¦èŒƒå¼ï¼šAnchoré«˜é˜¶å°è£…ã€åŸç”ŸæŒ‡ä»¤è°ƒç”¨ã€æ‰‹åŠ¨æŒ‡ä»¤æ„å»ºåŠPDAè´¦æˆ·è½¬è´¦ã€‚ç»“åˆè¯¦ç»†ä»£ç è§£æã€Mermaidæµç¨‹å›¾å’Œæµ‹è¯•ç”¨ä¾‹ï¼Œå±•ç¤ºäº†CPIåœ¨æ¨¡å—åŒ–å¼€å‘ä¸­çš„å¼ºå¤§ä¼˜åŠ¿ã€‚æµ‹è¯•ç»“æœéªŒè¯äº†åŠŸèƒ½çš„ç¨³å®šæ€§ï¼Œä¸ºå¼€å‘è€…æä¾›ä»ç†è®ºåˆ°å®è·µçš„å®Œæ•´æŒ‡å¼•ã€‚æ— è®ºä½ æƒ³å¿«é€Ÿä¸Šæ‰‹Web3å¼€å‘è¿˜æ˜¯æ·±å…¥æ¢ç´¢Solana CPIçš„åº•å±‚æœºåˆ¶ï¼Œè¿™ç¯‡å®æˆ˜æ•™ç¨‹éƒ½ä¸å¯é”™è¿‡ï¼

## Cross Program Invocation

Solana çš„è·¨ç¨‹åºè°ƒç”¨ï¼ˆCPIï¼‰æœºåˆ¶å…è®¸æ™ºèƒ½åˆçº¦åƒæ‹¼ç§¯æœ¨ä¸€æ ·ç›¸äº’è°ƒç”¨ï¼Œå®ç°é“¾ä¸ŠåŠŸèƒ½çš„æ¨¡å—åŒ–ç»„åˆï¼šä¾‹å¦‚æ‚¨çš„ DeFi ç¨‹åºåªéœ€é€šè¿‡æ ‡å‡†æ¥å£ï¼ˆæŒ‡å®šç›®æ ‡ç¨‹åºIDã€è´¦æˆ·åˆ—è¡¨å’ŒæŒ‡ä»¤æ•°æ®ï¼‰ï¼Œå³å¯å®‰å…¨è°ƒç”¨ç³»ç»Ÿç¨‹åºå®ŒæˆSOLè½¬è´¦ï¼Œæˆ–é€šè¿‡ç¨‹åºæ´¾ç”Ÿåœ°å€ï¼ˆPDAï¼‰ç­¾åè®©æ— ç§é’¥çš„åˆçº¦è´¦æˆ·è‡ªä¸»æ‰§è¡Œèµ„äº§è½¬ç§»ï¼Œè¿™ç§è®¾è®¡ä½¿å¼€å‘è€…èƒ½å¤Ÿæ„å»ºå¤šå±‚åµŒå¥—çš„å¤æ‚é‡‘èæ“ä½œï¼ˆå¦‚é—ªç”µè´·ä¸­å€Ÿè´·â†’äº¤æ˜“â†’è¿˜æ¬¾çš„åŸå­æ‰§è¡Œï¼‰ï¼ŒåŒæ—¶Anchoræ¡†æ¶çš„ä¸‰å±‚æŠ½è±¡å®ç°ï¼ˆé«˜çº§CpiContextâ†’ä¸­çº§invokeâ†’åº•å±‚æ‰‹åŠ¨æ„å»ºï¼‰ä¸ºä¸åŒåœºæ™¯æä¾›äº†ä»å¿«é€Ÿå¼€å‘åˆ°æ€§èƒ½ä¼˜åŒ–çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ŒçœŸæ­£å®ç°äº†åŒºå—é“¾åŠŸèƒ½çš„å³æ’å³ç”¨å¼ç»„åˆåˆ›æ–°ã€‚

**CPIå°±æ˜¯è®©æ™ºèƒ½åˆçº¦åƒå«å¤–å–ä¸€æ ·ç‚¹å…¶ä»–åˆçº¦çš„åŠŸèƒ½**â€”â€”ä½ ï¼ˆç”¨æˆ·ï¼‰ä¸‹å•ç»™åˆçº¦Aï¼ˆæ¯”å¦‚å€Ÿè´·åˆçº¦ï¼‰ï¼Œåˆçº¦Aè½¬å¤´å°±å«äº†åˆçº¦Bï¼ˆæ¯”å¦‚äº¤æ˜“åˆçº¦ï¼‰çš„æœåŠ¡ï¼Œåˆçº¦Bå¯èƒ½å†å«ç³»ç»Ÿåˆçº¦ä»˜é’±ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸€æ¬¡æå®šï¼

```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant åˆçº¦A
    participant åˆçº¦B
    participant ç³»ç»Ÿåˆçº¦
    
    ç”¨æˆ·->>åˆçº¦A: å‘èµ·äº¤æ˜“ï¼ˆå¦‚å€Ÿæ¬¾ï¼‰
    åˆçº¦A->>åˆçº¦B: CPIè°ƒç”¨ï¼ˆå¦‚å…‘æ¢ä»£å¸ï¼‰
    åˆçº¦B->>ç³»ç»Ÿåˆçº¦: åµŒå¥—CPIï¼ˆå¦‚è½¬è´¦ç»“ç®—ï¼‰
    Note right of ç³»ç»Ÿåˆçº¦: æœ€<br>ç»ˆ<br>æ‰§<br>è¡Œ
    ç³»ç»Ÿåˆçº¦-->>åˆçº¦B: å®Œæˆï¼
    åˆçº¦B-->>åˆçº¦A: å®Œæˆï¼
    åˆçº¦A-->>ç”¨æˆ·: å…¨éƒ¨æå®šï¼
```

![image-20250607103353696](/images/image-20250607103353696.png)

ğŸ’¡ å°±åƒç‚¹å¤–å–ï¼šä½ ï¼ˆç”¨æˆ·ï¼‰â†’ å¹³å°ï¼ˆåˆçº¦Aï¼‰â†’ é¤å…ï¼ˆåˆçº¦Bï¼‰â†’ éª‘æ‰‹ï¼ˆç³»ç»Ÿåˆçº¦ï¼‰ï¼Œä¸€ä¸ªè®¢å•ä¸²è”å¤šä¸ªæœåŠ¡ï¼

## å®æ“

### åˆ›å»ºå¹¶åˆå§‹åŒ–é¡¹ç›®

```bash
anchor init cpi-demo
yarn install v1.22.22
info No lockfile found.
[1/4] ğŸ”  Resolving packages...
warning mocha > glob@7.2.0: Glob versions prior to v9 are no longer supported
warning mocha > glob > inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
[4/4] ğŸ”¨  Building fresh packages...
success Saved lockfile.
âœ¨  Done in 9.48s.
Failed to install node modules
Initialized empty Git repository in /Users/qiaopengjun/Code/Solana/solana-sandbox/cpi-demo/.git/
cpi-demo initialized
```

### åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•

```bash
cd cpi-demo
```

### åˆ—å‡ºå½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶å’Œå­ç›®å½•çš„è¯¦ç»†ä¿¡æ¯

```bash
ls -la
total 152
drwxr-xr-x@  16 qiaopengjun  staff    512 Jun  6 13:29 .
drwxr-xr-x@  22 qiaopengjun  staff    704 Jun  6 13:28 ..
drwxr-xr-x@   9 qiaopengjun  staff    288 Jun  6 13:29 .git
-rw-r--r--@   1 qiaopengjun  staff     67 Jun  6 13:28 .gitignore
-rw-r--r--@   1 qiaopengjun  staff     61 Jun  6 13:28 .prettierignore
-rw-r--r--@   1 qiaopengjun  staff    355 Jun  6 13:28 Anchor.toml
-rw-r--r--@   1 qiaopengjun  staff    215 Jun  6 13:28 Cargo.toml
drwxr-xr-x@   2 qiaopengjun  staff     64 Jun  6 13:28 app
drwxr-xr-x@   3 qiaopengjun  staff     96 Jun  6 13:28 migrations
drwxr-xr-x@ 150 qiaopengjun  staff   4800 Jun  6 13:29 node_modules
-rw-r--r--@   1 qiaopengjun  staff    461 Jun  6 13:28 package.json
drwxr-xr-x@   3 qiaopengjun  staff     96 Jun  6 13:28 programs
drwxr-xr-x@   3 qiaopengjun  staff     96 Jun  6 13:28 target
drwxr-xr-x@   3 qiaopengjun  staff     96 Jun  6 13:28 tests
-rw-r--r--@   1 qiaopengjun  staff    205 Jun  6 13:28 tsconfig.json
-rw-r--r--@   1 qiaopengjun  staff  51940 Jun  6 13:29 yarn.lock
```

### ä½¿ç”¨`cursor` æ‰“å¼€é¡¹ç›®

```bash
cc
# alias cc="open -a cursor ."
```

### æŸ¥çœ‹é¡¹ç›®ç›®å½•

```bash
cpi-demo on î‚  main [?] via â¬¢ v23.11.0 via ğŸ¦€ 1.87.0 took 8.6s 
âœ tree . -L 6 -I "target|test-ledger|.vscode|node_modules"
.
â”œâ”€â”€ Anchor.toml
â”œâ”€â”€ app
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ migrations
â”‚   â””â”€â”€ deploy.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ programs
â”‚   â””â”€â”€ cpi-demo
â”‚       â”œâ”€â”€ Cargo.toml
â”‚       â”œâ”€â”€ src
â”‚       â”‚   â””â”€â”€ lib.rs
â”‚       â””â”€â”€ Xargo.toml
â”œâ”€â”€ tests
â”‚   â””â”€â”€ cpi-demo.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ yarn.lock

7 directories, 11 files

```

### lib.rs æ–‡ä»¶

```rust
#![allow(unexpected_cfgs)]
#![allow(deprecated)]

use anchor_lang::prelude::*;
use anchor_lang::solana_program::instruction::Instruction;
use anchor_lang::solana_program::{program::invoke, system_instruction};
use anchor_lang::system_program::{transfer, Transfer};

declare_id!("Cnh7whdQWo3XxArbNfTuoKGA68KTW7Ytm2yoK3rMp61T");

#[program]
pub mod cpi_demo {
    use anchor_lang::solana_program::program::invoke_signed;

    use super::*;

    pub fn initialize(ctx: Context<Initialize>) -> Result<()> {
        msg!("Greetings from: {:?}", ctx.program_id);
        Ok(())
    }

    pub fn sol_transfer(ctx: Context<SolTransfer>, amount: u64) -> Result<()> {
        let from_pubkey = ctx.accounts.sender.to_account_info();
        let to_pubkey = ctx.accounts.recipient.to_account_info();
        let program_id = ctx.accounts.system_program.to_account_info();

        let cpi_context = CpiContext::new(
            program_id,
            Transfer {
                from: from_pubkey,
                to: to_pubkey,
            },
        );
        transfer(cpi_context, amount)?;
        Ok(())
    }

    pub fn sol_transfer2(ctx: Context<SolTransfer>, amount: u64) -> Result<()> {
        let from_pubkey = ctx.accounts.sender.to_account_info();
        let to_pubkey = ctx.accounts.recipient.to_account_info();
        let program_id = ctx.accounts.system_program.to_account_info();

        let instruction =
            &system_instruction::transfer(&from_pubkey.key(), &to_pubkey.key(), amount);

        invoke(instruction, &[from_pubkey, to_pubkey, program_id])?;
        Ok(())
    }

    pub fn sol_transfer3(ctx: Context<SolTransfer>, amount: u64) -> Result<()> {
        let from_pubkey = ctx.accounts.sender.to_account_info();
        let to_pubkey = ctx.accounts.recipient.to_account_info();
        let program_id = ctx.accounts.system_program.to_account_info();

        // Prepare instruction AccountMetas
        let account_metas = vec![
            AccountMeta::new(from_pubkey.key(), true),
            AccountMeta::new(to_pubkey.key(), false),
        ];

        // SOL transfer instruction discriminator
        let instruction_discriminator: u32 = 2;

        // Prepare instruction data
        let mut instruction_data = Vec::with_capacity(4 + 8);
        instruction_data.extend_from_slice(&instruction_discriminator.to_le_bytes());
        instruction_data.extend_from_slice(&amount.to_le_bytes());

        // Create instruction

        let instruction = Instruction {
            program_id: program_id.key(),
            accounts: account_metas,
            data: instruction_data,
        };

        // Invoke instruction

        invoke(&instruction, &[from_pubkey, to_pubkey, program_id])?;
        Ok(())
    }

    pub fn sol_transfer4(ctx: Context<SolTransfer4>, amount: u64) -> Result<()> {
        let from_pubkey = ctx.accounts.pda_account.to_account_info();
        let to_pubkey = ctx.accounts.recipient.to_account_info();
        let program_id = ctx.accounts.system_program.to_account_info();

        let seed = to_pubkey.key();
        let bump_seed = ctx.bumps.pda_account;
        let signer_seeds: &[&[&[u8]]] = &[&[b"pda", seed.as_ref(), &[bump_seed]]];

        let cpi_context = CpiContext::new(
            program_id,
            Transfer {
                from: from_pubkey,
                to: to_pubkey,
            },
        )
        .with_signer(signer_seeds);
        transfer(cpi_context, amount)?;
        Ok(())
    }

    pub fn sol_transfer5(ctx: Context<SolTransfer4>, amount: u64) -> Result<()> {
        let from_pubkey = ctx.accounts.pda_account.to_account_info();
        let to_pubkey = ctx.accounts.recipient.to_account_info();
        let program_id = ctx.accounts.system_program.to_account_info();

        let seed = to_pubkey.key();
        let bump_seed = ctx.bumps.pda_account;

        let signer_seeds: &[&[&[u8]]] = &[&[b"pda", seed.as_ref(), &[bump_seed]]];

        let instruction =
            &system_instruction::transfer(&from_pubkey.key(), &to_pubkey.key(), amount);

        invoke_signed(
            instruction,
            &[from_pubkey, to_pubkey, program_id],
            signer_seeds,
        )?;
        Ok(())
    }
}

#[derive(Accounts)]
pub struct Initialize {}

#[derive(Accounts)]
pub struct SolTransfer<'info> {
    #[account(mut)]
    sender: Signer<'info>,
    #[account(mut)]
    recipient: SystemAccount<'info>,
    system_program: Program<'info, System>,
}

#[derive(Accounts)]
pub struct SolTransfer4<'info> {
    #[account(
        mut,
        seeds = [b"pda", recipient.key().as_ref()],
        bump,
    )]
    pda_account: SystemAccount<'info>,
    #[account(mut)]
    recipient: SystemAccount<'info>,
    system_program: Program<'info, System>,
}

```

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªä½¿ç”¨ Anchor æ¡†æ¶ç¼–å†™çš„ Solana æ™ºèƒ½åˆçº¦ï¼Œä¸»è¦æ¼”ç¤ºäº†ä¸åŒæ–¹å¼å®ç° **SOL è½¬è´¦çš„è·¨ç¨‹åºè°ƒç”¨ï¼ˆCPIï¼‰**ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š

------

#### æ ¸å¿ƒåŠŸèƒ½

ç¨‹åºåŒ…å«å¤šä¸ªè½¬è´¦æ–¹æ³•ï¼Œå±•ç¤ºä¸åŒå±‚çº§çš„ CPI å®ç°ï¼š

1. **åŸºç¡€è½¬è´¦**ï¼šä½¿ç”¨ Anchor å°è£…æ–¹æ³•
2. **åŸç”ŸæŒ‡ä»¤è°ƒç”¨**ï¼šä½¿ç”¨ Solana åŸç”Ÿæ–¹æ³•
3. **æ‰‹åŠ¨æ„å»ºæŒ‡ä»¤**ï¼šåº•å±‚å­—èŠ‚çº§æ„å»º
4. **PDA è´¦æˆ·è½¬è´¦**ï¼šéœ€è¦ç­¾åçš„ç¨‹åºæ´¾ç”Ÿè´¦æˆ·æ“ä½œ

------

#### æ–¹æ³•è¯¦è§£

#### 1. `initialize()`

- **åŠŸèƒ½**ï¼šåˆå§‹åŒ–åˆçº¦ï¼Œè®°å½•ç¨‹åº ID åˆ°æ—¥å¿—

- ä»£ç ï¼š

  ```rust
  msg!("Greetings from: {:?}", ctx.program_id);
  ```

#### 2. `sol_transfer()` - Anchor å°è£…æ–¹å¼

- **è·¯å¾„**ï¼šæœ€ç®€æ´çš„é«˜å±‚å®ç°
- æµç¨‹ï¼š
  1. è·å–å‘é€è€…ã€æ¥æ”¶è€…å’Œç³»ç»Ÿç¨‹åºçš„è´¦æˆ·ä¿¡æ¯
  2. ä½¿ç”¨ `CpiContext` åˆ›å»ºè½¬è´¦ä¸Šä¸‹æ–‡
  3. è°ƒç”¨ `transfer()` æ–¹æ³•æ‰§è¡Œè½¬è´¦
- **ç‰¹ç‚¹**ï¼šåˆ©ç”¨ Anchor æ¡†æ¶çš„å®‰å…¨æŠ½è±¡

#### 3. `sol_transfer2()` - åŸç”ŸæŒ‡ä»¤è°ƒç”¨

- **è·¯å¾„**ï¼šç›´æ¥è°ƒç”¨ Solana ç³»ç»ŸæŒ‡ä»¤
- æµç¨‹ï¼š
  1. ç”¨ `system_instruction::transfer` æ„å»ºåŸç”ŸæŒ‡ä»¤
  2. ä½¿ç”¨ `invoke()` æ‰§è¡ŒæŒ‡ä»¤
- **ç‰¹ç‚¹**ï¼šç»•è¿‡ Anchor å°è£…ï¼Œç›´æ¥è°ƒç”¨ Solana åº•å±‚

#### 4. `sol_transfer3()` - æ‰‹åŠ¨æ„å»ºæŒ‡ä»¤

- **è·¯å¾„**ï¼šå­—èŠ‚çº§åº•å±‚å®ç°
- æµç¨‹ï¼š
  1. æ‰‹åŠ¨åˆ›å»ºè´¦æˆ·å…ƒæ•°æ® `AccountMeta`
  2. æ‹¼æ¥æŒ‡ä»¤æ•°æ®ï¼ˆæŒ‡ä»¤æ ‡è¯†ç¬¦ + è½¬è´¦é‡‘é¢ï¼‰
  3. æ„å»ºå®Œæ•´çš„ `Instruction` ç»“æ„
  4. é€šè¿‡ `invoke()` æ‰§è¡Œ
- å…³é”®ç‚¹ï¼š
  - `instruction_discriminator: u32 = 2`ï¼šç³»ç»Ÿç¨‹åºçš„è½¬è´¦æŒ‡ä»¤æ ‡è¯†
  - æ•°æ®å¸ƒå±€ï¼š`[æŒ‡ä»¤æ ‡è¯†ç¬¦(4å­—èŠ‚)][é‡‘é¢(8å­—èŠ‚)]`

#### 5. `sol_transfer4()`/`sol_transfer5()` - PDA è´¦æˆ·è½¬è´¦

- **åœºæ™¯**ï¼šä»**ç¨‹åºæ´¾ç”Ÿè´¦æˆ·ï¼ˆPDAï¼‰** å‘èµ·è½¬è´¦
- å…³é”®æŠ€æœ¯ï¼š
  - **PDA è´¦æˆ·**ï¼šé€šè¿‡ç§å­ç”Ÿæˆï¼ˆ`seeds = [b"pda", recipient.key().as_ref()]`)
  - **ç­¾åæˆæƒ**ï¼šä½¿ç”¨ `with_signer` æˆ– `invoke_signed` æä¾› PDA ç­¾å
- åŒºåˆ«ï¼š
  - `sol_transfer4`ï¼šä½¿ç”¨ Anchor çš„ `CpiContext.with_signer`
  - `sol_transfer5`ï¼šç›´æ¥ä½¿ç”¨ `invoke_signed` æ·»åŠ ç­¾å

------

#### è´¦æˆ·ç»“æ„è§£æ

#### 1. `SolTransfer` è´¦æˆ·

- ç”¨äºæ™®é€šè½¬è´¦æ–¹æ³•ï¼ˆ`sol_transfer1-3`ï¼‰

  ```rust
  pub struct SolTransfer<'info> {
      #[account(mut)] // å¯å˜è´¦æˆ·
      sender: Signer<'info>,     // å‘é€è€…ï¼ˆç­¾åè´¦æˆ·ï¼‰
      #[account(mut)] 
      recipient: SystemAccount<'info>, // æ¥æ”¶è€…
      system_program: Program<'info, System> // ç³»ç»Ÿç¨‹åº
  }
  ```

#### 2. `SolTransfer4` è´¦æˆ·

- ç”¨äº PDA è½¬è´¦æ–¹æ³•ï¼ˆ`sol_transfer4/5`ï¼‰

  ```rust
  pub struct SolTransfer4<'info> {
      #[account(
          mut,
          seeds = [b"pda", recipient.key().as_ref()], // PDA ç”Ÿæˆç§å­
          bump // è‡ªåŠ¨æ´¾ç”Ÿ bump
      )]
      pda_account: SystemAccount<'info>, // PDA è´¦æˆ·ä½œä¸ºå‘é€è€…
      #[account(mut)]
      recipient: SystemAccount<'info>,   // æ¥æ”¶è€…
      system_program: Program<'info, System>
  }
  ```

------

#### å…³é”®æ¦‚å¿µ

1. **CPI (Cross-Program Invocation)**ï¼š
   - å…è®¸æ™ºèƒ½åˆçº¦è°ƒç”¨å…¶ä»–ç¨‹åºï¼ˆå¦‚ç³»ç»Ÿç¨‹åºè½¬è´¦ï¼‰
   - å®ç°æ–¹å¼åˆ†å±‚ï¼šAnchorå°è£… â†’ åŸç”Ÿè°ƒç”¨ â†’ å­—èŠ‚çº§æ“ä½œ
2. **PDA (Program Derived Address)**ï¼š
   - ç”±ç¨‹åºæ§åˆ¶çš„ç‰¹æ®Šè´¦æˆ·ï¼ˆæ— ç§é’¥ï¼‰
   - è½¬è´¦æ—¶éœ€é€šè¿‡ `invoke_signed` æä¾›ç¨‹åºç­¾å
3. **æŒ‡ä»¤æ„å»º**ï¼š
   - åº•å±‚ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š
     - `program_id`ï¼šç›®æ ‡ç¨‹åºIDï¼ˆå¦‚ç³»ç»Ÿç¨‹åºï¼‰
     - `accounts`ï¼šè´¦æˆ·å…ƒæ•°æ®åˆ—è¡¨
     - `data`ï¼šåºåˆ—åŒ–çš„æŒ‡ä»¤æ•°æ®

------

#### æ€»ç»“

è¯¥ä»£ç å±•ç¤ºäº† SOL è½¬è´¦çš„ **5 ç§å®ç°èŒƒå¼**ï¼Œæ ¸å¿ƒå·®å¼‚ç‚¹åœ¨äºï¼š

1. **æŠ½è±¡å±‚çº§**ï¼šä»é«˜é˜¶ Anchor å°è£…åˆ°åº•å±‚å­—èŠ‚æ“ä½œ
2. **è´¦æˆ·ç±»å‹**ï¼šæ™®é€šè´¦æˆ· vs PDA ç¨‹åºæ´¾ç”Ÿè´¦æˆ·
3. **ç­¾åæ–¹å¼**ï¼šæ™®é€šç­¾å vs ç¨‹åºç­¾åï¼ˆPDAï¼‰

é€šè¿‡å¯¹æ¯”è¿™äº›æ–¹æ³•ï¼Œå¼€å‘è€…å¯ä»¥æ·±å…¥ç†è§£ Anchor æ¡†æ¶çš„å®‰å…¨æŠ½è±¡æœºåˆ¶å’Œ Solana CPI çš„åº•å±‚åŸç†ã€‚

### ç¼–è¯‘å¹¶æ„å»ºé¡¹ç›®

```bash
cpi-demo on î‚  main [?] via â¬¢ v23.11.0 via ğŸ¦€ 1.87.0 took 5.7s 
âœ anchor build 
    Finished `release` profile [optimized] target(s) in 0.32s
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.33s
     Running unittests src/lib.rs (/Users/qiaopengjun/Code/Solana/solana-sandbox/cpi-demo/target/debug/deps/cpi_demo-a7bb659c1f2ea15a)

```

### cpi-demo.ts æµ‹è¯•ä»£ç 

```ts
import * as anchor from "@coral-xyz/anchor";
import { Program, BN } from "@coral-xyz/anchor";
import { CpiDemo } from "../target/types/cpi_demo";
import {
  Keypair,
  LAMPORTS_PER_SOL,
  PublicKey,
  SystemProgram,
  Transaction,
  sendAndConfirmTransaction,
} from "@solana/web3.js";

describe("cpi-demo", () => {
  // Configure the client to use the local cluster.
  const provider = anchor.AnchorProvider.env();
  anchor.setProvider(provider);

  const program = anchor.workspace.cpiDemo as Program<CpiDemo>;
  const wallet = provider.wallet as anchor.Wallet;
  const connection = provider.connection;

  const sender = anchor.web3.Keypair.generate();
  const recipient = anchor.web3.Keypair.generate();
  beforeEach(async () => {
    await getBalances(
      wallet.publicKey,
      sender.publicKey,
      "wallet sender Resulting"
    );
    // Fund accounts
    await airdrop(wallet.publicKey, 5 * LAMPORTS_PER_SOL);
    await airdrop(sender.publicKey, 5 * LAMPORTS_PER_SOL);
    await airdrop(recipient.publicKey, 5 * LAMPORTS_PER_SOL);
  });
  async function airdrop(pubkey: PublicKey, amount: number) {
    const sig = await provider.connection.requestAirdrop(pubkey, amount);
    await confirmTransaction(sig);
  }

  async function confirmTransaction(signature: string) {
    const latestBlockhash = await provider.connection.getLatestBlockhash();
    await provider.connection.confirmTransaction({
      signature,
      ...latestBlockhash,
    });
  }

  // 1 SOL
  const transferAmount = 1 * LAMPORTS_PER_SOL;

  const [PDA] = PublicKey.findProgramAddressSync(
    [Buffer.from("pda"), wallet.publicKey.toBuffer()],
    program.programId
  );

  async function getBalances(
    payerPubkey: PublicKey,
    recipientPubkey: PublicKey,
    timeframe: string
  ) {
    const payerBalance = await provider.connection.getBalance(payerPubkey);
    const recipientBalance = await provider.connection.getBalance(
      recipientPubkey
    );
    console.log(`${timeframe} balances:`);
    console.log(`   Payer: ${payerBalance / LAMPORTS_PER_SOL}`);
    console.log(`   Recipient: ${recipientBalance / LAMPORTS_PER_SOL}`);
  }

  it("Is initialized!", async () => {
    // Add your test here.
    const tx = await program.methods.initialize().rpc();
    console.log("Your transaction signature", tx);
  });

  it("SOL Transfer Anchor", async () => {
    const transactionSignature = await program.methods
      .solTransfer(new BN(transferAmount))
      .accounts({
        sender: sender.publicKey,
        recipient: recipient.publicKey,
      })
      .signers([sender])
      .rpc();

    console.log(
      `\nTransaction Signature: https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
    );
    await getBalances(sender.publicKey, recipient.publicKey, "Resulting");
  });

  it("SOL Transfer Anchor wallet", async () => {
    const transactionSignature = await program.methods
      .solTransfer(new BN(transferAmount))
      .accounts({
        sender: wallet.publicKey,
        recipient: recipient.publicKey,
      })
      .rpc();

    console.log(
      `\nTransaction Signature:` +
        `https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
    );
    await getBalances(
      wallet.publicKey,
      recipient.publicKey,
      "Transfer wallet Resulting"
    );
  });

  it("SOL Transfer2 Anchor", async () => {
    const transactionSignature = await program.methods
      .solTransfer2(new BN(transferAmount))
      .accounts({
        sender: sender.publicKey,
        recipient: recipient.publicKey,
      })
      .signers([sender])
      .rpc();

    console.log(
      `\nTransaction Signature: https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
    );
    await getBalances(
      sender.publicKey,
      recipient.publicKey,
      "Transfer2 Resulting"
    );
  });

  it("SOL Transfer3 Anchor", async () => {
    const transactionSignature = await program.methods
      .solTransfer3(new BN(transferAmount))
      .accounts({
        sender: sender.publicKey,
        recipient: recipient.publicKey,
      })
      .signers([sender])
      .rpc();

    console.log(
      `\nTransaction Signature: https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
    );
    await getBalances(
      sender.publicKey,
      recipient.publicKey,
      "Transfer3 Resulting"
    );
  });

  it("Fund PDA with SOL", async () => {
    const transferInstruction = SystemProgram.transfer({
      fromPubkey: wallet.publicKey,
      toPubkey: PDA,
      lamports: transferAmount * 2,
    });

    const transaction = new Transaction().add(transferInstruction);

    const transactionSignature = await sendAndConfirmTransaction(
      connection,
      transaction,
      [wallet.payer] // signer
    );

    console.log(
      `\nFund PDA with SOL Transaction Signature:` +
        `https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
    );

    await getBalances(wallet.publicKey, PDA, "Fund PDA with SOL Resulting");
  });

  it("SOL Transfer with PDA signer", async () => {
    const transactionSignature = await program.methods
      .solTransfer4(new BN(transferAmount))
      .accounts({
        pdaAccount: PDA,
        recipient: wallet.publicKey,
      })
      .rpc();

    console.log(
      `\nSOL Transfer with PDA signer Transaction Signature: https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
    );

    await getBalances(
      wallet.publicKey,
      PDA,
      "SOL Transfer with PDA signer Resulting"
    );
  });

   it("SOL Transfer with PDA invoke_signed", async () => {
     const transactionSignature = await program.methods
       .solTransfer4(new BN(transferAmount))
       .accounts({
         pdaAccount: PDA,
         recipient: wallet.publicKey,
       })
       .rpc();

     console.log(
       `\nSOL Transfer with PDA invoke_signed Transaction Signature: https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
     );

     await getBalances(
       wallet.publicKey,
       PDA,
       "SOL Transfer with PDA invoke_signed Resulting"
     );
   });
});

```

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Anchor æ¡†æ¶ç¼–å†™çš„**æ™ºèƒ½åˆçº¦æµ‹è¯•å¥—ä»¶**ï¼Œç”¨äºéªŒè¯å„ç§ SOL è½¬è´¦åŠŸèƒ½çš„æ­£ç¡®æ€§ã€‚å®ƒé€šè¿‡æ¨¡æ‹ŸåŒºå—é“¾æ“ä½œï¼Œæµ‹è¯•åˆçº¦ä¸­çš„ä¸åŒè½¬è´¦æ–¹æ³•ã€‚

#### æ ¸å¿ƒç»„ä»¶è§£æ

##### 1. æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–

```ts
const provider = anchor.AnchorProvider.env();
anchor.setProvider(provider);
const program = anchor.workspace.cpiDemo as Program<CpiDemo>;
```

- è·å–æœ¬åœ°æµ‹è¯•ç¯å¢ƒæä¾›è€…ï¼ˆProviderï¼‰
- å°†ç¨‹åºå®ä¾‹åŒ–ä¸º `program` å¯¹è±¡ï¼Œç”¨äºè°ƒç”¨åˆçº¦æ–¹æ³•

##### 2. æµ‹è¯•è´¦æˆ·ç®¡ç†

```ts
const sender = anchor.web3.Keypair.generate();
const recipient = anchor.web3.Keypair.generate();
```

- ç”Ÿæˆæµ‹è¯•ç”¨çš„å‘é€æ–¹å’Œæ¥æ”¶æ–¹å¯†é’¥å¯¹
- `beforeEach` åœ¨æ¯ä¸ªæµ‹è¯•å‰ç©ºæŠ• 5 SOL åˆ°å„ä¸ªè´¦æˆ·

##### 3. PDA è´¦æˆ·ç”Ÿæˆ

```ts
const [PDA] = PublicKey.findProgramAddressSync(
  [Buffer.from("pda"), wallet.publicKey.toBuffer()],
  program.programId
);
```

- ä½¿ç”¨ä¸åˆçº¦ç›¸åŒçš„è§„åˆ™ç”Ÿæˆç¨‹åºæ´¾ç”Ÿåœ°å€ (PDA)
- ç§å­è§„åˆ™ï¼š`b"pda" + é’±åŒ…å…¬é’¥`

##### 4. å®ç”¨å·¥å…·å‡½æ•°

```ts
async function airdrop(pubkey, amount) {}       // ç©ºæŠ• SOL
async function confirmTransaction(signature) {} // äº¤æ˜“ç¡®è®¤
async function getBalances(payer, recipient, timeframe) {} // è·å–å¹¶æ‰“å°ä½™é¢
```

#### æµ‹è¯•ç”¨ä¾‹è¯¦è§£

##### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•

```ts
it("Is initialized!", async () => {
  await program.methods.initialize().rpc();
});
```

- æµ‹è¯•åˆçº¦çš„åˆå§‹åŒ–åŠŸèƒ½

##### 2. å¸¸è§„ SOL è½¬è´¦æµ‹è¯•

```ts
it("SOL Transfer Anchor", async () => {
  await program.methods
    .solTransfer(new BN(transferAmount))
    .accounts({ sender, recipient })
    .signers([sender])
    .rpc();
});
```

- æµ‹è¯•åˆçº¦çš„ `solTransfer` æ–¹æ³•ï¼ˆAnchor å°è£…æ–¹å¼ï¼‰
- ä½¿ç”¨ç”Ÿæˆçš„å‘é€æ–¹è´¦æˆ·ç­¾å

##### 3. é’±åŒ…ç›´æ¥è½¬è´¦æµ‹è¯•

```ts
it("SOL Transfer Anchor wallet", async () => {
  await program.methods
    .solTransfer(new BN(transferAmount))
    .accounts({ 
      sender: wallet.publicKey, 
      recipient 
    })
    .rpc();
});
```

- ä½¿ç”¨æµ‹è¯•é’±åŒ…æœ¬èº«ä½œä¸ºå‘é€æ–¹
- æ— éœ€é¢å¤–æŒ‡å®šç­¾åè€…ï¼ˆä½¿ç”¨é»˜è®¤é’±åŒ…ç­¾åï¼‰

##### 4. å…¶ä»–è½¬è´¦æ–¹å¼æµ‹è¯•

```ts
it("SOL Transfer2 Anchor", ...) // æµ‹è¯• solTransfer2ï¼ˆåŸç”ŸæŒ‡ä»¤ï¼‰
it("SOL Transfer3 Anchor", ...) // æµ‹è¯• solTransfer3ï¼ˆæ‰‹åŠ¨æ„å»ºæŒ‡ä»¤ï¼‰
```

- éªŒè¯ä¸åŒå±‚çº§ CPI å®ç°çš„æ­£ç¡®æ€§

#### 5. PDA è´¦æˆ·ç›¸å…³æµ‹è¯•

```ts
it("Fund PDA with SOL", async () => {
  const transferInstruction = SystemProgram.transfer({
    fromPubkey: wallet.publicKey,
    toPubkey: PDA,
    lamports: transferAmount * 2
  });
  // ...
});
```

- å…ˆå‘ PDA è´¦æˆ·å……å€¼ 2 SOL
- ä½¿ç”¨ç³»ç»Ÿç¨‹åºçš„æ ‡å‡†è½¬è´¦

```ts
it("SOL Transfer with PDA signer", async () => {
  await program.methods
    .solTransfer4(new BN(transferAmount))
    .accounts({ pdaAccount: PDA, recipient: wallet.publicKey })
    .rpc();
});
```

- æµ‹è¯•åˆçº¦çš„ PDA è½¬è´¦åŠŸèƒ½ï¼ˆ`solTransfer4/solTransfer5`ï¼‰
- PDA ä½œä¸ºå‘é€æ–¹ï¼Œé’±åŒ…ä½œä¸ºæ¥æ”¶æ–¹

#### æµ‹è¯•å·¥å…·äº®ç‚¹

1. ##### **åŒºå—é“¾äº¤äº’å·¥å…·**

   ```ts
   // ç©ºæŠ•å®ç°ï¼ˆè¯·æ±‚æµ‹è¯•ç½‘ SOLï¼‰
   await connection.requestAirdrop(pubkey, amount)
   ```

2. **ä½™é¢ç›‘æ§**ï¼š

   ```ts
   // è·å–å¹¶æ ¼å¼åŒ–ä½™é¢
   const balance = await connection.getBalance(pubkey)
   console.log(`${balance / LAMPORTS_PER_SOL} SOL`)
   ```

3. **äº¤æ˜“è°ƒè¯•**ï¼š

   ```ts
   // ç”Ÿæˆæµè§ˆå™¨å¯æŸ¥çœ‹çš„äº¤æ˜“é“¾æ¥
   `https://solana.fm/tx/${transactionSignature}?cluster=devnet-solana`
   ```

### å…³é”®æµ‹è¯•æµç¨‹

```mermaid
flowchart TD
    A[ç¯å¢ƒå‡†å¤‡] --> B[èµ„é‡‘åˆ†é…]
    B --> C[æ‰§è¡Œæµ‹è¯•]
    C --> D[ç»“æœéªŒè¯]
```

![image-20250607103428645](/images/image-20250607103428645.png)

#### æµ‹è¯•æµç¨‹è¯¦è§£

```mermaid
sequenceDiagram
    participant T as æµ‹è¯•å¥—ä»¶
    participant B as beforeEach
    participant T1 as Test 1
    participant T2 as Test 2
    participant T3 as Test 3
    participant T4 as Test 4
    
    T->>B: å¼€å§‹æ‰§è¡Œæµ‹è¯•å¥—ä»¶
    loop æ¯æ¬¡æµ‹è¯•å‰
        B->>B: ç»™æ‰€æœ‰è´¦æˆ·ç©ºæŠ•5 SOL
    end
    
    T->>T1: æ‰§è¡Œæ™®é€šç”¨æˆ·è½¬è´¦æµ‹è¯•
    T->>T2: æ‰§è¡Œé’±åŒ…ç›´æ¥è½¬è´¦æµ‹è¯•
    T->>T3: æ‰§è¡ŒPDAå……å€¼æµ‹è¯•
    T->>T4: æ‰§è¡ŒPDAè½¬è´¦æµ‹è¯•
```

![image-20250607103441472](/images/image-20250607103441472.png)

### æ€»ç»“

è¯¥æµ‹è¯•å¥—ä»¶å®Œæ•´è¦†ç›–äº†æ™ºèƒ½åˆçº¦çš„æ‰€æœ‰è½¬è´¦åŠŸèƒ½ï¼š

1. éªŒè¯äº† 5 ç§è½¬è´¦æ–¹æ³•çš„æ­£ç¡®æ€§
2. æµ‹è¯•äº†æ™®é€šè´¦æˆ·å’Œ PDA è´¦æˆ·ä¸¤ç§åœºæ™¯
3. é€šè¿‡ä½™é¢å˜åŒ–ç¡®è®¤å®é™…æ“ä½œç»“æœ
4. æä¾›åŒºå—é“¾æµè§ˆå™¨é“¾æ¥ä¾¿äºè°ƒè¯•

é€šè¿‡è¿è¡Œè¿™äº›æµ‹è¯•ï¼Œå¼€å‘è€…å¯ä»¥ï¼š

- ç¡®è®¤åˆçº¦åœ¨å„ç§åœºæ™¯ä¸‹çš„è¡Œä¸ºç¬¦åˆé¢„æœŸ
- éªŒè¯ PDA è´¦æˆ·çš„æ­£ç¡®ä½¿ç”¨
- ç¡®ä¿ä¸åŒå±‚çº§çš„ CPI è°ƒç”¨éƒ½èƒ½æˆåŠŸæ‰§è¡Œ
- æ£€æŸ¥ SOL ä½™é¢å˜åŒ–çš„å‡†ç¡®æ€§

### è¿è¡Œæµ‹è¯•

```bash
cpi-demo on î‚  main [?] via â¬¢ v23.11.0 via ğŸ¦€ 1.87.0 took 8.1s 
âœ anchor test  
    Finished `release` profile [optimized] target(s) in 0.30s
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.31s
     Running unittests src/lib.rs (/Users/qiaopengjun/Code/Solana/solana-sandbox/cpi-demo/target/debug/deps/cpi_demo-a7bb659c1f2ea15a)

Found a 'test' script in the Anchor.toml. Running it as a test suite!

Running test suite: "/Users/qiaopengjun/Code/Solana/solana-sandbox/cpi-demo/Anchor.toml"

yarn run v1.22.22
$ /Users/qiaopengjun/Code/Solana/solana-sandbox/cpi-demo/node_modules/.bin/ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/*.ts'
(node:51302) ExperimentalWarning: Type Stripping is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:51302) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///Users/qiaopengjun/Code/Solana/solana-sandbox/cpi-demo/tests/cpi-demo.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /Users/qiaopengjun/Code/Solana/solana-sandbox/cpi-demo/package.json.


  cpi-demo
wallet sender Resulting balances:
   Payer: 500000000
   Recipient: 0
Your transaction signature jo1Fn5fFW3dRDhdWyfDN7rLFH5MvkNpxNnNJcsXdZmFVJujcW9gLyn8Y88yotgDM3dNJpvBQ2UUBugiu1GPMvWZ
    âœ” Is initialized! (466ms)
wallet sender Resulting balances:
   Payer: 500000004.999995
   Recipient: 5

Transaction Signature: https://solana.fm/tx/zg29tZsPSbXgZMHjMaaHytpMba8ArmzBqz2a78MSYYHWgd9Gd2sycLo2S6FMMe7u4QHU3NFqmjEAR339WvGXkE6?cluster=devnet-solana
Resulting balances:
   Payer: 4
   Recipient: 6
    âœ” SOL Transfer Anchor (463ms)
wallet sender Resulting balances:
   Payer: 500000004.99998504
   Recipient: 4

Transaction Signature:https://solana.fm/tx/2hKjrwZ7UPZbZynddX4u2zfAPFj2CjJey4dv3fjTQ5GVnaWypVQYri48gNN351WGXpn9SuQ7VJvuU9G9agZzmMee?cluster=devnet-solana
Transfer wallet Resulting balances:
   Payer: 500000003.99998003
   Recipient: 7
    âœ” SOL Transfer Anchor wallet (459ms)
wallet sender Resulting balances:
   Payer: 500000003.99998003
   Recipient: 4

Transaction Signature: https://solana.fm/tx/4N55eJwnhAujpGqeSUoui4hveKogwZd8xW9C9svCnpvxDB69zGJLZQJ2N8hxhjuP7dYxXqkCv8QFFw4npv5ASa8U?cluster=devnet-solana
Transfer2 Resulting balances:
   Payer: 3
   Recipient: 8
    âœ” SOL Transfer2 Anchor (472ms)
wallet sender Resulting balances:
   Payer: 500000003.99996996
   Recipient: 3

Transaction Signature: https://solana.fm/tx/5grtbgaydWbzT6DvqAKAh91i3otVVpicwx5G8vu36cctkEGpoAnYYASLLppJkuD8amDEQgSq6XzcEbwutbob6xWF?cluster=devnet-solana
Transfer3 Resulting balances:
   Payer: 2
   Recipient: 9
    âœ” SOL Transfer3 Anchor (467ms)
wallet sender Resulting balances:
   Payer: 500000003.99996
   Recipient: 2

Fund PDA with SOL Transaction Signature:https://solana.fm/tx/2es1hU6HgoG816hkZpkFewjr54Yhied4yfp4GwwXapUKNY3wwCt9ysXoXNY9vUFHqWbDCAnXwzfXmQfjHZM1KoAu?cluster=devnet-solana
Fund PDA with SOL Resulting balances:
   Payer: 500000001.99996
   Recipient: 2
    âœ” Fund PDA with SOL (447ms)
wallet sender Resulting balances:
   Payer: 500000001.99996
   Recipient: 2

SOL Transfer with PDA signer Transaction Signature: https://solana.fm/tx/5iYUatgnZYTnmVyKJKAmNPx8ueBiHjP9jjzkSvxaLct7tKD6MDnz5Kz19no2od7bnjrbLLb8UT4gJCVDUrYZJRpv?cluster=devnet-solana
SOL Transfer with PDA signer Resulting balances:
   Payer: 500000002.999955
   Recipient: 1
    âœ” SOL Transfer with PDA signer (471ms)
wallet sender Resulting balances:
   Payer: 500000002.999955
   Recipient: 2

SOL Transfer with PDA invoke_signed Transaction Signature: https://solana.fm/tx/24JDZmYmsaCU3sCZJQ56ftHFQHHovncnuoo83YsPD7xTwvmxwqQJyt7vefk7L9Z1mkBNVhU1C53e1mLXhq1GK4Dj?cluster=devnet-solana
SOL Transfer with PDA invoke_signed Resulting balances:
   Payer: 500000003.99995
   Recipient: 0
    âœ” SOL Transfer with PDA invoke_signed (491ms)


  8 passing (5s)

âœ¨  Done in 6.58s.

```

æµ‹è¯•ç»“æœå±•ç¤ºäº†åˆçº¦çš„å…¨éƒ¨8ä¸ªè½¬è´¦åŠŸèƒ½æµ‹è¯•å‡æˆåŠŸé€šè¿‡ï¼Œæ•´ä¸ªè¿‡ç¨‹è€—æ—¶çº¦6.58ç§’ï¼šæ¯ä¸ªæµ‹è¯•æ‰§è¡Œå‰éƒ½é€šè¿‡ç©ºæŠ•ç¡®ä¿äº†å‘é€æ–¹å’Œæ¥æ”¶æ–¹è´¦æˆ·å„æœ‰5 SOLåˆå§‹ä½™é¢ï¼ŒæˆåŠŸéªŒè¯äº†æ™®é€šç”¨æˆ·è½¬è´¦ã€é’±åŒ…ç›´æ¥è½¬è´¦ï¼ˆåŒ…å«å¾®å°æ‰‹ç»­è´¹çº¦0.00000002 SOLï¼‰ã€åŸç”ŸæŒ‡ä»¤è½¬è´¦å’Œæ‰‹åŠ¨æ„å»ºæŒ‡ä»¤è½¬è´¦ç­‰ä¸åŒå®ç°æ–¹å¼ï¼›ç‰¹åˆ«æ˜¯å¯¹PDAç¨‹åºæ´¾ç”Ÿè´¦æˆ·çš„æµ‹è¯•ä¸­ï¼Œå…ˆå®Œæˆ2 SOLå……å€¼æ“ä½œåï¼Œå†æˆåŠŸæ‰§è¡Œäº†ä»PDAåˆ°é’±åŒ…çš„ä¸¤æ¬¡1 SOLè½¬è´¦ï¼ˆä½¿ç”¨solTransfer4å’ŒsolTransfer5ä¸¤ç§æ–¹æ³•ï¼‰ï¼Œæœ€ç»ˆé€šè¿‡ç²¾ç¡®çš„ä½™é¢å˜åŒ–ï¼ˆå¦‚æ¥æ”¶æ–¹ä»åˆå§‹5 SOLå¢è‡³9 SOLï¼‰å’ŒåŒºå—é“¾æµè§ˆå™¨å¯æŸ¥çš„äº¤æ˜“ç­¾åï¼Œè¯æ˜æ‰€æœ‰SOLè½¬è´¦åŠŸèƒ½åŒ…æ‹¬PDAè´¦æˆ·æ“ä½œå‡ç¬¦åˆé¢„æœŸè¡Œä¸ºè§„èŒƒã€‚

## æ€»ç»“

Solanaçš„è·¨ç¨‹åºè°ƒç”¨ï¼ˆCPIï¼‰æœºåˆ¶å¦‚Web3ä¸–ç•Œçš„â€œå¤–å–å¹³å°â€ï¼Œè®©æ™ºèƒ½åˆçº¦æ— ç¼è°ƒç”¨å…¶ä»–ç¨‹åºï¼Œä»ç®€å•è½¬è´¦åˆ°å¤æ‚çš„DeFiæ“ä½œéƒ½èƒ½ä¸€æ°”å‘µæˆã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®æˆ˜é¡¹ç›®ï¼Œå±•ç¤ºäº†Anchoræ¡†æ¶çš„å¤šå±‚å®ç°ï¼šä»é«˜é˜¶CpiContextåˆ°åŸç”Ÿinvokeï¼Œå†åˆ°å­—èŠ‚çº§æŒ‡ä»¤æ„å»ºï¼Œå¼€å‘è€…å¯æ ¹æ®éœ€æ±‚çµæ´»é€‰æ‹©å¼€å‘è·¯å¾„ã€‚PDAè´¦æˆ·çš„å¼•å…¥è¿›ä¸€æ­¥å½°æ˜¾Solanaåœ¨æ— ç§é’¥åœºæ™¯çš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼Œæµ‹è¯•ç»“æœéªŒè¯äº†æ‰€æœ‰åŠŸèƒ½çš„ç¨³å®šæ€§ã€‚æƒ³åœ¨Web3æµªæ½®ä¸­è„±é¢–è€Œå‡ºï¼Ÿä»æŒæ¡Solana CPIå¼€å§‹ï¼Œå¼€å¯ä½ çš„åŒºå—é“¾å¼€å‘ä¹‹æ—…ï¼

**æƒ³æ·±å…¥æ¢ç´¢Solanaå¼€å‘ï¼Ÿæ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œå…³æ³¨æˆ‘ä»¬è·å–æ›´å¤šWeb3å®æˆ˜æ•™ç¨‹ï¼**

**åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„Solanaå¼€å‘ç»éªŒï¼Œæˆ–ç•™è¨€ä½ çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èµ·æ¢è®¨ï¼**

## å‚è€ƒ

- <https://www.anchor-lang.com/docs/basics/cpi>
- <https://github.com/solana-developers/program-examples/blob/main/basics/transfer-sol/anchor/tests/test.ts>
- <https://solana.com/zh/docs>
- <https://whimsical.com/solana-installation-LYwNkrpP7HMfwR9FpTcR1H>
